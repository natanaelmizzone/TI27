"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="204856f0-462d-533c-9d0a-1a060e619c5d")}catch(e){}}();
(globalThis.webpackChunk_figma_web_bundler=globalThis.webpackChunk_figma_web_bundler||[]).push([[4657],{194682:(e,t,a)=>{a.d(t,{x:()=>o});var r=a(7378),i=a(408965),s=a(778607),n=a(644572);function o({children:e,isValidProp:t,...a}){t&&(0,s.D)(t),(a={...(0,r.useContext)(i.Q),...a}).isStatic=(0,n.M)(()=>a.isStatic);let o=(0,r.useMemo)(()=>a,[JSON.stringify(a.transition),a.transformPagePoint,a.reducedMotion]);return r.createElement(i.Q.Provider,{value:o},e)}},411501:(e,t,a)=>{a.d(t,{EZ:()=>l,PC:()=>i,Xg:()=>u,Yq:()=>r,_m:()=>n,as:()=>s,c9:()=>c,hY:()=>o,rD:()=>d});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=4,i={1:[-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],2:[-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],3:[-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1]},s={1:[-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],2:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],3:[-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1]},n={0:[11025,12e3,8e3,-1],2:[22050,24e3,16e3,-1],3:[44100,48e3,32e3,-1]},o=0x58696e67,d=0x496e666f,c=(e,t,a,r)=>3===e?Math.floor((12*t/a+r)*4):Math.floor(144*t/a+r),l=(e,t)=>3===e?3===t?21:36:3===t?13:21,u=(e,t)=>{let a;let r=t.pos,o=e>>>24,d=e>>>16&255,l=e>>>8&255,u=255&e;if(255!==o&&255!==d&&255!==l&&255!==u)return t.pos+=4,null;if(t.pos+=1,255!==o||(224&d)!=224)return null;let h=d>>3&3,m=d>>1&3,f=l>>4&15,p=l>>2&3,g=3===h?i[m]?.[f]:s[m]?.[f];if(!g||-1===g)return null;let k=1e3*g,b=n[h]?.[p];if(!b||-1===b)return null;let w=c(m,k,b,l>>1&1);return null!==t.fileSize&&t.fileSize-r<w?null:(a=3===h?3===m?384:1152:3===m?384:2===m?1152:576,{startPos:r,totalSize:w,mpegVersionId:h,layer:m,bitrate:k,frequencyIndex:p,sampleRate:b,channel:u>>6&3,modeExtension:u>>4&3,copyright:u>>3&1,original:u>>2&1,emphasis:3&u,audioSamplesInFrame:a})}},507174:(e,t,a)=>{a.d(t,{Co:()=>E,D5:()=>m,KU:()=>u,PR:()=>A,Qf:()=>x,UU:()=>v,Us:()=>y,bs:()=>S,fH:()=>l,ls:()=>P,no:()=>d});var r=a(308573),i=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let s=e=>{let t=[],a=0;for(;a<e.length;){let r=-1,i=0;for(let t=a;t<e.length-3;t++){if(0===e[t]&&0===e[t+1]&&1===e[t+2]){r=t,i=3;break}if(t<e.length-4&&0===e[t]&&0===e[t+1]&&0===e[t+2]&&1===e[t+3]){r=t,i=4;break}}if(-1===r)break;if(a>0&&r>a){let i=e.subarray(a,r);i.length>0&&t.push(i)}a=r+i}if(a<e.length){let r=e.subarray(a);r.length>0&&t.push(r)}return t},n=(e,t)=>{let a=[],r=0,s=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;r+t<=e.length;){let n;1===t?n=s.getUint8(r):2===t?n=s.getUint16(r,!1):3===t?n=(s.getUint16(r,!1)<<8)+s.getUint8(r+2):4===t?n=s.getUint32(r,!1):((0,i.xb)(t),(0,i.vA)(!1)),r+=t;let o=e.subarray(r,r+n);a.push(o),r+=n}return a},o=e=>{let t=[],a=e.length;for(let r=0;r<a;r++)r+2<a&&0===e[r]&&0===e[r+1]&&3===e[r+2]?(t.push(0,0),r+=2):t.push(e[r]);return new Uint8Array(t)},d=e=>{let t=s(e);if(0===t.length)return null;let a=0;for(let e of t)a+=4+e.byteLength;let r=new Uint8Array(a),i=new DataView(r.buffer),n=0;for(let e of t){let t=e.byteLength;i.setUint32(n,t,!1),n+=4,r.set(e,n),n+=e.byteLength}return r},c=e=>31&e[0],l=e=>{try{let t=s(e),a=t.filter(e=>7===c(e)),r=t.filter(e=>8===c(e)),n=t.filter(e=>13===c(e));if(0===a.length||0===r.length)return null;let d=a[0],l=new i._c(o(d));l.skipBits(1),l.skipBits(2);let u=l.readBits(5);if(7!==u)return console.error("Invalid SPS NAL unit type"),null;let h=l.readAlignedByte(),m=l.readAlignedByte(),f=l.readAlignedByte(),p={configurationVersion:1,avcProfileIndication:h,profileCompatibility:m,avcLevelIndication:f,lengthSizeMinusOne:3,sequenceParameterSets:a,pictureParameterSets:r,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(100===h||110===h||122===h||144===h){(0,i.IP)(l);let e=(0,i.IP)(l);3===e&&l.skipBits(1);let t=(0,i.IP)(l),a=(0,i.IP)(l);p.chromaFormat=e,p.bitDepthLumaMinus8=t,p.bitDepthChromaMinus8=a,p.sequenceParameterSetExt=n}return p}catch(e){return console.error("Error building AVC Decoder Configuration Record:",e),null}},u=e=>{let t=[];for(let a of(t.push(e.configurationVersion),t.push(e.avcProfileIndication),t.push(e.profileCompatibility),t.push(e.avcLevelIndication),t.push(252|3&e.lengthSizeMinusOne),t.push(224|31&e.sequenceParameterSets.length),e.sequenceParameterSets)){let e=a.byteLength;t.push(e>>8),t.push(255&e);for(let r=0;r<e;r++)t.push(a[r])}for(let a of(t.push(e.pictureParameterSets.length),e.pictureParameterSets)){let e=a.byteLength;t.push(e>>8),t.push(255&e);for(let r=0;r<e;r++)t.push(a[r])}if(100===e.avcProfileIndication||110===e.avcProfileIndication||122===e.avcProfileIndication||144===e.avcProfileIndication)for(let a of((0,i.vA)(null!==e.chromaFormat),(0,i.vA)(null!==e.bitDepthLumaMinus8),(0,i.vA)(null!==e.bitDepthChromaMinus8),(0,i.vA)(null!==e.sequenceParameterSetExt),t.push(252|3&e.chromaFormat),t.push(248|7&e.bitDepthLumaMinus8),t.push(248|7&e.bitDepthChromaMinus8),t.push(e.sequenceParameterSetExt.length),e.sequenceParameterSetExt)){let e=a.byteLength;t.push(e>>8),t.push(255&e);for(let r=0;r<e;r++)t.push(a[r])}return new Uint8Array(t)},h=e=>e[0]>>1&63,m=e=>{try{let t=s(e),a=t.filter(e=>32===h(e)),r=t.filter(e=>33===h(e)),n=t.filter(e=>34===h(e)),d=t.filter(e=>39===h(e)||40===h(e));if(0===r.length||0===n.length)return null;let c=r[0],l=new i._c(o(c));l.skipBits(16),l.readBits(4);let u=l.readBits(3),m=l.readBits(1),{general_profile_space:k,general_tier_flag:w,general_profile_idc:T,general_profile_compatibility_flags:y,general_constraint_indicator_flags:S,general_level_idc:C}=f(l,u);(0,i.IP)(l);let v=(0,i.IP)(l);3===v&&l.skipBits(1),(0,i.IP)(l),(0,i.IP)(l),l.readBits(1)&&((0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l));let x=(0,i.IP)(l),I=(0,i.IP)(l);(0,i.IP)(l);let P=l.readBits(1)?0:u;for(let e=P;e<=u;e++)(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l);(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l),(0,i.IP)(l),l.readBits(1)&&l.readBits(1)&&p(l),l.skipBits(1),l.skipBits(1),l.readBits(1)&&(l.skipBits(4),l.skipBits(4),(0,i.IP)(l),(0,i.IP)(l),l.skipBits(1));let E=(0,i.IP)(l);if(g(l,E),l.readBits(1)){let e=(0,i.IP)(l);for(let t=0;t<e;t++)(0,i.IP)(l),l.skipBits(1)}l.skipBits(1),l.skipBits(1);let A=0;l.readBits(1)&&(A=b(l,u));let R=0;if(n.length>0){let e=n[0],t=new i._c(o(e));t.skipBits(16),(0,i.IP)(t),(0,i.IP)(t),t.skipBits(1),t.skipBits(1),t.skipBits(3),t.skipBits(1),t.skipBits(1),(0,i.IP)(t),(0,i.IP)(t),(0,i.OO)(t),t.skipBits(1),t.skipBits(1),t.readBits(1)&&(0,i.IP)(t),(0,i.OO)(t),(0,i.OO)(t),t.skipBits(1),t.skipBits(1),t.skipBits(1),t.skipBits(1);let a=t.readBits(1),r=t.readBits(1);R=a||r?a&&!r?2:!a&&r?3:0:0}let B=[...a.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:a}]:[],...r.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:r}]:[],...n.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:n}]:[],...d.length?[{arrayCompleteness:1,nalUnitType:h(d[0]),nalUnits:d}]:[]];return{configurationVersion:1,generalProfileSpace:k,generalTierFlag:w,generalProfileIdc:T,generalProfileCompatibilityFlags:y,generalConstraintIndicatorFlags:S,generalLevelIdc:C,minSpatialSegmentationIdc:A,parallelismType:R,chromaFormatIdc:v,bitDepthLumaMinus8:x,bitDepthChromaMinus8:I,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:u+1,temporalIdNested:m,lengthSizeMinusOne:3,arrays:B}}catch(e){return console.error("Error building HEVC Decoder Configuration Record:",e),null}},f=(e,t)=>{let a=e.readBits(2),r=e.readBits(1),i=e.readBits(5),s=0;for(let t=0;t<32;t++)s=s<<1|e.readBits(1);let n=new Uint8Array(6);for(let t=0;t<6;t++)n[t]=e.readBits(8);let o=e.readBits(8),d=[],c=[];for(let a=0;a<t;a++)d.push(e.readBits(1)),c.push(e.readBits(1));if(t>0)for(let a=t;a<8;a++)e.skipBits(2);for(let a=0;a<t;a++)d[a]&&e.skipBits(88),c[a]&&e.skipBits(8);return{general_profile_space:a,general_tier_flag:r,general_profile_idc:i,general_profile_compatibility_flags:s,general_constraint_indicator_flags:n,general_level_idc:o}},p=e=>{for(let t=0;t<4;t++)for(let a=0;a<(3===t?2:6);a++)if(e.readBits(1)){let a=Math.min(64,1<<4+(t<<1));t>1&&(0,i.OO)(e);for(let t=0;t<a;t++)(0,i.OO)(e)}else(0,i.IP)(e)},g=(e,t)=>{let a=[];for(let r=0;r<t;r++)a[r]=k(e,r,t,a)},k=(e,t,a,r)=>{let s=0,n=0,o=0;if(0!==t&&(n=e.readBits(1)),n){o=t===a?t-((0,i.IP)(e)+1):t-1,e.readBits(1),(0,i.IP)(e);let n=r[o]??0;for(let t=0;t<=n;t++)e.readBits(1)||e.readBits(1);s=r[o]}else{let t=(0,i.IP)(e),a=(0,i.IP)(e);for(let a=0;a<t;a++)(0,i.IP)(e),e.readBits(1);for(let t=0;t<a;t++)(0,i.IP)(e),e.readBits(1);s=t+a}return s},b=(e,t)=>{if(e.readBits(1)&&255===e.readBits(8)&&(e.readBits(16),e.readBits(16)),e.readBits(1)&&e.readBits(1),e.readBits(1)&&(e.readBits(3),e.readBits(1),e.readBits(1)&&(e.readBits(8),e.readBits(8),e.readBits(8))),e.readBits(1)&&((0,i.IP)(e),(0,i.IP)(e)),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1)&&((0,i.IP)(e),(0,i.IP)(e),(0,i.IP)(e),(0,i.IP)(e)),e.readBits(1)&&(e.readBits(32),e.readBits(32),e.readBits(1)&&(0,i.IP)(e),e.readBits(1)&&w(e,!0,t)),e.readBits(1)){e.readBits(1),e.readBits(1),e.readBits(1);let t=(0,i.IP)(e);return(0,i.IP)(e),(0,i.IP)(e),(0,i.IP)(e),(0,i.IP)(e),t}return 0},w=(e,t,a)=>{let r=!1,s=!1,n=!1;t&&(r=1===e.readBits(1),s=1===e.readBits(1),(r||s)&&((n=1===e.readBits(1))&&(e.readBits(8),e.readBits(5),e.readBits(1),e.readBits(5)),e.readBits(4),e.readBits(4),n&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5)));for(let t=0;t<=a;t++){let t=1===e.readBits(1),a=!0;t||(a=1===e.readBits(1));let o=!1;a?(0,i.IP)(e):o=1===e.readBits(1);let d=1;o||(d=(0,i.IP)(e)+1),r&&T(e,d,n),s&&T(e,d,n)}},T=(e,t,a)=>{for(let r=0;r<t;r++)(0,i.IP)(e),(0,i.IP)(e),a&&((0,i.IP)(e),(0,i.IP)(e)),e.readBits(1)},y=e=>{let t=[];for(let a of(t.push(e.configurationVersion),t.push((3&e.generalProfileSpace)<<6|(1&e.generalTierFlag)<<5|31&e.generalProfileIdc),t.push(e.generalProfileCompatibilityFlags>>>24&255),t.push(e.generalProfileCompatibilityFlags>>>16&255),t.push(e.generalProfileCompatibilityFlags>>>8&255),t.push(255&e.generalProfileCompatibilityFlags),t.push(...e.generalConstraintIndicatorFlags),t.push(255&e.generalLevelIdc),t.push(240|e.minSpatialSegmentationIdc>>8&15),t.push(255&e.minSpatialSegmentationIdc),t.push(252|3&e.parallelismType),t.push(252|3&e.chromaFormatIdc),t.push(248|7&e.bitDepthLumaMinus8),t.push(248|7&e.bitDepthChromaMinus8),t.push(e.avgFrameRate>>8&255),t.push(255&e.avgFrameRate),t.push((3&e.constantFrameRate)<<6|(7&e.numTemporalLayers)<<3|(1&e.temporalIdNested)<<2|3&e.lengthSizeMinusOne),t.push(255&e.arrays.length),e.arrays))for(let e of(t.push((1&a.arrayCompleteness)<<7|0|63&a.nalUnitType),t.push(a.nalUnits.length>>8&255),t.push(255&a.nalUnits.length),a.nalUnits)){t.push(e.length>>8&255),t.push(255&e.length);for(let a=0;a<e.length;a++)t.push(e[a])}return new Uint8Array(t)},S=e=>{let t=new i._c(e);if(2!==t.readBits(2))return null;let a=t.readBits(1),s=(t.readBits(1)<<1)+a;if(3===s&&t.skipBits(1),1===t.readBits(1)||0!==t.readBits(1)||(t.skipBits(2),4817730!==t.readBits(24)))return null;let n=8;s>=2&&(n=t.readBits(1)?12:10);let o=t.readBits(3),d=0,c=0;if(7!==o){if(c=t.readBits(1),1===s||3===s){let e=t.readBits(1),a=t.readBits(1);d=e||a?e&&!a?2:1:3,t.skipBits(1)}else d=1}else d=3,c=1;let l=(t.readBits(16)+1)*(t.readBits(16)+1),u=(0,i._g)(r.ye).level;for(let e of r.ye)if(l<=e.maxPictureSize){u=e.level;break}return{profile:s,level:u,bitDepth:n,chromaSubsampling:d,videoFullRangeFlag:c,colourPrimaries:2===o?1:1===o?6:2,transferCharacteristics:2===o?1:1===o?6:2,matrixCoefficients:7===o?0:2===o?1:1===o?6:2}};function*C(e){let t=new i._c(e),a=()=>{let e=0;for(let a=0;a<8;a++){let r=t.readAlignedByte();if(e|=(127&r)<<7*a,!(128&r))break;if(7===a&&128&r)return null}return e>=0x100000000-1?null:e};for(;t.getBitsLeft()>=8;){let r;t.skipBits(1);let s=t.readBits(4),n=t.readBits(1),o=t.readBits(1);if(t.skipBits(1),n&&t.skipBits(8),o){let e=a();if(null===e)return;r=e}else r=Math.floor(t.getBitsLeft()/8);(0,i.vA)(t.pos%8==0),yield{type:s,data:e.subarray(t.pos/8,t.pos/8+r)},t.skipBits(8*r)}}let v=e=>{for(let{type:t,data:a}of C(e)){if(1!==t)continue;let e=new i._c(a),r=e.readBits(3);e.readBits(1);let s=e.readBits(1),n=0,o=0,d=0;if(s)n=e.readBits(5);else{if(e.readBits(1)&&(e.skipBits(32),e.skipBits(32),e.readBits(1)))return null;let t=e.readBits(1);t&&(d=e.readBits(5),e.skipBits(32),e.skipBits(5),e.skipBits(5));let a=e.readBits(5);for(let r=0;r<=a;r++){e.skipBits(12);let a=e.readBits(5);if(0===r&&(n=a),a>7){let t=e.readBits(1);0===r&&(o=t)}if(t&&e.readBits(1)){let t=d+1;e.skipBits(t),e.skipBits(t),e.skipBits(1)}e.readBits(1)&&e.skipBits(4)}}let c=e.readBits(1),l=8;2===r&&c?l=e.readBits(1)?12:10:r<=2&&(l=c?10:8);let u=0;1!==r&&(u=e.readBits(1));let h=1,m=1,f=0;return!u&&(0===r?(h=1,m=1):1===r?(h=0,m=0):12===l&&(h=e.readBits(1))&&(m=e.readBits(1)),h&&m&&(f=e.readBits(2))),{profile:r,level:n,tier:o,bitDepth:l,monochrome:u,chromaSubsamplingX:h,chromaSubsamplingY:m,chromaSamplePosition:f}}return null},x=e=>{let t=(0,i.Zc)(e),a=t.getUint8(9),r=t.getUint16(10,!0),s=t.getUint32(12,!0),n=t.getInt16(16,!0),o=t.getUint8(18),d=null;return o&&(d=e.subarray(19,21+a)),{outputChannelCount:a,preSkip:r,inputSampleRate:s,outputGain:n,channelMappingFamily:o,channelMappingTable:d}},I=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],P=e=>({durationInSamples:I[e[0]>>3]}),E=e=>{if(e.length<7)throw Error("Setup header is too short.");if(5!==e[0])throw Error("Wrong packet type in Setup header.");if("vorbis"!==String.fromCharCode(...e.slice(1,7)))throw Error("Invalid packet signature in Setup header.");let t=e.length,a=new Uint8Array(t);for(let r=0;r<t;r++)a[r]=e[t-1-r];let r=new i._c(a),s=0;for(;r.getBitsLeft()>97;)if(1===r.readBits(1)){s=r.pos;break}if(0===s)throw Error("Invalid Setup header: framing bit not found.");let n=0,o=!1,d=0;for(;r.getBitsLeft()>=97;){let e=r.pos,t=r.readBits(8),a=r.readBits(16),i=r.readBits(16);if(t>63||0!==a||0!==i){r.pos=e;break}if(r.skipBits(1),++n>64)break;r.clone().readBits(6)+1===n&&(o=!0,d=n)}if(!o)throw Error("Invalid Setup header: mode header not found.");if(d>63)throw Error(`Unsupported mode count: ${d}.`);let c=d;r.pos=0,r.skipBits(s);let l=Array(c).fill(0);for(let e=c-1;e>=0;e--)r.skipBits(40),l[e]=r.readBits(1);return{modeBlockflags:l}},A=async(e,t)=>{switch((0,i.vA)(e.codec),e.codec){case"avc":{let a;let r=await e.getDecoderConfig();if((0,i.vA)(r),r.description){let e=3&(0,i.Fo)(r.description)[4];a=n(t.data,e+1)}else a=s(t.data);return a.some(e=>5===c(e))?"key":"delta"}case"hevc":{let a;let r=await e.getDecoderConfig();if((0,i.vA)(r),r.description){let e=3&(0,i.Fo)(r.description)[21];a=n(t.data,e+1)}else a=s(t.data);return a.some(e=>{let t=h(e);return 16<=t&&t<=23})?"key":"delta"}case"vp8":return 0==(1&t.data[0])?"key":"delta";case"vp9":{let e=new i._c(t.data);if(2!==e.readBits(2))return null;let a=e.readBits(1);if(3===(e.readBits(1)<<1)+a&&e.skipBits(1),e.readBits(1))return null;return 0===e.readBits(1)?"key":"delta"}case"av1":{let e=!1;for(let{type:a,data:r}of C(t.data))if(1===a){let t=new i._c(r);t.skipBits(4),e=!!t.readBits(1)}else if(3===a||6===a||7===a){if(e)return"key";let t=new i._c(r);if(t.readBits(1))return null;return 0===t.readBits(2)?"key":"delta"}return null}default:(0,i.xb)(e.codec),(0,i.vA)(!1)}}},308573:(e,t,a)=>{a.d(t,{DC:()=>k,Ei:()=>v,GL:()=>O,IJ:()=>P,KZ:()=>w,P7:()=>z,PP:()=>o,QP:()=>b,Rc:()=>I,VW:()=>d,WN:()=>i,Wq:()=>s,X0:()=>T,YB:()=>n,aF:()=>M,cj:()=>S,en:()=>E,j7:()=>p,m0:()=>A,mD:()=>g,oU:()=>x,ye:()=>u,zF:()=>y});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let i=["avc","hevc","vp9","av1","vp8"],s=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],n=["aac","opus","mp3","vorbis","flac"],o=[...n,...s],d=["webvtt"],c=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],l=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:0x2200000,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:0x2200000,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:0x2200000,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:0x2200000,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:0x2200000,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:0x2200000,maxBitrate:8e8,tier:"H",level:186}],u=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:0x2200000,maxBitrate:18e7,level:60},{maxPictureSize:0x2200000,maxBitrate:24e7,level:61},{maxPictureSize:0x2200000,maxBitrate:48e7,level:62}],h=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:0x2200000,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:0x2200000,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:0x2200000,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:0x2200000,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:0x2200000,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:0x2200000,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:0x2200000,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:0x2200000,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:0x2200000,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:0x2200000,maxBitrate:8e8,tier:"H",level:19}],m=".01.01.01.01.00",f=".0.110.01.01.01.0",p=(e,t,a,i)=>{if("avc"===e){let e=Math.ceil(t/16)*Math.ceil(a/16),s=c.find(t=>e<=t.maxMacroblocks&&i<=t.maxBitrate)??(0,r._g)(c),n=s?s.level:0,o="64".padStart(2,"0"),d=n.toString(16).padStart(2,"0");return`avc1.${o}00${d}`}if("hevc"===e){let e=t*a,s=l.find(t=>e<=t.maxPictureSize&&i<=t.maxBitrate)??(0,r._g)(l);return`hev1.1.6.${s.tier}${s.level}.B0`}if("vp8"===e)return"vp8";if("vp9"===e){let e=t*a,s=u.find(t=>e<=t.maxPictureSize&&i<=t.maxBitrate)??(0,r._g)(u);return`vp09.00.${s.level.toString().padStart(2,"0")}.08`}if("av1"===e){let e=t*a,s=h.find(t=>e<=t.maxPictureSize&&i<=t.maxBitrate)??(0,r._g)(h),n=s.level.toString().padStart(2,"0");return`av01.0.${n}${s.tier}.08`}throw TypeError(`Unhandled codec '${e}'.`)},g=e=>{let t=e.split("."),a=Number(t[1]);return[1,1,a,2,1,Number(t[2]),3,1,Number(t[3]),4,1,t[4]?Number(t[4]):1]},k=e=>{let t=e.split("."),a=Number(t[1]),r=t[2],i=Number(r.slice(0,-1)),s="H"===r.slice(-1)?1:0,n=Number(t[3]),o=t[4]?Number(t[4]):0,d=t[5]?Number(t[5][0]):1;return[129,(a<<5)+i,(s<<7)+((8===n?0:1)<<6)+0+(o<<4)+(d<<3)+((t[5]?Number(t[5][1]):1)<<2)+(t[5]?Number(t[5][2]):0),0]},b=e=>{let{codec:t,codecDescription:a,colorSpace:i,avcCodecInfo:s,hevcCodecInfo:n,vp9CodecInfo:o,av1CodecInfo:d}=e;if("avc"===t){if(s){let e=new Uint8Array([s.avcProfileIndication,s.profileCompatibility,s.avcLevelIndication]);return`avc1.${(0,r.Br)(e)}`}if(!a||a.byteLength<4)throw TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return`avc1.${(0,r.Br)(a.subarray(1,4))}`}if("hevc"===t){let e,t,i,s,o,d;if(n)e=n.generalProfileSpace,t=n.generalProfileIdc,i=(0,r.P5)(n.generalProfileCompatibilityFlags),s=n.generalTierFlag,o=n.generalLevelIdc,d=[...n.generalConstraintIndicatorFlags];else{if(!a||a.byteLength<23)throw TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let n=(0,r.Zc)(a),c=n.getUint8(1);e=c>>6&3,t=31&c,i=(0,r.P5)(n.getUint32(2)),s=c>>5&1,o=n.getUint8(12),d=[];for(let e=0;e<6;e++)d.push(n.getUint8(6+e))}let c="hev1.";for(c+=["","A","B","C"][e]+t,c+=".",c+=i.toString(16).toUpperCase(),c+=".",c+=0===s?"L":"H",c+=o;d.length>0&&0===d[d.length-1];)d.pop();return d.length>0&&(c+=".",c+=d.map(e=>e.toString(16).toUpperCase()).join(".")),c}if("vp8"===t)return"vp8";if("vp9"===t){if(!o){let t=e.width*e.height,a=(0,r._g)(u).level;for(let e of u)if(t<=e.maxPictureSize){a=e.level;break}return`vp09.00.${a.toString().padStart(2,"0")}.08`}let t=o.profile.toString().padStart(2,"0"),a=o.level.toString().padStart(2,"0"),i=o.bitDepth.toString().padStart(2,"0"),s=o.chromaSubsampling.toString().padStart(2,"0"),n=o.colourPrimaries.toString().padStart(2,"0"),d=o.transferCharacteristics.toString().padStart(2,"0"),c=o.matrixCoefficients.toString().padStart(2,"0"),l=o.videoFullRangeFlag.toString().padStart(2,"0"),h=`vp09.${t}.${a}.${i}.${s}`;return(h+=`.${n}.${d}.${c}.${l}`).endsWith(m)&&(h=h.slice(0,-m.length)),h}if("av1"===t){if(!d){let t=e.width*e.height,a=(0,r._g)(u).level;for(let e of u)if(t<=e.maxPictureSize){a=e.level;break}return`av01.0.${a.toString().padStart(2,"0")}M.08`}let t=d.profile,a=d.level.toString().padStart(2,"0"),s=d.tier?"H":"M",n=d.bitDepth.toString().padStart(2,"0"),o=d.monochrome?"1":"0",c=100*d.chromaSubsamplingX+10*d.chromaSubsamplingY+1*(d.chromaSubsamplingX&&d.chromaSubsamplingY?d.chromaSamplePosition:0),l=i?.primaries?r.wd[i.primaries]:1,h=i?.transfer?r.uN[i.transfer]:1,m=i?.matrix?r.Au[i.matrix]:1,p=i?.fullRange?1:0,g=`av01.${t}.${a}${s}.${n}`;return g+=`.${o}.${c.toString().padStart(3,"0")}`,g+=`.${l.toString().padStart(2,"0")}`,g+=`.${h.toString().padStart(2,"0")}`,g+=`.${m.toString().padStart(2,"0")}`,(g+=`.${p}`).endsWith(f)&&(g=g.slice(0,-f.length)),g}throw TypeError(`Unhandled codec '${t}'.`)},w=(e,t,a)=>{if("aac"===e)return t>=2&&a<=24e3?"mp4a.40.29":a<=24e3?"mp4a.40.5":"mp4a.40.2";if("mp3"===e)return"mp3";if("opus"===e)return"opus";if("vorbis"===e)return"vorbis";if("flac"===e)return"flac";if(s.includes(e))return e;throw TypeError(`Unhandled codec '${e}'.`)},T=e=>{let{codec:t,codecDescription:a,aacCodecInfo:r}=e;if("aac"===t){if(!r)throw TypeError("AAC codec info must be provided.");if(r.isMpeg2)return"mp4a.67";{let e=y(a);return`mp4a.40.${e.objectType}`}}if("mp3"===t)return"mp3";if("opus"===t)return"opus";if("vorbis"===t)return"vorbis";if("flac"===t)return"flac";if(t&&s.includes(t))return t;throw TypeError(`Unhandled codec '${t}'.`)},y=e=>{if(!e||e.byteLength<2)throw TypeError("AAC description must be at least 2 bytes long.");let t=new r._c(e),a=t.readBits(5);31===a&&(a=32+t.readBits(6));let i=t.readBits(4),s=null;if(15===i)s=t.readBits(24);else{let e=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];i<e.length&&(s=e[i])}let n=t.readBits(4),o=null;return n>=1&&n<=7&&(o=({1:1,2:2,3:3,4:4,5:5,6:6,7:8})[n]),{objectType:a,frequencyIndex:i,sampleRate:s,channelConfiguration:n,numberOfChannels:o}},S=48e3,C=/^pcm-([usf])(\d+)+(be)?$/,v=e=>{let t;if((0,r.vA)(s.includes(e)),"ulaw"===e)return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if("alaw"===e)return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let a=C.exec(e);return(0,r.vA)(a),t="u"===a[1]?"unsigned":"s"===a[1]?"signed":"float",{dataType:t,sampleSize:Number(a[2])/8,littleEndian:"be"!==a[3],silentValue:"pcm-u8"===e?128:0}},x=e=>{if(e.startsWith("avc1")||e.startsWith("avc3"))return"avc";if(e.startsWith("hev1")||e.startsWith("hvc1"))return"hevc";if("vp8"===e)return"vp8";if(e.startsWith("vp09"))return"vp9";if(e.startsWith("av01"))return"av1";if(e.startsWith("mp4a.40")||"mp4a.67"===e)return"aac";if("mp3"===e||"mp4a.69"===e||"mp4a.6B"===e||"mp4a.6b"===e)return"mp3";if("opus"===e)return"opus";if("vorbis"===e)return"vorbis";if("flac"===e)return"flac";if("ulaw"===e)return"ulaw";if("alaw"===e)return"alaw";else if(C.test(e))return e;return"webvtt"===e?"webvtt":null},I=e=>"avc"===e?{avc:{format:"avc"}}:"hevc"===e?{hevc:{format:"hevc"}}:{},P=e=>"aac"===e?{aac:{format:"aac"}}:"opus"===e?{opus:{format:"opus"}}:{};class E{constructor(e){this._factor=e}_toVideoBitrate(e,t,a){return 1e3*Math.ceil(3e6*Math.pow(t*a/2073600,.95)*({avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2})[e]*this._factor/1e3)}_toAudioBitrate(e){if(s.includes(e)||"flac"===e)return;let t={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!t)throw Error(`Unhandled codec: ${e}`);let a=t*this._factor;return"aac"===e?a=[96e3,128e3,16e4,192e3].reduce((e,t)=>Math.abs(t-a)<Math.abs(e-a)?t:e):"opus"===e||"vorbis"===e?a=Math.max(6e3,a):"mp3"===e&&(a=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((e,t)=>Math.abs(t-a)<Math.abs(e-a)?t:e)),1e3*Math.round(a/1e3)}}new E(.3),new E(.6),new E(1),new E(2);let A=new E(4),R=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],B=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,_=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,F=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,D=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,M=e=>{if(!e)throw TypeError("Video chunk metadata must be provided.");if("object"!=typeof e)throw TypeError("Video chunk metadata must be an object.");if(!e.decoderConfig)throw TypeError("Video chunk metadata must include a decoder configuration.");if("object"!=typeof e.decoderConfig)throw TypeError("Video chunk metadata decoder configuration must be an object.");if("string"!=typeof e.decoderConfig.codec)throw TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!R.some(t=>e.decoderConfig.codec.startsWith(t)))throw TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.codedWidth)||e.decoderConfig.codedWidth<=0)throw TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(e.decoderConfig.codedHeight)||e.decoderConfig.codedHeight<=0)throw TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(void 0!==e.decoderConfig.description&&!(0,r.SM)(e.decoderConfig.description))throw TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(void 0!==e.decoderConfig.colorSpace){let{colorSpace:t}=e.decoderConfig;if("object"!=typeof t)throw TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let a=Object.keys(r.wd);if(null!=t.primaries&&!a.includes(t.primaries))throw TypeError(`Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ${a.join(", ")}.`);let i=Object.keys(r.uN);if(null!=t.transfer&&!i.includes(t.transfer))throw TypeError(`Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ${i.join(", ")}.`);let s=Object.keys(r.Au);if(null!=t.matrix&&!s.includes(t.matrix))throw TypeError(`Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ${s.join(", ")}.`);if(null!=t.fullRange&&"boolean"!=typeof t.fullRange)throw TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(e.decoderConfig.codec.startsWith("avc1")||e.decoderConfig.codec.startsWith("avc3")){if(!B.test(e.decoderConfig.codec))throw TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(e.decoderConfig.codec.startsWith("hev1")||e.decoderConfig.codec.startsWith("hvc1")){if(!_.test(e.decoderConfig.codec))throw TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(e.decoderConfig.codec.startsWith("vp8")){if("vp8"!==e.decoderConfig.codec)throw TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(e.decoderConfig.codec.startsWith("vp09")){if(!F.test(e.decoderConfig.codec))throw TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(e.decoderConfig.codec.startsWith("av01")&&!D.test(e.decoderConfig.codec))throw TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},U=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],z=e=>{if(!e)throw TypeError("Audio chunk metadata must be provided.");if("object"!=typeof e)throw TypeError("Audio chunk metadata must be an object.");if(!e.decoderConfig)throw TypeError("Audio chunk metadata must include a decoder configuration.");if("object"!=typeof e.decoderConfig)throw TypeError("Audio chunk metadata decoder configuration must be an object.");if("string"!=typeof e.decoderConfig.codec)throw TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!U.some(t=>e.decoderConfig.codec.startsWith(t)))throw TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.sampleRate)||e.decoderConfig.sampleRate<=0)throw TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(e.decoderConfig.numberOfChannels)||e.decoderConfig.numberOfChannels<=0)throw TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(void 0!==e.decoderConfig.description&&!(0,r.SM)(e.decoderConfig.description))throw TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.codec.startsWith("mp4a")&&"mp4a.69"!==e.decoderConfig.codec&&"mp4a.6B"!==e.decoderConfig.codec&&"mp4a.6b"!==e.decoderConfig.codec){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(e.decoderConfig.codec))throw TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!e.decoderConfig.description)throw TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(e.decoderConfig.codec.startsWith("mp3")||e.decoderConfig.codec.startsWith("mp4a")){if("mp3"!==e.decoderConfig.codec&&"mp4a.69"!==e.decoderConfig.codec&&"mp4a.6B"!==e.decoderConfig.codec&&"mp4a.6b"!==e.decoderConfig.codec)throw TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(e.decoderConfig.codec.startsWith("opus")){if("opus"!==e.decoderConfig.codec)throw TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(e.decoderConfig.description&&e.decoderConfig.description.byteLength<18)throw TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(e.decoderConfig.codec.startsWith("vorbis")){if("vorbis"!==e.decoderConfig.codec)throw TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!e.decoderConfig.description)throw TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(e.decoderConfig.codec.startsWith("flac")){if("flac"!==e.decoderConfig.codec)throw TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!e.decoderConfig.description||e.decoderConfig.description.byteLength<42)throw TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((e.decoderConfig.codec.startsWith("pcm")||e.decoderConfig.codec.startsWith("ulaw")||e.decoderConfig.codec.startsWith("alaw"))&&!s.includes(e.decoderConfig.codec))throw TypeError(`Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (${s.join(", ")}).`)},O=e=>{if(!e)throw TypeError("Subtitle metadata must be provided.");if("object"!=typeof e)throw TypeError("Subtitle metadata must be an object.");if(!e.config)throw TypeError("Subtitle metadata must include a config object.");if("object"!=typeof e.config)throw TypeError("Subtitle metadata config must be an object.");if("string"!=typeof e.config.description)throw TypeError("Subtitle metadata config description must be a string.")}},937036:(e,t,a)=>{a.d(t,{Lr:()=>n,WE:()=>s,wb:()=>r,zx:()=>i});let r=[],i=[],s=[],n=[]},730875:(e,t,a)=>{a.d(t,{B:()=>r});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class r{constructor(e){this.input=e}}},694009:(e,t,a)=>{a.d(t,{CW:()=>K,uS:()=>j});var r,i=a(308573),s=a(507174),n=a(730875),o=a(368501),d=a(31463),c=a(112863),l=a(877640),u=a(176793),h=a(669722);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class m extends n.B{constructor(e){super(e),this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.fragments=[],this.currentFragment=null,this.fragmentLookupMutex=new d.aD,this.metadataReader=new h.oj(e._mainReader),this.chunkReader=new h.oj(new l.m(e.source,0x4000000))}async computeDuration(){let e=await this.getTracks();return Math.max(0,...await Promise.all(e.map(e=>e.computeDuration())))}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(e=>e.inputTrack.getCodecParameterString()));return(0,u.X)({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(e=>e.info?.type==="video"),hasAudio:this.tracks.some(e=>e.info?.type==="audio"),codecStrings:e.filter(Boolean)})}readMetadata(){return this.metadataPromise??=(async()=>{let e=await this.metadataReader.reader.source.getSize();for(;this.metadataReader.pos<e;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+h.Xk);let e=this.metadataReader.pos,t=this.metadataReader.readBoxHeader();if("ftyp"===t.name){let e=this.metadataReader.readAscii(4);this.isQuickTime="qt  "===e}else if("moov"===t.name){for(let e of(await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+t.contentSize),this.readContiguousBoxes(t.contentSize),this.tracks)){let t=e.editListPreviousSegmentDurations/this.movieTimescale;e.editListOffset-=Math.round(t*e.timescale)}break}this.metadataReader.pos=e+t.totalSize}if(this.isFragmented){await this.metadataReader.reader.loadRange(e-4,e),this.metadataReader.pos=e-4;let t=e-this.metadataReader.readU32();if(t>=0&&t<e){await this.metadataReader.reader.loadRange(t,e),this.metadataReader.pos=t;let a=this.metadataReader.readBoxHeader();"mfra"===a.name&&this.readContiguousBoxes(a.contentSize)}}})()}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};if(e.sampleTable=t,this.metadataReader.pos=e.sampleTableByteOffset,this.currentTrack=e,this.traverseBox(),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&i.Wq.includes(e.info.codec)&&0===t.sampleCompositionTimeOffsets.length){(0,d.vA)(e.info?.type==="audio");let a=(0,i.Ei)(e.info.codec),r=[],s=[];for(let i=0;i<t.sampleToChunk.length;i++){let n=t.sampleToChunk[i],o=t.sampleToChunk[i+1],c=(o?o.startChunkIndex:t.chunkOffsets.length)-n.startChunkIndex;for(let i=0;i<c;i++){let o=n.startSampleIndex+i*n.samplesPerChunk,c=o+n.samplesPerChunk,l=(0,d.eE)(t.sampleTimingEntries,o,e=>e.startIndex),u=t.sampleTimingEntries[l],h=(0,d.eE)(t.sampleTimingEntries,c,e=>e.startIndex),m=t.sampleTimingEntries[h],f=u.startDecodeTimestamp+(o-u.startIndex)*u.delta,p=m.startDecodeTimestamp+(c-m.startIndex)*m.delta-f,g=(0,d._g)(r);g&&g.delta===p?g.count++:r.push({startIndex:n.startChunkIndex+i,startDecodeTimestamp:f,count:1,delta:p});let k=n.samplesPerChunk*a.sampleSize*e.info.numberOfChannels;s.push(k)}n.startSampleIndex=n.startChunkIndex,n.samplesPerChunk=1}t.sampleTimingEntries=r,t.sampleSizes=s}if(t.sampleCompositionTimeOffsets.length>0){for(let e of(t.presentationTimestamps=[],t.sampleTimingEntries))for(let a=0;a<e.count;a++)t.presentationTimestamps.push({presentationTimestamp:e.startDecodeTimestamp+a*e.delta,sampleIndex:e.startIndex+a});for(let e of t.sampleCompositionTimeOffsets)for(let a=0;a<e.count;a++){let r=e.startIndex+a,i=t.presentationTimestamps[r];i&&(i.presentationTimestamp+=e.offset)}t.presentationTimestamps.sort((e,t)=>e.presentationTimestamp-t.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let e=0;e<t.presentationTimestamps.length;e++)t.presentationTimestampIndexMap[t.presentationTimestamps[e].sampleIndex]=e}return t}async readFragment(){let e=this.metadataReader.pos;await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+h.Xk);let t=this.metadataReader.readBoxHeader();(0,d.vA)("moof"===t.name);let a=this.metadataReader.pos;await this.metadataReader.reader.loadRange(a,a+t.contentSize),this.metadataReader.pos=e,this.traverseBox();let r=(0,d.pl)(this.fragments,e,e=>e.moofOffset);(0,d.vA)(-1!==r);let i=this.fragments[r];for(let[r,s]of((0,d.vA)(i.moofOffset===e),this.metadataReader.reader.forgetRange(a,a+t.contentSize),i.trackData)){if(s.startTimestampIsFinal)continue;let t=this.tracks.find(e=>e.id===r);this.metadataReader.pos=0;let a=null,i=null,n=(0,d.eE)(t.fragments,e-1,e=>e.moofOffset);-1!==n&&(i=a=t.fragments[n],this.metadataReader.pos=a.moofOffset+a.moofSize);let o=0===this.metadataReader.pos;for(;this.metadataReader.pos<e;){if(a?.nextFragment)a=a.nextFragment,this.metadataReader.pos=a.moofOffset+a.moofSize;else{await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+h.Xk);let e=this.metadataReader.pos,t=this.metadataReader.readBoxHeader();if("moof"===t.name){let t;let r=(0,d.pl)(this.fragments,e,e=>e.moofOffset);-1===r?(this.metadataReader.pos=e,t=await this.readFragment()):t=this.fragments[r],a&&(a.nextFragment=t),a=t,o&&(t.isKnownToBeFirstFragment=!0,o=!1)}this.metadataReader.pos=e+t.totalSize}a&&a.trackData.has(r)&&(i=a)}if(i){let e=i.trackData.get(r);(0,d.vA)(e.startTimestampIsFinal),y(s,e.endTimestamp)}s.startTimestampIsFinal=!0}return i}readContiguousBoxes(e){let t=this.metadataReader.pos;for(;this.metadataReader.pos-t<=e-h.ZM;)this.traverseBox()}traverseBox(){let e=this.metadataReader.pos,t=this.metadataReader.readBoxHeader(),a=e+t.totalSize;switch(t.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":case"wave":this.readContiguousBoxes(t.contentSize);break;case"mvhd":{let e=this.metadataReader.readU8();this.metadataReader.pos+=3,1===e?(this.metadataReader.pos+=16,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU64()):(this.metadataReader.pos+=8,this.movieTimescale=this.metadataReader.readU32(),this.movieDurationInTimescale=this.metadataReader.readU32())}break;case"trak":{let e={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,languageCode:d.IR,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:null,currentFragmentState:null,fragments:[],fragmentsWithKeyFrame:[],editListPreviousSegmentDurations:0,editListOffset:0};this.currentTrack=e,this.readContiguousBoxes(t.contentSize),-1!==e.id&&-1!==e.timescale&&null!==e.info&&("video"===e.info.type&&-1!==e.info.width?(e.inputTrack=new o.N0(new p(e)),this.tracks.push(e)):"audio"===e.info.type&&-1!==e.info.numberOfChannels&&(e.inputTrack=new o.Yi(new g(e)),this.tracks.push(e))),this.currentTrack=null}break;case"tkhd":{let e=this.currentTrack;(0,d.vA)(e);let t=this.metadataReader.readU8();if(!((1&this.metadataReader.readU24())!=0))break;if(0===t)this.metadataReader.pos+=8,e.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,e.durationInMovieTimescale=this.metadataReader.readU32();else if(1===t)this.metadataReader.pos+=16,e.id=this.metadataReader.readU32(),this.metadataReader.pos+=4,e.durationInMovieTimescale=this.metadataReader.readU64();else throw Error(`Incorrect track header version ${t}.`);this.metadataReader.pos+=16;let a=[this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_16_16(),this.metadataReader.readFixed_2_30()],r=(0,d.qT)((0,d.in)(S(a),90));(0,d.vA)(0===r||90===r||180===r||270===r),e.rotation=r}break;case"elst":{let e=this.currentTrack;(0,d.vA)(e);let t=this.metadataReader.readU8();this.metadataReader.pos+=3;let a=!1,r=0,i=this.metadataReader.readU32();for(let s=0;s<i;s++){let i=1===t?this.metadataReader.readU64():this.metadataReader.readU32(),s=1===t?this.metadataReader.readI64():this.metadataReader.readI32(),n=this.metadataReader.readFixed_16_16();if(0!==i){if(a){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(-1===s){r+=i;continue}if(1!==n){console.warn("Unsupported edit list entry: media rate must be 1.");break}e.editListPreviousSegmentDurations=r,e.editListOffset=s,a=!0}}}break;case"mdhd":{let e=this.currentTrack;(0,d.vA)(e);let t=this.metadataReader.readU8();this.metadataReader.pos+=3,0===t?(this.metadataReader.pos+=8,e.timescale=this.metadataReader.readU32(),e.durationInMediaTimescale=this.metadataReader.readU32()):1===t&&(this.metadataReader.pos+=16,e.timescale=this.metadataReader.readU32(),e.durationInMediaTimescale=this.metadataReader.readU64());let a=this.metadataReader.readU16();if(a>0){e.languageCode="";for(let t=0;t<3;t++)e.languageCode=String.fromCharCode(96+(31&a))+e.languageCode,a>>=5;(0,d.Nu)(e.languageCode)||(e.languageCode=d.IR)}}break;case"hdlr":{let e=this.currentTrack;(0,d.vA)(e),this.metadataReader.pos+=8;let t=this.metadataReader.readAscii(4);"vide"===t?e.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:"soun"===t&&(e.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let a=this.currentTrack;(0,d.vA)(a),a.sampleTableByteOffset=e,this.readContiguousBoxes(t.contentSize)}break;case"stsd":{let e=this.currentTrack;if((0,d.vA)(e),null===e.info||e.sampleTable)break;let t=this.metadataReader.readU8();this.metadataReader.pos+=3;let a=this.metadataReader.readU32();for(let r=0;r<a;r++){let a=this.metadataReader.pos,r=this.metadataReader.readBoxHeader(),i=r.name.toLowerCase();if("video"===e.info.type)"avc1"===i?e.info.codec="avc":"hvc1"===i||"hev1"===i?e.info.codec="hevc":"vp08"===i?e.info.codec="vp8":"vp09"===i?e.info.codec="vp9":"av01"===i?e.info.codec="av1":console.warn(`Unsupported video codec (sample entry type '${r.name}').`),this.metadataReader.pos+=24,e.info.width=this.metadataReader.readU16(),e.info.height=this.metadataReader.readU16(),this.metadataReader.pos+=50,this.readContiguousBoxes(a+r.totalSize-this.metadataReader.pos);else{"mp4a"===i||("opus"===i?e.info.codec="opus":"flac"===i?e.info.codec="flac":"twos"===i||"sowt"===i||"raw "===i||"in24"===i||"in32"===i||"fl32"===i||"fl64"===i||"lpcm"===i||"ipcm"===i||"fpcm"===i||("ulaw"===i?e.info.codec="ulaw":"alaw"===i?e.info.codec="alaw":console.warn(`Unsupported audio codec (sample entry type '${r.name}').`))),this.metadataReader.pos+=8;let s=this.metadataReader.readU16();this.metadataReader.pos+=6;let n=this.metadataReader.readU16(),o=this.metadataReader.readU16();this.metadataReader.pos+=4;let d=this.metadataReader.readU32()/65536;if(0===t&&s>0){if(1===s)this.metadataReader.pos+=4,o=8*this.metadataReader.readU32(),this.metadataReader.pos+=8;else if(2===s){this.metadataReader.pos+=4,d=this.metadataReader.readF64(),n=this.metadataReader.readU32(),this.metadataReader.pos+=4,o=this.metadataReader.readU32();let t=this.metadataReader.readU32();if(this.metadataReader.pos+=8,"lpcm"===i){let a=o+7>>3,r=!!(1&t),i=!!(2&t),s=4&t?-1:0;o>0&&o<=64&&(r?32===o&&(e.info.codec=i?"pcm-f32be":"pcm-f32"):s&1<<a-1?1===a?e.info.codec="pcm-s8":2===a?e.info.codec=i?"pcm-s16be":"pcm-s16":3===a?e.info.codec=i?"pcm-s24be":"pcm-s24":4===a&&(e.info.codec=i?"pcm-s32be":"pcm-s32"):1===a&&(e.info.codec="pcm-u8")),null===e.info.codec&&console.warn("Unsupported PCM format.")}}}e.info.numberOfChannels=n,e.info.sampleRate=d,"twos"===i?8===o?e.info.codec="pcm-s8":16===o?e.info.codec="pcm-s16be":(console.warn(`Unsupported sample size ${o} for codec 'twos'.`),e.info.codec=null):"sowt"===i?8===o?e.info.codec="pcm-s8":16===o?e.info.codec="pcm-s16":(console.warn(`Unsupported sample size ${o} for codec 'sowt'.`),e.info.codec=null):"raw "===i?e.info.codec="pcm-u8":"in24"===i?e.info.codec="pcm-s24be":"in32"===i?e.info.codec="pcm-s32be":"fl32"===i?e.info.codec="pcm-f32be":"fl64"===i?e.info.codec="pcm-f64be":"ipcm"===i?e.info.codec="pcm-s16be":"fpcm"===i&&(e.info.codec="pcm-f32be"),this.readContiguousBoxes(a+r.totalSize-this.metadataReader.pos)}}}break;case"avcC":{let e=this.currentTrack;(0,d.vA)(e&&e.info),e.info.codecDescription=this.metadataReader.readBytes(t.contentSize)}break;case"hvcC":{let e=this.currentTrack;(0,d.vA)(e&&e.info),e.info.codecDescription=this.metadataReader.readBytes(t.contentSize)}break;case"vpcC":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="video"),this.metadataReader.pos+=4;let t=this.metadataReader.readU8(),a=this.metadataReader.readU8(),r=this.metadataReader.readU8(),i=this.metadataReader.readU8(),s=this.metadataReader.readU8(),n=this.metadataReader.readU8();e.info.vp9CodecInfo={profile:t,level:a,bitDepth:r>>4,chromaSubsampling:r>>1&7,videoFullRangeFlag:1&r,colourPrimaries:i,transferCharacteristics:s,matrixCoefficients:n}}break;case"av1C":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="video"),this.metadataReader.pos+=1;let t=this.metadataReader.readU8(),a=t>>5,r=this.metadataReader.readU8(),i=r>>6&1;e.info.av1CodecInfo={profile:a,level:31&t,tier:r>>7,bitDepth:2==a&&i?r>>5&1?12:10:i?10:8,monochrome:r>>4&1,chromaSubsamplingX:r>>3&1,chromaSubsamplingY:r>>2&1,chromaSamplePosition:3&r}}break;case"colr":{let e=this.currentTrack;if((0,d.vA)(e&&e.info?.type==="video"),"nclx"!==this.metadataReader.readAscii(4))break;let t=this.metadataReader.readU16(),a=this.metadataReader.readU16(),r=this.metadataReader.readU16(),i=!!(128&this.metadataReader.readU8());e.info.colorSpace={primaries:d.BL[t],transfer:d.x_[a],matrix:d.fl[r],fullRange:i}}break;case"esds":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="audio"),this.metadataReader.pos+=4;let t=this.metadataReader.readU8();(0,d.vA)(3===t),this.metadataReader.readIsomVariableInteger(),this.metadataReader.pos+=2;let a=this.metadataReader.readU8();if((128&a)!=0&&(this.metadataReader.pos+=2),(64&a)!=0){let e=this.metadataReader.readU8();this.metadataReader.pos+=e}(32&a)!=0&&(this.metadataReader.pos+=2);let r=this.metadataReader.readU8();(0,d.vA)(4===r);let s=this.metadataReader.readIsomVariableInteger(),n=this.metadataReader.pos,o=this.metadataReader.readU8();if(64===o||103===o?(e.info.codec="aac",e.info.aacCodecInfo={isMpeg2:103===o}):105===o||107===o?e.info.codec="mp3":221===o?e.info.codec="vorbis":console.warn(`Unsupported audio codec (objectTypeIndication ${o}) - discarding track.`),this.metadataReader.pos+=12,s>this.metadataReader.pos-n){let t=this.metadataReader.readU8();(0,d.vA)(5===t);let a=this.metadataReader.readIsomVariableInteger();if(e.info.codecDescription=this.metadataReader.readBytes(a),"aac"===e.info.codec){let t=(0,i.zF)(e.info.codecDescription);null!==t.numberOfChannels&&(e.info.numberOfChannels=t.numberOfChannels),null!==t.sampleRate&&(e.info.sampleRate=t.sampleRate)}}}break;case"enda":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="audio"),255&this.metadataReader.readU16()&&("pcm-s16be"===e.info.codec?e.info.codec="pcm-s16":"pcm-s24be"===e.info.codec?e.info.codec="pcm-s24":"pcm-s32be"===e.info.codec?e.info.codec="pcm-s32":"pcm-f32be"===e.info.codec?e.info.codec="pcm-f32":"pcm-f64be"===e.info.codec&&(e.info.codec="pcm-f64"))}break;case"pcmC":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="audio"),this.metadataReader.pos+=4;let t=!!(1&this.metadataReader.readU8()),a=this.metadataReader.readU8();"pcm-s16be"===e.info.codec?t?16===a?e.info.codec="pcm-s16":24===a?e.info.codec="pcm-s24":32===a?e.info.codec="pcm-s32":(console.warn(`Invalid ipcm sample size ${a}.`),e.info.codec=null):16===a?e.info.codec="pcm-s16be":24===a?e.info.codec="pcm-s24be":32===a?e.info.codec="pcm-s32be":(console.warn(`Invalid ipcm sample size ${a}.`),e.info.codec=null):"pcm-f32be"===e.info.codec&&(t?32===a?e.info.codec="pcm-f32":64===a?e.info.codec="pcm-f64":(console.warn(`Invalid fpcm sample size ${a}.`),e.info.codec=null):32===a?e.info.codec="pcm-f32be":64===a?e.info.codec="pcm-f64be":(console.warn(`Invalid fpcm sample size ${a}.`),e.info.codec=null));break}case"dOps":{let e;let t=this.currentTrack;(0,d.vA)(t&&t.info?.type==="audio"),this.metadataReader.pos+=1;let a=this.metadataReader.readU8(),r=this.metadataReader.readU16(),i=this.metadataReader.readU32(),s=this.metadataReader.readI16(),n=this.metadataReader.readU8();e=0!==n?this.metadataReader.readBytes(2+a):new Uint8Array(0);let o=new Uint8Array(19+e.byteLength),c=new DataView(o.buffer);c.setUint32(0,0x4f707573,!1),c.setUint32(4,0x48656164,!1),c.setUint8(8,1),c.setUint8(9,a),c.setUint16(10,r,!0),c.setUint32(12,i,!0),c.setInt16(16,s,!0),c.setUint8(18,n),o.set(e,19),t.info.codecDescription=o,t.info.numberOfChannels=a,t.info.sampleRate=i}break;case"dfLa":{let e=this.currentTrack;(0,d.vA)(e&&e.info?.type==="audio"),this.metadataReader.pos+=4;let t=this.metadataReader.pos;for(;this.metadataReader.pos<a;){let t=this.metadataReader.readU8(),a=this.metadataReader.readU24();if(0==(127&t)){this.metadataReader.pos+=10;let t=this.metadataReader.readU32(),a=t>>>12,r=(t>>9&7)+1;e.info.sampleRate=a,e.info.numberOfChannels=r,this.metadataReader.pos+=20}else this.metadataReader.pos+=a;if(128&t)break}let r=this.metadataReader.pos;this.metadataReader.pos=t;let i=this.metadataReader.readBytes(r-t),s=new Uint8Array(4+i.byteLength);new DataView(s.buffer).setUint32(0,0x664c6143,!1),s.set(i,4),e.info.codecDescription=s}break;case"stts":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32(),a=0,r=0;for(let i=0;i<t;i++){let t=this.metadataReader.readU32(),i=this.metadataReader.readU32();e.sampleTable.sampleTimingEntries.push({startIndex:a,startDecodeTimestamp:r,count:t,delta:i}),a+=t,r+=t*i}}break;case"ctts":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32(),a=0;for(let r=0;r<t;r++){let t=this.metadataReader.readU32(),r=this.metadataReader.readI32();e.sampleTable.sampleCompositionTimeOffsets.push({startIndex:a,count:t,offset:r}),a+=t}}break;case"stsz":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32(),a=this.metadataReader.readU32();if(0===t)for(let t=0;t<a;t++){let t=this.metadataReader.readU32();e.sampleTable.sampleSizes.push(t)}else e.sampleTable.sampleSizes.push(t)}break;case"stz2":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4,this.metadataReader.pos+=3;let t=this.metadataReader.readU8(),a=this.metadataReader.readU32(),r=this.metadataReader.readBytes(Math.ceil(a*t/8)),i=new d._c(r);for(let r=0;r<a;r++){let a=i.readBits(t);e.sampleTable.sampleSizes.push(a)}}break;case"stss":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4,e.sampleTable.keySampleIndices=[];let t=this.metadataReader.readU32();for(let a=0;a<t;a++){let t=this.metadataReader.readU32()-1;e.sampleTable.keySampleIndices.push(t)}0!==e.sampleTable.keySampleIndices[0]&&e.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32();for(let a=0;a<t;a++){let t=this.metadataReader.readU32()-1,a=this.metadataReader.readU32(),r=this.metadataReader.readU32();e.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:t,samplesPerChunk:a,sampleDescriptionIndex:r})}let a=0;for(let t=0;t<e.sampleTable.sampleToChunk.length;t++)e.sampleTable.sampleToChunk[t].startSampleIndex=a,t<e.sampleTable.sampleToChunk.length-1&&(a+=(e.sampleTable.sampleToChunk[t+1].startChunkIndex-e.sampleTable.sampleToChunk[t].startChunkIndex)*e.sampleTable.sampleToChunk[t].samplesPerChunk)}break;case"stco":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32();for(let a=0;a<t;a++){let t=this.metadataReader.readU32();e.sampleTable.chunkOffsets.push(t)}}break;case"co64":{let e=this.currentTrack;if((0,d.vA)(e),!e.sampleTable)break;this.metadataReader.pos+=4;let t=this.metadataReader.readU32();for(let a=0;a<t;a++){let t=this.metadataReader.readU64();e.sampleTable.chunkOffsets.push(t)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(t.contentSize);break;case"mehd":{let e=this.metadataReader.readU8();this.metadataReader.pos+=3;let t=1===e?this.metadataReader.readU64():this.metadataReader.readU32();this.movieDurationInTimescale=t}break;case"trex":{this.metadataReader.pos+=4;let e=this.metadataReader.readU32(),t=this.metadataReader.readU32(),a=this.metadataReader.readU32(),r=this.metadataReader.readU32(),i=this.metadataReader.readU32();this.fragmentTrackDefaults.push({trackId:e,defaultSampleDescriptionIndex:t,defaultSampleDuration:a,defaultSampleSize:r,defaultSampleFlags:i})}break;case"tfra":{let e=this.metadataReader.readU8();this.metadataReader.pos+=3;let t=this.metadataReader.readU32(),a=this.tracks.find(e=>e.id===t);if(!a)break;a.fragmentLookupTable=[];let r=this.metadataReader.readU32(),i=this.metadataReader,s=[i.readU8.bind(i),i.readU16.bind(i),i.readU24.bind(i),i.readU32.bind(i)],n=s[(48&r)>>4],o=s[(12&r)>>2],d=s[3&r],c=this.metadataReader.readU32();for(let t=0;t<c;t++){let t=1===e?this.metadataReader.readU64():this.metadataReader.readU32(),r=1===e?this.metadataReader.readU64():this.metadataReader.readU32();n(),o(),d(),a.fragmentLookupTable.push({timestamp:t,moofOffset:r})}}break;case"moof":for(let[,a]of(this.currentFragment={moofOffset:e,moofSize:t.totalSize,implicitBaseDataOffset:e,trackData:new Map,dataStart:1/0,dataEnd:0,nextFragment:null,isKnownToBeFirstFragment:!1},this.readContiguousBoxes(t.contentSize),(0,d.h8)(this.fragments,this.currentFragment,e=>e.moofOffset),this.currentFragment.trackData)){let e=a.samples[0],t=(0,d._g)(a.samples);this.currentFragment.dataStart=Math.min(this.currentFragment.dataStart,e.byteOffset),this.currentFragment.dataEnd=Math.max(this.currentFragment.dataEnd,t.byteOffset+t.byteSize)}this.currentFragment=null;break;case"traf":if((0,d.vA)(this.currentFragment),this.readContiguousBoxes(t.contentSize),this.currentTrack){let e=this.currentFragment.trackData.get(this.currentTrack.id);if(e){(0,d.h8)(this.currentTrack.fragments,this.currentFragment,e=>e.moofOffset),null!==e.firstKeyFrameTimestamp&&(0,d.h8)(this.currentTrack.fragmentsWithKeyFrame,this.currentFragment,e=>e.moofOffset);let{currentFragmentState:t}=this.currentTrack;(0,d.vA)(t),null!==t.startTimestamp&&(y(e,t.startTimestamp),e.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{(0,d.vA)(this.currentFragment),this.metadataReader.pos+=1;let e=this.metadataReader.readU24(),t=this.metadataReader.readU32(),a=this.tracks.find(e=>e.id===t);if(!a)break;let r=this.fragmentTrackDefaults.find(e=>e.trackId===t);this.currentTrack=a,a.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:r?.defaultSampleDescriptionIndex??null,defaultSampleDuration:r?.defaultSampleDuration??null,defaultSampleSize:r?.defaultSampleSize??null,defaultSampleFlags:r?.defaultSampleFlags??null,startTimestamp:null},1&e?a.currentFragmentState.baseDataOffset=this.metadataReader.readU64():131072&e&&(a.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),2&e&&(a.currentFragmentState.sampleDescriptionIndex=this.metadataReader.readU32()),8&e&&(a.currentFragmentState.defaultSampleDuration=this.metadataReader.readU32()),16&e&&(a.currentFragmentState.defaultSampleSize=this.metadataReader.readU32()),32&e&&(a.currentFragmentState.defaultSampleFlags=this.metadataReader.readU32()),65536&e&&(a.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let e=this.currentTrack;if(!e)break;(0,d.vA)(e.currentFragmentState);let t=this.metadataReader.readU8();this.metadataReader.pos+=3;let a=0===t?this.metadataReader.readU32():this.metadataReader.readU64();e.currentFragmentState.startTimestamp=a}break;case"trun":{let e=this.currentTrack;if(!e)break;if((0,d.vA)(this.currentFragment),(0,d.vA)(e.currentFragmentState),this.currentFragment.trackData.has(e.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let t=this.metadataReader.readU8(),a=this.metadataReader.readU24(),r=!!(256&a),i=!!(512&a),s=!!(1024&a),n=!!(2048&a),o=this.metadataReader.readU32(),c=e.currentFragmentState.baseDataOffset;1&a&&(c+=this.metadataReader.readI32());let l=null;4&a&&(l=this.metadataReader.readU32());let u=c;if(0===o){this.currentFragment.implicitBaseDataOffset=u;break}let h=0,m={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(e.id,m);for(let a=0;a<o;a++){let o,c,f;r?o=this.metadataReader.readU32():((0,d.vA)(null!==e.currentFragmentState.defaultSampleDuration),o=e.currentFragmentState.defaultSampleDuration),i?c=this.metadataReader.readU32():((0,d.vA)(null!==e.currentFragmentState.defaultSampleSize),c=e.currentFragmentState.defaultSampleSize),s?f=this.metadataReader.readU32():((0,d.vA)(null!==e.currentFragmentState.defaultSampleFlags),f=e.currentFragmentState.defaultSampleFlags),0===a&&null!==l&&(f=l);let p=0;n&&(p=0===t?this.metadataReader.readU32():this.metadataReader.readI32());let g=!(65536&f);m.samples.push({presentationTimestamp:h+p,duration:o,byteOffset:u,byteSize:c,isKeyFrame:g}),u+=c,h+=o}m.presentationTimestamps=m.samples.map((e,t)=>({presentationTimestamp:e.presentationTimestamp,sampleIndex:t})).sort((e,t)=>e.presentationTimestamp-t.presentationTimestamp);for(let e=0;e<m.presentationTimestamps.length;e++){let t=m.presentationTimestamps[e],a=m.samples[t.sampleIndex];if(null===m.firstKeyFrameTimestamp&&a.isKeyFrame&&(m.firstKeyFrameTimestamp=a.presentationTimestamp),e<m.presentationTimestamps.length-1){let r=m.presentationTimestamps[e+1];a.duration=r.presentationTimestamp-t.presentationTimestamp}}let f=m.samples[m.presentationTimestamps[0].sampleIndex],p=m.samples[(0,d._g)(m.presentationTimestamps).sampleIndex];m.startTimestamp=f.presentationTimestamp,m.endTimestamp=p.presentationTimestamp+p.duration,this.currentFragment.implicitBaseDataOffset=u}}this.metadataReader.pos=a}}class f{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw Error("Not implemented on base class.")}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){let e=await this.getFirstPacket({metadataOnly:!0});return e?.timestamp??0}async getFirstPacket(e){let t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(()=>{let e=this.internalTrack.demuxer.fragments[0]??null;if(e?.isKnownToBeFirstFragment){let t=e;for(;t;){if(t.trackData.get(this.internalTrack.id))return{fragmentIndex:(0,d.pl)(this.internalTrack.fragments,t.moofOffset,e=>e.moofOffset),sampleIndex:0,correctSampleFound:!0};t=t.nextFragment}}return{fragmentIndex:-1,sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return(0,d.CR)(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let a=this.mapTimestampIntoTimescale(e),r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=k(r,a),s=await this.fetchPacketForSampleIndex(i,t);return C(r)&&this.internalTrack.demuxer.isFragmented?this.performFragmentedLookup(()=>this.findSampleInFragmentsForTimestamp(a),a,a,t):s}async getNextPacket(e,t){let a=this.packetToSampleIndex.get(e);if(void 0!==a)return this.fetchPacketForSampleIndex(a+1,t);let r=this.packetToFragmentLocation.get(e);if(void 0===r)throw Error("Packet was not created from this track.");let i=r.fragment.trackData.get(this.internalTrack.id),s=(0,d.pl)(this.internalTrack.fragments,r.fragment.moofOffset,e=>e.moofOffset);return(0,d.vA)(-1!==s),this.performFragmentedLookup(()=>{if(r.sampleIndex+1<i.samples.length)return{fragmentIndex:s,sampleIndex:r.sampleIndex+1,correctSampleFound:!0};{let e=r.fragment;for(;e.nextFragment;)if((e=e.nextFragment).trackData.get(this.internalTrack.id)){let t=(0,d.pl)(this.internalTrack.fragments,e.moofOffset,e=>e.moofOffset);return(0,d.vA)(-1!==t),{fragmentIndex:t,sampleIndex:0,correctSampleFound:!0}}return{fragmentIndex:s,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,t)}async getKeyPacket(e,t){let a=this.mapTimestampIntoTimescale(e),r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=k(r,a),s=-1===i?-1:w(r,i),n=await this.fetchPacketForSampleIndex(s,t);return C(r)&&this.internalTrack.demuxer.isFragmented?this.performFragmentedLookup(()=>this.findKeySampleInFragmentsForTimestamp(a),a,a,t):n}async getNextKeyPacket(e,t){let a=this.packetToSampleIndex.get(e);if(void 0!==a){let e=T(this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a);return this.fetchPacketForSampleIndex(e,t)}let r=this.packetToFragmentLocation.get(e);if(void 0===r)throw Error("Packet was not created from this track.");let i=r.fragment.trackData.get(this.internalTrack.id),s=(0,d.pl)(this.internalTrack.fragments,r.fragment.moofOffset,e=>e.moofOffset);return(0,d.vA)(-1!==s),this.performFragmentedLookup(()=>{let e=i.samples.findIndex((e,t)=>e.isKeyFrame&&t>r.sampleIndex);if(-1!==e)return{fragmentIndex:s,sampleIndex:e,correctSampleFound:!0};{let e=r.fragment;for(;e.nextFragment;){let t=(e=e.nextFragment).trackData.get(this.internalTrack.id);if(t&&null!==t.firstKeyFrameTimestamp){let a=(0,d.pl)(this.internalTrack.fragments,e.moofOffset,e=>e.moofOffset);(0,d.vA)(-1!==a);let r=t.samples.findIndex(e=>e.isKeyFrame);return(0,d.vA)(-1!==r),{fragmentIndex:a,sampleIndex:r,correctSampleFound:!0}}}return{fragmentIndex:s,sampleIndex:-1,correctSampleFound:!1}}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){let a;if(-1===e)return null;let r=b(this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),e);if(!r)return null;t.metadataOnly?a=c.T:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(r.chunkOffset,r.chunkOffset+r.chunkSize),this.internalTrack.demuxer.chunkReader.pos=r.sampleOffset,a=this.internalTrack.demuxer.chunkReader.readBytes(r.sampleSize));let i=(r.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,s=r.duration/this.internalTrack.timescale,n=new c.Z(a,r.isKeyFrame?"key":"delta",i,s,e,r.sampleSize);return this.packetToSampleIndex.set(n,e),n}async fetchPacketInFragment(e,t,a){let r;if(-1===t)return null;let i=e.trackData.get(this.internalTrack.id).samples[t];(0,d.vA)(i),a.metadataOnly?r=c.T:(await this.internalTrack.demuxer.chunkReader.reader.loadRange(e.dataStart,e.dataEnd),this.internalTrack.demuxer.chunkReader.pos=i.byteOffset,r=this.internalTrack.demuxer.chunkReader.readBytes(i.byteSize));let s=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,n=i.duration/this.internalTrack.timescale,o=new c.Z(r,i.isKeyFrame?"key":"delta",s,n,e.moofOffset+t,i.byteSize);return this.packetToFragmentLocation.set(o,{fragment:e,sampleIndex:t}),o}findSampleInFragmentsForTimestamp(e){let t=(0,d.eE)(this.internalTrack.fragments,e,e=>e.trackData.get(this.internalTrack.id).startTimestamp),a=-1,r=!1;if(-1!==t){let i=this.internalTrack.fragments[t].trackData.get(this.internalTrack.id),s=(0,d.eE)(i.presentationTimestamps,e,e=>e.presentationTimestamp);(0,d.vA)(-1!==s),a=i.presentationTimestamps[s].sampleIndex,r=e<i.endTimestamp}return{fragmentIndex:t,sampleIndex:a,correctSampleFound:r}}findKeySampleInFragmentsForTimestamp(e){let t=(0,d.eE)(this.internalTrack.fragmentsWithKeyFrame,e,e=>e.trackData.get(this.internalTrack.id).startTimestamp),a=-1,r=-1,i=!1;if(-1!==t){let s=this.internalTrack.fragmentsWithKeyFrame[t];a=(0,d.pl)(this.internalTrack.fragments,s.moofOffset,e=>e.moofOffset),(0,d.vA)(-1!==a);let n=s.trackData.get(this.internalTrack.id),o=(0,d.Kl)(n.presentationTimestamps,t=>n.samples[t.sampleIndex].isKeyFrame&&t.presentationTimestamp<=e);(0,d.vA)(-1!==o),r=n.presentationTimestamps[o].sampleIndex,i=e<n.endTimestamp}return{fragmentIndex:a,sampleIndex:r,correctSampleFound:i}}async performFragmentedLookup(e,t,a,r){let i=this.internalTrack.demuxer,s=await i.fragmentLookupMutex.acquire();try{let{fragmentIndex:s,sampleIndex:n,correctSampleFound:o}=e();if(o){let e=this.internalTrack.fragments[s];return this.fetchPacketInFragment(e,n,r)}let c=i.metadataReader,l=await c.reader.source.getSize(),u=null,m=s,f=n,p=this.internalTrack.fragmentLookupTable?(0,d.eE)(this.internalTrack.fragmentLookupTable,t,e=>e.timestamp):-1,g=-1!==p?this.internalTrack.fragmentLookupTable[p]:null,k=!1;if(-1===s)c.pos=g?.moofOffset??0,k=0===c.pos;else{let e=this.internalTrack.fragments[s];!g||e.moofOffset>=g.moofOffset?(c.pos=e.moofOffset+e.moofSize,u=e):c.pos=g.moofOffset}for(;c.pos<l;){if(u){let e=u.trackData.get(this.internalTrack.id);if(e&&e.startTimestamp>a)break;if(u.nextFragment){c.pos=u.nextFragment.moofOffset+u.nextFragment.moofSize,u=u.nextFragment;continue}}await c.reader.loadRange(c.pos,c.pos+h.Xk);let t=c.pos,s=c.readBoxHeader();if("moof"===s.name){let a;let s=(0,d.pl)(i.fragments,t,e=>e.moofOffset);-1===s?(c.pos=t,a=await i.readFragment()):a=i.fragments[s],u&&(u.nextFragment=a),u=a,k&&(a.isKnownToBeFirstFragment=!0,k=!1);let{fragmentIndex:n,sampleIndex:o,correctSampleFound:l}=e();if(l){let e=this.internalTrack.fragments[n];return this.fetchPacketInFragment(e,o,r)}-1!==n&&(m=n,f=o)}c.pos=t+s.totalSize}let b=null,w=-1!==m?this.internalTrack.fragments[m]:null;if(w&&(b=await this.fetchPacketInFragment(w,f,r)),!b&&g&&(!w||w.moofOffset<g.moofOffset)){let t=this.internalTrack.fragmentLookupTable[p-1],i=t?.timestamp??-1/0;return this.performFragmentedLookup(e,i,a,r)}return b}finally{s()}}}class p extends f{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{if("vp9"!==this.internalTrack.info.codec||this.internalTrack.info.vp9CodecInfo){if("av1"===this.internalTrack.info.codec&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&(0,s.UU)(e.data)}}else{let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&(0,s.bs)(e.data)}return{codec:(0,i.QP)(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class g extends f{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:(0,i.X0)(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}let k=(e,t)=>{if(e.presentationTimestamps){let a=(0,d.eE)(e.presentationTimestamps,t,e=>e.presentationTimestamp);return -1===a?-1:e.presentationTimestamps[a].sampleIndex}{let a=(0,d.eE)(e.sampleTimingEntries,t,e=>e.startDecodeTimestamp);if(-1===a)return -1;let r=e.sampleTimingEntries[a];return r.startIndex+Math.min(Math.floor((t-r.startDecodeTimestamp)/r.delta),r.count-1)}},b=(e,t)=>{let a=(0,d.eE)(e.sampleTimingEntries,t,e=>e.startIndex),r=e.sampleTimingEntries[a];if(!r||r.startIndex+r.count<=t)return null;let i=r.startDecodeTimestamp+(t-r.startIndex)*r.delta,s=(0,d.eE)(e.sampleCompositionTimeOffsets,t,e=>e.startIndex),n=e.sampleCompositionTimeOffsets[s];n&&t-n.startIndex<n.count&&(i+=n.offset);let o=e.sampleSizes[Math.min(t,e.sampleSizes.length-1)],c=(0,d.eE)(e.sampleToChunk,t,e=>e.startSampleIndex),l=e.sampleToChunk[c];(0,d.vA)(l);let u=l.startChunkIndex+Math.floor((t-l.startSampleIndex)/l.samplesPerChunk),h=e.chunkOffsets[u],m=l.startSampleIndex+(u-l.startChunkIndex)*l.samplesPerChunk,f=0,p=h;if(1===e.sampleSizes.length)p+=o*(t-m),f+=o*l.samplesPerChunk;else for(let a=m;a<m+l.samplesPerChunk;a++){let r=e.sampleSizes[a];a<t&&(p+=r),f+=r}let g=r.delta;if(e.presentationTimestamps){let a=e.presentationTimestampIndexMap[t];(0,d.vA)(void 0!==a),a<e.presentationTimestamps.length-1&&(g=e.presentationTimestamps[a+1].presentationTimestamp-i)}return{presentationTimestamp:i,duration:g,sampleOffset:p,sampleSize:o,chunkOffset:h,chunkSize:f,isKeyFrame:!e.keySampleIndices||-1!==(0,d.pl)(e.keySampleIndices,t,e=>e)}},w=(e,t)=>{if(!e.keySampleIndices)return t;let a=(0,d.eE)(e.keySampleIndices,t,e=>e);return e.keySampleIndices[a]??-1},T=(e,t)=>{if(!e.keySampleIndices)return t+1;let a=(0,d.eE)(e.keySampleIndices,t,e=>e);return e.keySampleIndices[a+1]??-1},y=(e,t)=>{for(let a of(e.startTimestamp+=t,e.endTimestamp+=t,e.samples))a.presentationTimestamp+=t;for(let a of e.presentationTimestamps)a.presentationTimestamp+=t},S=e=>{let[t,,,a]=e,r=Math.hypot(t,a);return-(180/Math.PI*Math.atan2(a/r,t/r))},C=e=>0===e.sampleSizes.length;var v=a(605850),x=a(566783);!function(e){e[e.None=0]="None",e[e.Xiph=1]="Xiph",e[e.FixedSize=2]="FixedSize",e[e.Ebml=3]="Ebml"}(r||(r={}));let I=[{id:v.Cl.SeekHead,flag:"seekHeadSeen"},{id:v.Cl.Info,flag:"infoSeen"},{id:v.Cl.Tracks,flag:"tracksSeen"},{id:v.Cl.Cues,flag:"cuesSeen"}];class P extends n.B{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentCueTime=null,this.isWebM=!1,this.metadataReader=new v.q0(e._mainReader),this.clusterReader=new v.q0(new l.m(e.source,0x4000000))}async computeDuration(){let e=await this.getTracks();return Math.max(0,...await Promise.all(e.map(e=>e.computeDuration())))}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(e=>e.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),t=await Promise.all(e.map(e=>e.getCodecParameterString()));return(0,x.V)({isWebM:this.isWebM,hasVideo:this.segments.some(e=>e.tracks.some(e=>e.info?.type==="video")),hasAudio:this.segments.some(e=>e.tracks.some(e=>e.info?.type==="audio")),codecStrings:t.filter(Boolean)})}readMetadata(){return this.readMetadataPromise??=(async()=>{this.metadataReader.pos=0;let e=await this.input.source.getSize();for(;this.metadataReader.pos<=e-v.De;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+v.r1);let t=this.metadataReader.readElementHeader();if(!t)break;let a=t.id,r=t.size,i=this.metadataReader.pos;if(a===v.Cl.EBML)(0,v.p)(r),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+r),this.readContiguousElements(this.metadataReader,r);else if(a===v.Cl.Segment){if(await this.readSegment(r),null===r)break}else if(a===v.Cl.Cluster){null===r&&(r=(await this.clusterReader.searchForNextElementId(v.K9,e)??e)-i);let t=(0,d._g)(this.segments);t&&(t.elementEndPos=i+r)}(0,v.p)(r),this.metadataReader.pos=i+r}})()}async readSegment(e){let t=this.metadataReader.pos;this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:t,elementEndPos:null===e?await this.input.source.getSize():t+e,clusterSeekStartPos:t,clusters:[],clusterLookupMutex:new d.aD},this.segments.push(this.currentSegment),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+16384);let a=!1;for(;this.metadataReader.pos<=this.currentSegment.elementEndPos-v.De;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+v.r1);let e=this.metadataReader.pos,t=this.metadataReader.readElementHeader();if(!t)break;let{id:r,size:i}=t,s=this.metadataReader.pos,n=I.findIndex(e=>e.id===r);if(-1!==n){let e=I[n].flag;this.currentSegment[e]=!0,(0,v.p)(i),await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+i),this.readContiguousElements(this.metadataReader,i)}else r!==v.Cl.Cluster||a||(a=!0,this.currentSegment.clusterSeekStartPos=e);if(this.currentSegment.infoSeen&&this.currentSegment.tracksSeen&&this.currentSegment.cuesSeen)break;if(this.currentSegment.seekHeadSeen){let e=this.currentSegment.infoSeen,t=this.currentSegment.tracksSeen,a=this.currentSegment.cuesSeen;for(let r of this.currentSegment.seekEntries)r.id===v.Cl.Info?e=!0:r.id===v.Cl.Tracks?t=!0:r.id===v.Cl.Cues&&(a=!0);if(e&&t&&a)break}if(null===i)break;this.metadataReader.pos=s+i,a||(this.currentSegment.clusterSeekStartPos=this.metadataReader.pos)}for(let e of I){if(this.currentSegment[e.flag])continue;let a=this.currentSegment.seekEntries.find(t=>t.id===e.id);if(!a)continue;this.metadataReader.pos=t+a.segmentPosition,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+4096);let r=this.metadataReader.readElementHeader();if(!r)continue;let{id:i,size:s}=r;i===e.id&&((0,v.p)(s),this.currentSegment[e.flag]=!0,await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+s),this.readContiguousElements(this.metadataReader,s))}-1===this.currentSegment.timestampScale&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e3),this.currentSegment.tracks.sort((e,t)=>Number(t.isDefault)-Number(e.isDefault)),this.currentSegment.cuePoints.sort((e,t)=>e.clusterPosition-t.clusterPosition);let r=this.currentSegment.tracks.map(e=>e.id),i=new Set,s=null,n=null;for(let e of this.currentSegment.cuePoints){if(e.clusterPosition!==s){for(let e of i)(0,d.vA)(n),this.currentSegment.tracks.find(t=>t.id===e).cuePoints.push(n);for(let e of r)i.add(e)}n=e,i.has(e.trackId)&&(this.currentSegment.tracks.find(t=>t.id===e.trackId).cuePoints.push(e),i.delete(e.trackId),s=e.clusterPosition)}for(let e of i)(0,d.vA)(n),this.currentSegment.tracks.find(t=>t.id===e).cuePoints.push(n);for(let e of this.currentSegment.tracks)e.cuePoints.sort((e,t)=>e.time-t.time);this.currentSegment=null}async readCluster(e){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+v.r1);let t=this.metadataReader.pos,a=this.metadataReader.readElementHeader();(0,d.vA)(a);let i=a.id,s=a.size,n=this.metadataReader.pos;null===s&&(this.clusterReader.pos=n,s=(await this.clusterReader.searchForNextElementId(v.K9,e.elementEndPos)??e.elementEndPos)-n),(0,d.vA)(i===v.Cl.Cluster),this.clusterReader.pos=n,await this.clusterReader.reader.loadRange(this.clusterReader.pos,this.clusterReader.pos+s);let o={elementStartPos:t,elementEndPos:n+s,dataStartPos:n,timestamp:-1,trackData:new Map,nextCluster:null,isKnownToBeFirstCluster:!1};for(let[t,a]of(this.currentCluster=o,this.readContiguousElements(this.clusterReader,s),o.trackData)){let i=e.tracks.find(e=>e.id===t)??null;(0,d.vA)(a.blocks.length>0);let s=!1,n=!1;for(let e=0;e<a.blocks.length;e++){let t=a.blocks[e];t.timestamp+=o.timestamp,s||=t.referencedTimestamps.length>0,n||=t.lacing!==r.None}s&&(a.blocks=B(a.blocks)),a.presentationTimestamps=a.blocks.map((e,t)=>({timestamp:e.timestamp,blockIndex:t})).sort((e,t)=>e.timestamp-t.timestamp);for(let e=0;e<a.presentationTimestamps.length;e++){let t=a.presentationTimestamps[e],s=a.blocks[t.blockIndex];if(null===a.firstKeyFrameTimestamp&&s.isKeyFrame&&(a.firstKeyFrameTimestamp=s.timestamp),e<a.presentationTimestamps.length-1){let t=a.presentationTimestamps[e+1];s.duration=t.timestamp-s.timestamp}else 0===s.duration&&i?.defaultDuration!=null&&s.lacing===r.None&&(s.duration=i.defaultDuration)}n&&(this.expandLacedBlocks(a.blocks,i),a.presentationTimestamps=a.blocks.map((e,t)=>({timestamp:e.timestamp,blockIndex:t})).sort((e,t)=>e.timestamp-t.timestamp));let c=a.blocks[a.presentationTimestamps[0].blockIndex],l=a.blocks[(0,d._g)(a.presentationTimestamps).blockIndex];a.startTimestamp=c.timestamp,a.endTimestamp=l.timestamp+l.duration,i&&((0,d.h8)(i.clusters,o,e=>e.elementStartPos),null!==a.firstKeyFrameTimestamp&&(0,d.h8)(i.clustersWithKeyFrame,o,e=>e.elementStartPos))}return(0,d.h8)(e.clusters,o,e=>e.elementStartPos),this.currentCluster=null,o}getTrackDataInCluster(e,t){let a=e.trackData.get(t);return a||(a={startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,a)),a}expandLacedBlocks(e,t){for(let a=0;a<e.length;a++){let i=e[a];if(i.lacing===r.None)continue;let s=i.data,n=0,o=[],c=s[0]+1;switch(n++,i.lacing){case r.Xiph:{let e=0;for(let t=0;t<c-1;t++){let t=0;for(;n<s.length;){let a=s[n];if(t+=a,n++,a<255){o.push(t),e+=t;break}}}o.push(s.length-(n+e))}break;case r.FixedSize:{let e=Math.floor((s.length-1)/c);for(let t=0;t<c;t++)o.push(e)}break;case r.Ebml:{let e=(0,v.pT)(s,n),t=e.value;o.push(t),n+=e.width;let a=t;for(let e=1;e<c-1;e++){let e=(0,v.pT)(s,n);t+=e.value-((1<<7*e.width-1)-1),o.push(t),n+=e.width,a+=t}o.push(s.length-(n+a))}break;default:(0,d.vA)(!1)}(0,d.vA)(o.length===c),e.splice(a,1);let l=n;for(let n=0;n<c;n++){let d=o[n],u=s.subarray(l,l+d),h=i.duration||c*(t?.defaultDuration??0),m=i.timestamp+h*n/c,f=h/c;e.splice(a+n,0,{timestamp:m,duration:f,isKeyFrame:i.isKeyFrame,referencedTimestamps:i.referencedTimestamps,data:u,lacing:r.None}),l+=d}a+=c,a--}}readContiguousElements(e,t){let a=e.pos;for(;e.pos-a<=t-v.De&&this.traverseElement(e););}traverseElement(e){let t=e.readElementHeader();if(!t)return!1;let{id:a,size:r}=t,i=e.pos;switch((0,v.p)(r),a){case v.Cl.DocType:this.isWebM="webm"===e.readAsciiString(r);break;case v.Cl.Seek:{if(!this.currentSegment)break;let t={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(t),this.readContiguousElements(e,r),(-1===t.id||-1===t.segmentPosition)&&this.currentSegment.seekEntries.pop()}break;case v.Cl.SeekID:{let t=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!t)break;t.id=e.readUnsignedInt(r)}break;case v.Cl.SeekPosition:{let t=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!t)break;t.segmentPosition=e.readUnsignedInt(r)}break;case v.Cl.TimestampScale:if(!this.currentSegment)break;this.currentSegment.timestampScale=e.readUnsignedInt(r),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale;break;case v.Cl.Duration:if(!this.currentSegment)break;this.currentSegment.duration=e.readFloat(r);break;case v.Cl.TrackEntry:if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusters:[],clustersWithKeyFrame:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,languageCode:d.IR,info:null},this.readContiguousElements(e,r),this.currentTrack&&-1!==this.currentTrack.id&&this.currentTrack.codecId&&this.currentTrack.info){let e=this.currentTrack.codecId.indexOf("/"),t=-1===e?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,e);if("video"===this.currentTrack.info.type&&-1!==this.currentTrack.info.width&&-1!==this.currentTrack.info.height){this.currentTrack.codecId===v.oo.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===v.oo.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):t===v.oo.vp8?this.currentTrack.info.codec="vp8":t===v.oo.vp9?this.currentTrack.info.codec="vp9":t===v.oo.av1&&(this.currentTrack.info.codec="av1");let e=this.currentTrack,a=new o.N0(new A(e));this.currentTrack.inputTrack=a,this.currentSegment.tracks.push(this.currentTrack)}else if("audio"===this.currentTrack.info.type&&-1!==this.currentTrack.info.numberOfChannels&&-1!==this.currentTrack.info.sampleRate){t===v.oo.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===v.oo.mp3?this.currentTrack.info.codec="mp3":t===v.oo.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):t===v.oo.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):t===v.oo.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):"A_PCM/INT/LIT"===this.currentTrack.codecId?8===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-u8":16===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-s16":24===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-s24":32===this.currentTrack.info.bitDepth&&(this.currentTrack.info.codec="pcm-s32"):"A_PCM/INT/BIG"===this.currentTrack.codecId?8===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-u8":16===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-s16be":24===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-s24be":32===this.currentTrack.info.bitDepth&&(this.currentTrack.info.codec="pcm-s32be"):"A_PCM/FLOAT/IEEE"===this.currentTrack.codecId&&(32===this.currentTrack.info.bitDepth?this.currentTrack.info.codec="pcm-f32":64===this.currentTrack.info.bitDepth&&(this.currentTrack.info.codec="pcm-f64"));let e=this.currentTrack,a=new o.Yi(new R(e));this.currentTrack.inputTrack=a,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null;break;case v.Cl.TrackNumber:if(!this.currentTrack)break;this.currentTrack.id=e.readUnsignedInt(r);break;case v.Cl.TrackType:{if(!this.currentTrack)break;let t=e.readUnsignedInt(r);1===t?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null}:2===t&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case v.Cl.FlagEnabled:if(!this.currentTrack)break;e.readUnsignedInt(r)||(this.currentSegment.tracks.pop(),this.currentTrack=null);break;case v.Cl.FlagDefault:if(!this.currentTrack)break;this.currentTrack.isDefault=!!e.readUnsignedInt(r);break;case v.Cl.CodecID:if(!this.currentTrack)break;this.currentTrack.codecId=e.readAsciiString(r);break;case v.Cl.CodecPrivate:if(!this.currentTrack)break;this.currentTrack.codecPrivate=e.readBytes(r);break;case v.Cl.DefaultDuration:if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*e.readUnsignedInt(r)/1e9;break;case v.Cl.Language:if(!this.currentTrack)break;this.currentTrack.languageCode=e.readAsciiString(r),(0,d.Nu)(this.currentTrack.languageCode)||(this.currentTrack.languageCode=d.IR);break;case v.Cl.Video:if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e,r);break;case v.Cl.PixelWidth:if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=e.readUnsignedInt(r);break;case v.Cl.PixelHeight:if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=e.readUnsignedInt(r);break;case v.Cl.Colour:if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e,r);break;case v.Cl.MatrixCoefficients:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let t=e.readUnsignedInt(r),a=d.fl[t]??null;this.currentTrack.info.colorSpace.matrix=a}break;case v.Cl.Range:if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=2===e.readUnsignedInt(r);break;case v.Cl.TransferCharacteristics:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let t=e.readUnsignedInt(r),a=d.x_[t]??null;this.currentTrack.info.colorSpace.transfer=a}break;case v.Cl.Primaries:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let t=e.readUnsignedInt(r),a=d.BL[t]??null;this.currentTrack.info.colorSpace.primaries=a}break;case v.Cl.Projection:if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e,r);break;case v.Cl.ProjectionPoseRoll:{if(this.currentTrack?.info?.type!=="video")break;let t=e.readFloat(r);try{this.currentTrack.info.rotation=(0,d.qT)(-t)}catch{}}break;case v.Cl.Audio:if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e,r);break;case v.Cl.SamplingFrequency:if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=e.readFloat(r);break;case v.Cl.Channels:if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=e.readUnsignedInt(r);break;case v.Cl.BitDepth:if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=e.readUnsignedInt(r);break;case v.Cl.CuePoint:if(!this.currentSegment)break;this.readContiguousElements(e,r),this.currentCueTime=null;break;case v.Cl.CueTime:this.currentCueTime=e.readUnsignedInt(r);break;case v.Cl.CueTrackPositions:{if(null===this.currentCueTime)break;(0,d.vA)(this.currentSegment);let t={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(t),this.readContiguousElements(e,r),(-1===t.trackId||-1===t.clusterPosition)&&this.currentSegment.cuePoints.pop()}break;case v.Cl.CueTrack:{let t=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!t)break;t.trackId=e.readUnsignedInt(r)}break;case v.Cl.CueClusterPosition:{let t=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!t)break;(0,d.vA)(this.currentSegment),t.clusterPosition=this.currentSegment.dataStartPos+e.readUnsignedInt(r)}break;case v.Cl.Timestamp:if(!this.currentCluster)break;this.currentCluster.timestamp=e.readUnsignedInt(r);break;case v.Cl.SimpleBlock:{if(!this.currentCluster)break;let t=e.readVarInt();if(null===t)break;let a=e.readS16(),s=e.readU8();this.getTrackDataInCluster(this.currentCluster,t).blocks.push({timestamp:a,duration:0,isKeyFrame:!!(128&s),referencedTimestamps:[],data:e.readBytes(r-(e.pos-i)),lacing:s>>1&3})}break;case v.Cl.BlockGroup:if(!this.currentCluster)break;if(this.readContiguousElements(e,r),this.currentBlock){for(let e=0;e<this.currentBlock.referencedTimestamps.length;e++)this.currentBlock.referencedTimestamps[e]+=this.currentBlock.timestamp;this.currentBlock=null}break;case v.Cl.Block:{if(!this.currentCluster)break;let t=e.readVarInt();if(null===t)break;let a=e.readS16(),s=e.readU8(),n=this.getTrackDataInCluster(this.currentCluster,t);this.currentBlock={timestamp:a,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:e.readBytes(r-(e.pos-i)),lacing:s>>1&3},n.blocks.push(this.currentBlock)}break;case v.Cl.BlockDuration:if(!this.currentBlock)break;this.currentBlock.duration=e.readUnsignedInt(r);break;case v.Cl.ReferenceBlock:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let t=e.readSignedInt(r);this.currentBlock.referencedTimestamps.push(t)}}return e.pos=i+r,!0}}class E{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw Error("Not implemented on base class.")}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){let e=await this.getFirstPacket({metadataOnly:!0});return e?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(()=>{let e=this.internalTrack.segment.clusters[0]??null;if(e?.isKnownToBeFirstCluster){let t=e;for(;t;){if(t.trackData.get(this.internalTrack.id))return{clusterIndex:(0,d.pl)(this.internalTrack.clusters,t.elementStartPos,e=>e.elementStartPos),blockIndex:0,correctBlockFound:!0};t=t.nextCluster}}return{clusterIndex:-1,blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,e)}intoTimescale(e){return(0,d.CR)(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let a=this.intoTimescale(e);return this.performClusterLookup(()=>this.findBlockInClustersForTimestamp(a),a,a,t)}async getNextPacket(e,t){let a=this.packetToClusterLocation.get(e);if(void 0===a)throw Error("Packet was not created from this track.");let r=a.cluster.trackData.get(this.internalTrack.id),i=(0,d.pl)(this.internalTrack.clusters,a.cluster.elementStartPos,e=>e.elementStartPos);return(0,d.vA)(-1!==i),this.performClusterLookup(()=>{if(a.blockIndex+1<r.blocks.length)return{clusterIndex:i,blockIndex:a.blockIndex+1,correctBlockFound:!0};{let e=a.cluster;for(;e.nextCluster;)if((e=e.nextCluster).trackData.get(this.internalTrack.id)){let t=(0,d.pl)(this.internalTrack.clusters,e.elementStartPos,e=>e.elementStartPos);return(0,d.vA)(-1!==t),{clusterIndex:t,blockIndex:0,correctBlockFound:!0}}return{clusterIndex:i,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,t)}async getKeyPacket(e,t){let a=this.intoTimescale(e);return this.performClusterLookup(()=>this.findKeyBlockInClustersForTimestamp(a),a,a,t)}async getNextKeyPacket(e,t){let a=this.packetToClusterLocation.get(e);if(void 0===a)throw Error("Packet was not created from this track.");let r=a.cluster.trackData.get(this.internalTrack.id),i=(0,d.pl)(this.internalTrack.clusters,a.cluster.elementStartPos,e=>e.elementStartPos);return(0,d.vA)(-1!==i),this.performClusterLookup(()=>{let e=r.blocks.findIndex((e,t)=>e.isKeyFrame&&t>a.blockIndex);if(-1!==e)return{clusterIndex:i,blockIndex:e,correctBlockFound:!0};{let e=a.cluster;for(;e.nextCluster;){let t=(e=e.nextCluster).trackData.get(this.internalTrack.id);if(t&&null!==t.firstKeyFrameTimestamp){let a=(0,d.pl)(this.internalTrack.clusters,e.elementStartPos,e=>e.elementStartPos);(0,d.vA)(-1!==a);let r=t.blocks.findIndex(e=>e.isKeyFrame);return(0,d.vA)(-1!==r),{clusterIndex:a,blockIndex:r,correctBlockFound:!0}}}return{clusterIndex:i,blockIndex:-1,correctBlockFound:!1}}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,a){if(-1===t)return null;let r=e.trackData.get(this.internalTrack.id).blocks[t];(0,d.vA)(r);let i=a.metadataOnly?c.T:r.data,s=r.timestamp/this.internalTrack.segment.timestampFactor,n=r.duration/this.internalTrack.segment.timestampFactor,o=new c.Z(i,r.isKeyFrame?"key":"delta",s,n,e.dataStartPos+t,r.data.byteLength);return this.packetToClusterLocation.set(o,{cluster:e,blockIndex:t}),o}findBlockInClustersForTimestamp(e){let t=(0,d.eE)(this.internalTrack.clusters,e,e=>e.trackData.get(this.internalTrack.id).startTimestamp),a=-1,r=!1;if(-1!==t){let i=this.internalTrack.clusters[t].trackData.get(this.internalTrack.id),s=(0,d.eE)(i.presentationTimestamps,e,e=>e.timestamp);(0,d.vA)(-1!==s),a=i.presentationTimestamps[s].blockIndex,r=e<i.endTimestamp}return{clusterIndex:t,blockIndex:a,correctBlockFound:r}}findKeyBlockInClustersForTimestamp(e){let t=(0,d.eE)(this.internalTrack.clustersWithKeyFrame,e,e=>e.trackData.get(this.internalTrack.id).firstKeyFrameTimestamp),a=-1,r=-1,i=!1;if(-1!==t){let s=this.internalTrack.clustersWithKeyFrame[t];a=(0,d.pl)(this.internalTrack.clusters,s.elementStartPos,e=>e.elementStartPos),(0,d.vA)(-1!==a);let n=s.trackData.get(this.internalTrack.id),o=(0,d.Kl)(n.presentationTimestamps,t=>n.blocks[t.blockIndex].isKeyFrame&&t.timestamp<=e);(0,d.vA)(-1!==o),r=n.presentationTimestamps[o].blockIndex,i=e<n.endTimestamp}return{clusterIndex:a,blockIndex:r,correctBlockFound:i}}async performClusterLookup(e,t,a,r){let{demuxer:i,segment:s}=this.internalTrack,n=await s.clusterLookupMutex.acquire();try{let{clusterIndex:n,blockIndex:o,correctBlockFound:c}=e();if(c){let e=this.internalTrack.clusters[n];return this.fetchPacketInCluster(e,o,r)}let l=i.metadataReader,u=i.clusterReader,h=null,m=n,f=o,p=(0,d.eE)(this.internalTrack.cuePoints,t,e=>e.time),g=-1!==p?this.internalTrack.cuePoints[p]:null,k=!1;if(-1===n)l.pos=g?.clusterPosition??s.clusterSeekStartPos,k=l.pos===s.clusterSeekStartPos;else{let e=this.internalTrack.clusters[n];!g||e.elementStartPos>=g.clusterPosition?(l.pos=e.elementEndPos,h=e):l.pos=g.clusterPosition}for(;l.pos<=s.elementEndPos-v.De;){if(h){let e=h.trackData.get(this.internalTrack.id);if(e&&e.startTimestamp>a)break;if(h.nextCluster){l.pos=h.nextCluster.elementEndPos,h=h.nextCluster;continue}}await l.reader.loadRange(l.pos,l.pos+v.r1);let t=l.pos,n=l.readElementHeader();if(!n)break;let o=n.id,c=n.size,p=l.pos;if(o===v.Cl.Cluster){let a;let n=(0,d.pl)(s.clusters,t,e=>e.elementStartPos);-1===n?(l.pos=t,a=await i.readCluster(s)):a=s.clusters[n],h&&(h.nextCluster=a),h=a,k&&(a.isKnownToBeFirstCluster=!0,k=!1);let{clusterIndex:o,blockIndex:c,correctBlockFound:u}=e();if(u){let e=this.internalTrack.clusters[o];return this.fetchPacketInCluster(e,c,r)}-1!==o&&(m=o,f=c)}if(null===c){o===v.Cl.Cluster?((0,d.vA)(h),c=h.elementEndPos-p):(u.pos=p,c=(await u.searchForNextElementId(v.K9,s.elementEndPos)??s.elementEndPos)-p);let e=p+c;if(e>s.elementEndPos-v.De)break;if(u.pos=e,u.readElementId()===v.Cl.Segment){s.elementEndPos=e;break}}l.pos=p+c}let b=null,w=-1!==m?this.internalTrack.clusters[m]:null;if(w&&(b=await this.fetchPacketInCluster(w,f,r)),!b&&g&&(!w||w.elementStartPos<g.clusterPosition)){let t=this.internalTrack.cuePoints[p-1],i=t?.time??-1/0;return this.performClusterLookup(e,i,a,r)}return b}finally{n()}}}class A extends E{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??=(async()=>{let e=null;return"vp9"!==this.internalTrack.info.codec&&"av1"!==this.internalTrack.info.codec&&("avc"!==this.internalTrack.info.codec||this.internalTrack.info.codecDescription)&&("hevc"!==this.internalTrack.info.codec||this.internalTrack.info.codecDescription)||(e=await this.getFirstPacket({})),{codec:(0,i.QP)({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:"avc"===this.internalTrack.info.codec&&e?(0,s.fH)(e.data):null,hevcCodecInfo:"hevc"===this.internalTrack.info.codec&&e?(0,s.D5)(e.data):null,vp9CodecInfo:"vp9"===this.internalTrack.info.codec&&e?(0,s.bs)(e.data):null,av1CodecInfo:"av1"===this.internalTrack.info.codec&&e?(0,s.UU)(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})():null}}class R extends E{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??={codec:(0,i.X0)({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}:null}}let B=e=>{let t=new Map;for(let a=0;a<e.length;a++){let r=e[a];t.set(r.timestamp,r)}let a=new Set,r=[],i=e=>{if(!a.has(e)){a.add(e);for(let a=0;a<e.referencedTimestamps.length;a++){let r=e.referencedTimestamps[a],s=t.get(r);s&&i(s)}r.push(e)}};for(let t=0;t<e.length;t++)i(e[t]);return r};var _=a(411501);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class F{constructor(e){this.reader=e,this.pos=0,this.fileSize=null}readBytes(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,a,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readAscii(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let r="";for(let i=0;i<e;i++)r+=String.fromCharCode(t.getUint8(a+i));return r}readId3(){return"ID3"!==this.readAscii(3)?(this.pos-=3,null):(this.pos+=3,{size:D(this.readU32())})}readNextFrameHeader(e){for((0,d.vA)(this.fileSize),e??=this.fileSize;this.pos<=e-_.Yq;){let e=this.readU32();this.pos-=4;let t=(0,_.Xg)(e,this);if(t)return t}return null}}let D=e=>{let t=0x7f000000,a=0;for(;0!==t;)a>>=1,a|=e&t,t>>=8;return a};/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class M extends n.B{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.loadingMutex=new d.aD,this.lastLoadedPos=0,this.fileSize=0,this.nextTimestampInSamples=0,this.reader=new F(e._mainReader)}async readMetadata(){return this.metadataPromise??=(async()=>{for(this.fileSize=await this.input.source.getSize(),this.reader.fileSize=this.fileSize;!this.firstFrameHeader&&this.lastLoadedPos<this.fileSize;)await this.loadNextChunk();if(!this.firstFrameHeader)throw Error("No MP3 frames found.");this.tracks=[new o.Yi(new U(this))]})()}async loadNextChunk(){let e=await this.loadingMutex.acquire();try{(0,d.vA)(this.lastLoadedPos<this.fileSize);let e=Math.min(this.lastLoadedPos+524288,this.fileSize);if(await this.reader.reader.loadRange(this.lastLoadedPos,e),this.lastLoadedPos=e,(0,d.vA)(this.lastLoadedPos<=this.fileSize),0===this.reader.pos){let e=this.reader.readId3();e&&(this.reader.pos+=e.size)}this.parseFramesFromLoadedData()}finally{e()}}parseFramesFromLoadedData(){for(;;){let e=this.reader.pos,t=this.reader.readNextFrameHeader();if(!t)break;if(t.startPos+t.totalSize>this.lastLoadedPos){this.reader.pos=e,this.lastLoadedPos=e;break}let a=(0,_.EZ)(t.mpegVersionId,t.channel);this.reader.pos=t.startPos+a;let r=this.reader.readU32(),i=r===_.hY||r===_.rD;if(this.reader.pos=t.startPos+t.totalSize-1,i)continue;this.firstFrameHeader||(this.firstFrameHeader=t);let s=t.audioSamplesInFrame/t.sampleRate,n={timestamp:this.nextTimestampInSamples/t.sampleRate,duration:s,dataStart:t.startPos,dataSize:t.totalSize};this.loadedSamples.push(n),this.nextTimestampInSamples+=t.audioSamplesInFrame}}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return(0,d.vA)(e),e.computeDuration()}}class U{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return(0,d.vA)(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getLanguageCode(){return d.IR}getCodec(){return"mp3"}getNumberOfChannels(){return(0,d.vA)(this.demuxer.firstFrameHeader),3===this.demuxer.firstFrameHeader.channel?1:2}getSampleRate(){return(0,d.vA)(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return(0,d.vA)(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:3===this.demuxer.firstFrameHeader.channel?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}getPacketAtIndex(e,t){let a;if(-1===e)return null;let r=this.demuxer.loadedSamples[e];return r?(t.metadataOnly?a=c.T:(this.demuxer.reader.pos=r.dataStart,a=this.demuxer.reader.readBytes(r.dataSize)),new c.Z(a,"key",r.timestamp,r.duration,e,r.dataSize)):null}async getFirstPacket(e){for(;0===this.demuxer.loadedSamples.length&&this.demuxer.lastLoadedPos<this.demuxer.fileSize;)await this.demuxer.loadNextChunk();return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let a=(0,d.pl)(this.demuxer.loadedSamples,e.timestamp,e=>e.timestamp);if(-1===a)throw Error("Packet was not created from this track.");let r=a+1;for(;r>=this.demuxer.loadedSamples.length&&this.demuxer.lastLoadedPos<this.demuxer.fileSize;)await this.demuxer.loadNextChunk();return this.getPacketAtIndex(r,t)}async getPacket(e,t){for(;;){let a=(0,d.eE)(this.demuxer.loadedSamples,e,e=>e.timestamp);if(-1===a&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastLoadedPos===this.demuxer.fileSize||a>=0&&a+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(a,t);await this.demuxer.loadNextChunk()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}var z=a(606649),O=a(917690);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class V extends n.B{constructor(e){super(e),this.readingMutex=new d.aD,this.metadataPromise=null,this.fileSize=null,this.bitstreams=[],this.tracks=[],this.reader=new O.vC(new l.m(e.source,0x4000000))}async readMetadata(){return this.metadataPromise??=(async()=>{for(this.fileSize=await this.input.source.getSize();this.reader.pos<this.fileSize-O.b0;){await this.reader.reader.loadRange(this.reader.pos,this.reader.pos+O.H9);let e=this.reader.readPageHeader();if(!e||!(2&e.headerType))break;this.bitstreams.push({serialNumber:e.serialNumber,bosPage:e,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),this.reader.pos=e.headerStartPos+e.totalSize}for(let e of this.bitstreams){let t=await this.readPacket(this.reader,e.bosPage,0);t&&(t.data.byteLength>=7&&1===t.data[0]&&118===t.data[1]&&111===t.data[2]&&114===t.data[3]&&98===t.data[4]&&105===t.data[5]&&115===t.data[6]?await this.readVorbisMetadata(t,e):t.data.byteLength>=8&&79===t.data[0]&&112===t.data[1]&&117===t.data[2]&&115===t.data[3]&&72===t.data[4]&&101===t.data[5]&&97===t.data[6]&&100===t.data[7]&&await this.readOpusMetadata(t,e),null!==e.codecInfo.codec&&this.tracks.push(new o.Yi(new W(e,this))))}})()}async readVorbisMetadata(e,t){let a=await this.findNextPacketStart(this.reader,e);if(!a)return;let r=await this.readPacket(this.reader,a.startPage,a.startSegmentIndex);if(!r||!(a=await this.findNextPacketStart(this.reader,r)))return;let i=await this.readPacket(this.reader,a.startPage,a.startSegmentIndex);if(!i||3!==r.data[0]||5!==i.data[0])return;let n=[],o=e=>{for(;n.push(Math.min(255,e)),!(e<255);)e-=255};o(e.data.length),o(r.data.length);let c=new Uint8Array(1+n.length+e.data.length+r.data.length+i.data.length);c[0]=n.length,c.set(n,1),c.set(e.data,1+n.length),c.set(r.data,1+n.length+e.data.length),c.set(i.data,1+n.length+e.data.length+r.data.length),t.codecInfo.codec="vorbis",t.description=c,t.lastMetadataPacket=i;let l=(0,d.Zc)(e.data);t.numberOfChannels=l.getUint8(11),t.sampleRate=l.getUint32(12,!0);let u=l.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(15&u),1<<(u>>4)],modeBlockflags:(0,s.Co)(i.data).modeBlockflags}}async readOpusMetadata(e,t){let a=await this.findNextPacketStart(this.reader,e);if(!a)return;let r=await this.readPacket(this.reader,a.startPage,a.startSegmentIndex);if(!r)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=r;let i=(0,s.Qf)(e.data);t.numberOfChannels=i.outputChannelCount,t.sampleRate=i.inputSampleRate,t.codecInfo.opusInfo={preSkip:i.preSkip}}async readPacket(e,t,a){(0,d.vA)(a<t.lacingValues.length),(0,d.vA)(this.fileSize);let r=0;for(let e=0;e<a;e++)r+=t.lacingValues[e];let i=t,s=r,n=a,o=[];e:for(;;){await e.reader.loadRange(i.dataStartPos,i.dataStartPos+i.dataSize),e.pos=i.dataStartPos;let a=e.readBytes(i.dataSize);for(;;){if(n===i.lacingValues.length){o.push(a.subarray(r,s));break}let e=i.lacingValues[n];if(s+=e,e<255){o.push(a.subarray(r,s));break e}n++}for(;;){if(e.pos=i.headerStartPos+i.totalSize,e.pos>=this.fileSize-O.b0)return null;await e.reader.loadRange(e.pos,e.pos+O.H9);let a=e.readPageHeader();if(!a)return null;if((i=a).serialNumber===t.serialNumber)break}r=0,s=0,n=0}let c=new Uint8Array(o.reduce((e,t)=>e+t.length,0)),l=0;for(let e=0;e<o.length;e++){let t=o[e];c.set(t,l),l+=t.length}return{data:c,endPage:i,endSegmentIndex:n}}async findNextPacketStart(e,t){if((0,d.vA)(null!==this.fileSize),t.endSegmentIndex<t.endPage.lacingValues.length-1)return{startPage:t.endPage,startSegmentIndex:t.endSegmentIndex+1};if(4&t.endPage.headerType)return null;for(e.pos=t.endPage.headerStartPos+t.endPage.totalSize;;){if(e.pos>=this.fileSize-O.b0)return null;await e.reader.loadRange(e.pos,e.pos+O.H9);let a=e.readPageHeader();if(!a)return null;if(a.serialNumber===t.endPage.serialNumber)return{startPage:a,startSegmentIndex:0};e.pos=a.headerStartPos+a.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(e=>e.getCodecParameterString()));return(0,z.Ob)({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks();return Math.max(0,...await Promise.all(e.map(e=>e.computeDuration())))}}class W{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.internalSampleRate="opus"===e.codecInfo.codec?i.cj:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}async getDecoderConfig(){return(0,d.vA)(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getLanguageCode(){return d.IR}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return"opus"===this.bitstream.codecInfo.codec?((0,d.vA)(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,a){if(!e)return null;let{durationInSamples:r,vorbisBlockSize:i}=(0,z.nL)(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),s=new c.Z(a.metadataOnly?c.T:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,r/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(s,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:r,vorbisBlockSize:i}),s}async getFirstPacket(e,t=!0){let a=t?await this.demuxer.readingMutex.acquire():null;try{(0,d.vA)(this.bitstream.lastMetadataPacket);let t=await this.demuxer.findNextPacketStart(this.demuxer.reader,this.bitstream.lastMetadataPacket);if(!t)return null;let a=0;"opus"===this.bitstream.codecInfo.codec&&((0,d.vA)(this.bitstream.codecInfo.opusInfo),a-=this.bitstream.codecInfo.opusInfo.preSkip);let r=await this.demuxer.readPacket(this.demuxer.reader,t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(r,{timestampInSamples:a,vorbisLastBlocksize:null},e)}finally{a?.()}}async getNextPacket(e,t){let a=await this.demuxer.readingMutex.acquire();try{let a=this.encodedPacketToMetadata.get(e);if(!a)throw Error("Packet was not created from this track.");let r=await this.demuxer.findNextPacketStart(this.demuxer.reader,a.packet);if(!r)return null;let i=a.timestampInSamples+a.durationInSamples,s=await this.demuxer.readPacket(this.demuxer.reader,r.startPage,r.startSegmentIndex);return this.createEncodedPacketFromOggPacket(s,{timestampInSamples:i,vorbisLastBlocksize:a.vorbisBlockSize},t)}finally{a()}}async getPacket(e,t){let a=await this.demuxer.readingMutex.acquire();try{let a,r;(0,d.vA)(null!==this.demuxer.fileSize);let i=(0,d.CR)(e*this.internalSampleRate,14);if(0===i)return this.getFirstPacket(t,!1);if(i<0)return null;let s=this.demuxer.reader;(0,d.vA)(this.bitstream.lastMetadataPacket);let n=await this.demuxer.findNextPacketStart(s,this.bitstream.lastMetadataPacket);if(!n)return null;let o=n.startPage,l=this.demuxer.fileSize,u=[o];e:for(;o.headerStartPos+o.totalSize<l;){let e=o.headerStartPos,t=Math.floor((e+l)/2),a=t;for(;;){let e=Math.min(a+O.H4,l-O.b0);if(await s.reader.loadRange(a,e),s.pos=a,!s.findNextPageHeader(e)){l=t+O.b0;continue e}await s.reader.loadRange(s.pos,s.pos+O.H9);let r=s.readPageHeader();(0,d.vA)(r);let n=!1;if(r.serialNumber===this.bitstream.serialNumber)n=!0;else{await s.reader.loadRange(r.headerStartPos,r.headerStartPos+r.totalSize),s.pos=r.headerStartPos;let e=s.readBytes(r.totalSize);n=(0,z._S)(e)===r.checksum}if(!n){a=r.headerStartPos+4;continue}if(n&&r.serialNumber!==this.bitstream.serialNumber||-1===r.granulePosition){a=r.headerStartPos+r.totalSize;continue}this.granulePositionToTimestampInSamples(r.granulePosition)>i?l=r.headerStartPos:(o=r,u.push(r));continue e}}let h=n.startPage;for(let e of u){if(e.granulePosition===o.granulePosition)break;(!h||e.headerStartPos>h.headerStartPos)&&(h=e)}let m=h,f=[m];for(;m.serialNumber!==this.bitstream.serialNumber||m.granulePosition!==o.granulePosition;){s.pos=m.headerStartPos+m.totalSize,await s.reader.loadRange(s.pos,s.pos+O.H9);let e=s.readPageHeader();(0,d.vA)(e),(m=e).serialNumber===this.bitstream.serialNumber&&f.push(m)}(0,d.vA)(-1!==m.granulePosition);let p=null,g=m,k=0;if(m.headerStartPos===n.startPage.headerStartPos)a=this.granulePositionToTimestampInSamples(0),r=!0,p=0;else{a=0,r=!1;for(let e=m.lacingValues.length-1;e>=0;e--)if(m.lacingValues[e]<255){p=e+1;break}if(null===p)throw Error("Invalid page with granule position: no packets end on this page.");k=p-1;let e={data:c.T,endPage:g,endSegmentIndex:k};if(await this.demuxer.findNextPacketStart(s,e)){let e=N(f,m,p);(0,d.vA)(e);let t=L(f,e.page,e.segmentIndex);t&&(m=t.page,p=t.segmentIndex)}else for(;;){let e=N(f,m,p);if(!e)break;let t=L(f,e.page,e.segmentIndex);if(!t)break;if(m=t.page,p=t.segmentIndex,e.page.headerStartPos!==g.headerStartPos){g=e.page,k=e.segmentIndex;break}}}let b=null,w=null;for(;null!==m;){(0,d.vA)(null!==p);let e=await this.demuxer.readPacket(s,m,p);if(!e)break;if(!(m.headerStartPos===n.startPage.headerStartPos&&p<n.startSegmentIndex)){let s=this.createEncodedPacketFromOggPacket(e,{timestampInSamples:a,vorbisLastBlocksize:w?.vorbisBlockSize??null},t);(0,d.vA)(s);let n=this.encodedPacketToMetadata.get(s);if((0,d.vA)(n),r||e.endPage.headerStartPos!==g.headerStartPos||e.endSegmentIndex!==k?a+=n.durationInSamples:(a=this.granulePositionToTimestampInSamples(m.granulePosition),r=!0,s=this.createEncodedPacketFromOggPacket(e,{timestampInSamples:a-n.durationInSamples,vorbisLastBlocksize:w?.vorbisBlockSize??null},t),(0,d.vA)(s),n=this.encodedPacketToMetadata.get(s),(0,d.vA)(n)),b=s,w=n,r&&(Math.max(a,0)>i||Math.max(n.timestampInSamples,0)===i))break}let o=await this.demuxer.findNextPacketStart(s,e);if(!o)break;m=o.startPage,p=o.startSegmentIndex}return b}finally{a()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}let L=(e,t,a)=>{let r=t,i=a;e:for(;;){for(i--;i>=0;i--)if(r.lacingValues[i]<255){i++;break e}if((0,d.vA)(-1===i),!(1&r.headerType)){i=0;break}let t=(0,d.Uk)(e,e=>e.headerStartPos<r.headerStartPos);if(!t)return null;i=(r=t).lacingValues.length}if((0,d.vA)(-1!==i),i===r.lacingValues.length){let t=e[e.indexOf(r)+1];(0,d.vA)(t),r=t,i=0}return{page:r,segmentIndex:i}},N=(e,t,a)=>{if(a>0)return{page:t,segmentIndex:a-1};let r=(0,d.Uk)(e,e=>e.headerStartPos<t.headerStartPos);return r?{page:r,segmentIndex:r.lacingValues.length-1}:null};var H=a(938006),$=a(431121);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class K{}class q extends K{async _getMajorBrand(e){if(await e._mainReader.source.getSize()<12)return null;let t=new h.oj(e._mainReader);return(t.pos=4,"ftyp"!==t.readAscii(4))?null:t.readAscii(4)}_createDemuxer(e){return new m(e)}}class Q extends K{async isSupportedEBMLOfDocType(e,t){if(await e._mainReader.source.getSize()<8)return!1;let a=new v.q0(e._mainReader),r=a.readVarIntSize();if(null===r||r<1||r>8||a.readUnsignedInt(r)!==v.Cl.EBML)return!1;let i=a.readElementSize();if(null===i)return!1;let s=a.pos;for(;a.pos<=s+i-v.De;){let e=a.readElementHeader();if(!e)break;let{id:r,size:i}=e,s=a.pos;if(null===i)return!1;switch(r){case v.Cl.EBMLVersion:case v.Cl.EBMLReadVersion:if(1!==a.readUnsignedInt(i))return!1;break;case v.Cl.DocType:if(a.readAsciiString(i)!==t)return!1;break;case v.Cl.DocTypeVersion:if(a.readUnsignedInt(i)>4)return!1}a.pos=s+i}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new P(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}}let j=new class extends q{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&"qt  "!==t}get name(){return"MP4"}get mimeType(){return"video/mp4"}};new class extends q{async _canReadInput(e){return"qt  "===await this._getMajorBrand(e)}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},new Q,new class extends Q{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},new class extends K{async _canReadInput(e){let t=await e._mainReader.source.getSize();if(t<4)return!1;let a=new F(e._mainReader);a.fileSize=t;let r=a.readId3();r&&(a.pos+=r.size);let i=a.pos;await a.reader.loadRange(a.pos,a.pos+4096);let s=a.readNextFrameHeader(Math.min(i+4096,t));if(!s)return!1;if(r)return!0;a.pos=s.startPos+s.totalSize,await a.reader.loadRange(a.pos,a.pos+_.Yq);let n=a.readNextFrameHeader(a.pos+_.Yq);return!!n&&s.channel===n.channel&&s.sampleRate===n.sampleRate}_createDemuxer(e){return new M(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},new class extends K{async _canReadInput(e){if(await e._mainReader.source.getSize()<12)return!1;let t=new H.H(e._mainReader),a=t.readAscii(4);return("RIFF"===a||"RIFX"===a||"RF64"===a)&&(t.pos=8,"WAVE"===t.readAscii(4))}_createDemuxer(e){return new $.E(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},new class extends K{async _canReadInput(e){return!(await e._mainReader.source.getSize()<4)&&"OggS"===new O.vC(e._mainReader).readAscii(4)}_createDemuxer(e){return new V(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}}},368501:(e,t,a)=>{a.d(t,{Kh:()=>d,N0:()=>c,Yi:()=>l});var r=a(507174),i=a(937036),s=a(582267),n=a(31463),o=a(112863);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class d{constructor(e){this._backing=e}isVideoTrack(){return this instanceof c}isAudioTrack(){return this instanceof l}get id(){return this._backing.getId()}get languageCode(){return this._backing.getLanguageCode()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){let t=new s.kQ(this),a=1/0,r=-1/0,i=0,n=0;for await(let s of t.packets(void 0,void 0,{metadataOnly:!0})){if(i>=e&&s.timestamp>=r)break;a=Math.min(a,s.timestamp),r=Math.max(r,s.timestamp+s.duration),i++,n+=s.byteLength}return{packetCount:i,averagePacketRate:i?Number((i/(r-a)).toPrecision(16)):0,averageBitrate:i?Number((8*n/(r-a)).toPrecision(16)):0}}}class c extends d{constructor(e){super(e),this._backing=e}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180==0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180==0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return"bt2020"===e.primaries||"smpte432"===e.primaries||"pg"===e.transfer||"hlg"===e.transfer||"bt2020-ncl"===e.matrix}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){let e=await this._backing.getDecoderConfig();return e?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();if((0,n.vA)(null!==t),i.wb.some(a=>a.supports(t,e)))return!0;if("undefined"==typeof VideoDecoder)return!1;let a=await VideoDecoder.isConfigSupported(e);return!0===a.supported}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof o.Z))throw TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw TypeError("packet must not be metadata-only to determine its type.");return null===this.codec?null:(0,r.PR)(this,e)}}class l extends d{constructor(e){super(e),this._backing=e}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){let e=await this._backing.getDecoderConfig();return e?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();if((0,n.vA)(null!==t),i.zx.some(a=>a.supports(t,e))||e.codec.startsWith("pcm-"))return!0;{if("undefined"==typeof AudioDecoder)return!1;let t=await AudioDecoder.isConfigSupported(e);return!0===t.supported}}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof o.Z))throw TypeError("packet must be an EncodedPacket.");return null===this.codec?null:"key"}}},279379:(e,t,a)=>{a.d(t,{p:()=>o});var r=a(694009),i=a(31463),s=a(877640),n=a(559222);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class o{constructor(e){if(this._demuxerPromise=null,this._format=null,!e||"object"!=typeof e)throw TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(e=>!(e instanceof r.CW)))throw TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof n.kL))throw TypeError("options.source must be a Source.");this._formats=e.formats,this._source=e.source,this._mainReader=new s.m(e.source)}_getDemuxer(){return this._demuxerPromise??=(async()=>{for(let e of(await this._mainReader.loadRange(0,4096),this._formats))if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw Error("Input has an unsupported or unrecognizable format.")})()}get source(){return this._source}async getFormat(){return await this._getDemuxer(),(0,i.vA)(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(e=>e.isVideoTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(e=>e.isVideoTrack())??null}async getAudioTracks(){return(await this.getTracks()).filter(e=>e.isAudioTrack())}async getPrimaryAudioTrack(){return(await this.getTracks()).find(e=>e.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}}},176793:(e,t,a)=>{a.d(t,{X:()=>r});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=e=>{let t=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isQuickTime?"quicktime":"mp4");if(e.codecStrings.length>0){let a=[...new Set(e.codecStrings)];t+=`; codecs="${a.join(", ")}"`}return t}},669722:(e,t,a)=>{a.d(t,{Xk:()=>i,ZM:()=>r,oj:()=>s});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=8,i=16;class s{constructor(e){this.reader=e,this.pos=0}readBytes(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,a,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,!1)}readI16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readU24(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+3);return this.pos+=3,256*e.getUint16(t,!1)+e.getUint8(t+2)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!1)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!1)}readU64(){return 0x100000000*this.readU32()+this.readU32()}readI64(){return 0x100000000*this.readI32()+this.readU32()}readF64(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+8);return this.pos+=8,e.getFloat64(t,!1)}readFixed_16_16(){return this.readI32()/65536}readFixed_2_30(){return this.readI32()/0x40000000}readAscii(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let r="";for(let i=0;i<e;i++)r+=String.fromCharCode(t.getUint8(a+i));return r}readIsomVariableInteger(){let e=0;for(let t=0;t<4;t++){e<<=7;let t=this.readU8();if(e|=127&t,(128&t)==0)break}return e}readBoxHeader(){let e=this.readU32(),t=this.readAscii(4),a=8;return 1===e&&(e=this.readU64(),a=16),{name:t,totalSize:e,headerSize:a,contentSize:e-a}}}},605850:(e,t,a)=>{var r;a.d(t,{Cl:()=>r,De:()=>h,K9:()=>o,Qn:()=>u,Z4:()=>s,_v:()=>i,oo:()=>p,p:()=>k,pT:()=>g,q0:()=>f,r1:()=>m,ys:()=>n});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{constructor(e){this.value=e}}class s{constructor(e){this.value=e}}class n{constructor(e){this.value=e}}!function(e){e[e.EBML=0x1a45dfa3]="EBML",e[e.EBMLVersion=17030]="EBMLVersion",e[e.EBMLReadVersion=17143]="EBMLReadVersion",e[e.EBMLMaxIDLength=17138]="EBMLMaxIDLength",e[e.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",e[e.DocType=17026]="DocType",e[e.DocTypeVersion=17031]="DocTypeVersion",e[e.DocTypeReadVersion=17029]="DocTypeReadVersion",e[e.SeekHead=0x114d9b74]="SeekHead",e[e.Seek=19899]="Seek",e[e.SeekID=21419]="SeekID",e[e.SeekPosition=21420]="SeekPosition",e[e.Duration=17545]="Duration",e[e.Info=0x1549a966]="Info",e[e.TimestampScale=2807729]="TimestampScale",e[e.MuxingApp=19840]="MuxingApp",e[e.WritingApp=22337]="WritingApp",e[e.Tracks=0x1654ae6b]="Tracks",e[e.TrackEntry=174]="TrackEntry",e[e.TrackNumber=215]="TrackNumber",e[e.TrackUID=29637]="TrackUID",e[e.TrackType=131]="TrackType",e[e.FlagEnabled=185]="FlagEnabled",e[e.FlagDefault=136]="FlagDefault",e[e.FlagForced=21930]="FlagForced",e[e.FlagLacing=156]="FlagLacing",e[e.Language=2274716]="Language",e[e.CodecID=134]="CodecID",e[e.CodecPrivate=25506]="CodecPrivate",e[e.CodecDelay=22186]="CodecDelay",e[e.SeekPreRoll=22203]="SeekPreRoll",e[e.DefaultDuration=2352003]="DefaultDuration",e[e.Video=224]="Video",e[e.PixelWidth=176]="PixelWidth",e[e.PixelHeight=186]="PixelHeight",e[e.Audio=225]="Audio",e[e.SamplingFrequency=181]="SamplingFrequency",e[e.Channels=159]="Channels",e[e.BitDepth=25188]="BitDepth",e[e.Segment=0x18538067]="Segment",e[e.SimpleBlock=163]="SimpleBlock",e[e.BlockGroup=160]="BlockGroup",e[e.Block=161]="Block",e[e.BlockAdditions=30113]="BlockAdditions",e[e.BlockMore=166]="BlockMore",e[e.BlockAdditional=165]="BlockAdditional",e[e.BlockAddID=238]="BlockAddID",e[e.BlockDuration=155]="BlockDuration",e[e.ReferenceBlock=251]="ReferenceBlock",e[e.Cluster=0x1f43b675]="Cluster",e[e.Timestamp=231]="Timestamp",e[e.Cues=0x1c53bb6b]="Cues",e[e.CuePoint=187]="CuePoint",e[e.CueTime=179]="CueTime",e[e.CueTrackPositions=183]="CueTrackPositions",e[e.CueTrack=247]="CueTrack",e[e.CueClusterPosition=241]="CueClusterPosition",e[e.Colour=21936]="Colour",e[e.MatrixCoefficients=21937]="MatrixCoefficients",e[e.TransferCharacteristics=21946]="TransferCharacteristics",e[e.Primaries=21947]="Primaries",e[e.Range=21945]="Range",e[e.Projection=30320]="Projection",e[e.ProjectionType=30321]="ProjectionType",e[e.ProjectionPoseRoll=30325]="ProjectionPoseRoll",e[e.Attachments=0x1941a469]="Attachments",e[e.Chapters=0x1043a770]="Chapters",e[e.Tags=0x1254c367]="Tags"}(r||(r={}));let o=[r.EBML,r.Segment,r.EBMLMaxIDLength,r.EBMLMaxSizeLength,r.SeekHead,r.Info,r.Cluster,r.Tracks,r.Cues,r.Attachments,r.Chapters,r.Tags],d=e=>e<256?1:e<65536?2:e<0x1000000?3:e<0x100000000?4:e<0x10000000000?5:6,c=e=>e>=-64&&e<64?1:e>=-8192&&e<8192?2:e>=-1048576&&e<1048576?3:e>=-0x8000000&&e<0x8000000?4:e>=-0x400000000&&e<0x400000000?5:6,l=e=>{if(e<127)return 1;if(e<16383)return 2;if(e<2097151)return 3;if(e<0xfffffff)return 4;if(e<0x800000000-1)return 5;if(e<0x40000000000-1)return 6;throw Error("EBML varint size not supported "+e)};class u{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=d(e)){let a=0;switch(t){case 6:this.helperView.setUint8(a++,e/0x10000000000|0);case 5:this.helperView.setUint8(a++,e/0x100000000|0);case 4:this.helperView.setUint8(a++,e>>24);case 3:this.helperView.setUint8(a++,e>>16);case 2:this.helperView.setUint8(a++,e>>8);case 1:this.helperView.setUint8(a++,e);break;default:throw Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,a))}writeSignedInt(e,t=c(e)){e<0&&(e+=2**(8*t)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=l(e)){let a=0;switch(t){case 1:this.helperView.setUint8(a++,128|e);break;case 2:this.helperView.setUint8(a++,64|e>>8),this.helperView.setUint8(a++,e);break;case 3:this.helperView.setUint8(a++,32|e>>16),this.helperView.setUint8(a++,e>>8),this.helperView.setUint8(a++,e);break;case 4:this.helperView.setUint8(a++,16|e>>24),this.helperView.setUint8(a++,e>>16),this.helperView.setUint8(a++,e>>8),this.helperView.setUint8(a++,e);break;case 5:this.helperView.setUint8(a++,8|e/0x100000000&7),this.helperView.setUint8(a++,e>>24),this.helperView.setUint8(a++,e>>16),this.helperView.setUint8(a++,e>>8),this.helperView.setUint8(a++,e);break;case 6:this.helperView.setUint8(a++,4|e/0x10000000000&3),this.helperView.setUint8(a++,e/0x100000000|0),this.helperView.setUint8(a++,e>>24),this.helperView.setUint8(a++,e>>16),this.helperView.setUint8(a++,e>>8),this.helperView.setUint8(a++,e);break;default:throw Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,a))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(e=>e.charCodeAt(0))))}writeEBML(e){if(null!==e){if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),a=-1===e.size?1:e.size??4;-1===e.size?this.writeByte(255):this.writer.seek(this.writer.getPos()+a);let r=this.writer.getPos();if(this.dataOffsets.set(e,r),this.writeEBML(e.data),-1!==e.size){let e=this.writer.getPos()-r,i=this.writer.getPos();this.writer.seek(t),this.writeVarInt(e,a),this.writer.seek(i)}}else if("number"==typeof e.data){let t=e.size??d(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if("string"==typeof e.data)this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof i)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof s)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof n){let t=e.size??c(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}}}}let h=2,m=16;class f{constructor(e){this.reader=e,this.pos=0}readBytes(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,a,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos++,e.getUint8(t)}readS16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getInt16(t,!1)}readVarIntSize(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),a=e.getUint8(t);if(0===a)return null;let r=1,i=128;for(;(a&i)==0;)r++,i>>=1;return r}readVarInt(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1),a=e.getUint8(t);if(0===a)return null;let r=1,i=128;for(;(a&i)==0;)r++,i>>=1;let{view:s,offset:n}=this.reader.getViewAndOffset(this.pos,this.pos+r),o=a&i-1;for(let e=1;e<r;e++)o*=256,o+=s.getUint8(n+e);return this.pos+=r,o}readUnsignedInt(e){if(e<1||e>8)throw Error("Bad unsigned int size "+e);let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e),r=0;for(let i=0;i<e;i++)r*=256,r+=t.getUint8(a+i);return this.pos+=e,r}readSignedInt(e){let t=this.readUnsignedInt(e);return t&1<<8*e-1&&(t-=2**(8*e)),t}readFloat(e){if(0===e)return 0;if(4!==e&&8!==e)throw Error("Bad float size "+e);let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e),r=4===e?t.getFloat32(a,!1):t.getFloat64(a,!1);return this.pos+=e,r}readAsciiString(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let r=0;for(;r<e&&0!==t.getUint8(a+r);)r+=1;return String.fromCharCode(...new Uint8Array(t.buffer,a,r))}readElementId(){let e=this.readVarIntSize();return null===e?null:this.readUnsignedInt(e)}readElementSize(){let e=this.readU8();return 255===e?e=null:(this.pos--,0x100000000000000===(e=this.readVarInt())&&(e=null)),e}readElementHeader(){let e=this.readElementId();return null===e?null:{id:e,size:this.readElementSize()}}async searchForNextElementId(e,t){let a=new Set(e);for(;this.pos<=t-h;){this.reader.rangeIsLoaded(this.pos,Math.min(this.pos+m,t))||await this.reader.loadRange(this.pos,Math.min(this.pos+1048576,t));let e=this.pos,r=this.readElementHeader();if(!r)break;if(a.has(r.id))return e;k(r.size),this.pos+=r.size}return null}}let p={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"},g=(e,t)=>{if(t>=e.length)throw Error("Offset out of bounds.");let a=e[t],r=1,i=128;for(;(a&i)==0&&r<8;)r++,i>>=1;if(t+r>e.length)throw Error("VarInt extends beyond data bounds.");let s=a&i-1;for(let a=1;a<r;a++)s*=256,s+=e[t+a];return{value:s,width:r}};function k(e){if(null===e)throw Error("Undefined element size is used in a place where it is not supported.")}},566783:(e,t,a)=>{a.d(t,{V:()=>r});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=e=>{let t=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isWebM?"webm":"x-matroska");if(e.codecStrings.length>0){let a=[...new Set(e.codecStrings.filter(Boolean))];t+=`; codecs="${a.join(", ")}"`}return t}},582267:(e,t,a)=>{a.d(t,{kQ:()=>m,lc:()=>b,qw:()=>y});var r=a(308573),i=a(937036),s=a(368501),n=a(31463),o=a(112863),d=a(288619),c=a(702517);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let l=e=>{if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(void 0!==e.metadataOnly&&"boolean"!=typeof e.metadataOnly)throw TypeError("options.metadataOnly, when defined, must be a boolean.");if(void 0!==e.verifyKeyPackets&&"boolean"!=typeof e.verifyKeyPackets)throw TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(e.verifyKeyPackets&&e.metadataOnly)throw TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},u=e=>{if("number"!=typeof e||Number.isNaN(e))throw TypeError("timestamp must be a number.")},h=(e,t,a)=>a.verifyKeyPackets?t.then(async t=>{if(!t||"delta"===t.type)return t;let a=await e.determinePacketType(t);return a&&(t.type=a),t}):t;class m{constructor(e){if(!(e instanceof s.Kh))throw TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){return l(e),h(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){return u(e),l(t),h(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof o.Z))throw TypeError("packet must be an EncodedPacket.");return l(t),h(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(u(e),l(t),!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);let a=await this._track._backing.getKeyPacket(e,t);return a&&"delta"!==a.type&&"delta"===await this._track.determinePacketType(a)?this.getKeyPacket(a.timestamp-1/this._track.timeResolution,t):a}async getNextKeyPacket(e,t={}){if(!(e instanceof o.Z))throw TypeError("packet must be an EncodedPacket.");if(l(t),!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);let a=await this._track._backing.getNextKeyPacket(e,t);return a&&"delta"!==a.type&&"delta"===await this._track.determinePacketType(a)?this.getNextKeyPacket(a,t):a}packets(e,t,a={}){if(void 0!==e&&!(e instanceof o.Z))throw TypeError("startPacket must be an EncodedPacket.");if(void 0!==e&&e.isMetadataOnly&&!a?.metadataOnly)throw TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(void 0!==t&&!(t instanceof o.Z))throw TypeError("endPacket must be an EncodedPacket.");l(a);let r=[],{promise:i,resolve:s}=(0,n.nJ)(),{promise:d,resolve:c}=(0,n.nJ)(),u=!1,h=!1,m=null,f=[],p=()=>Math.max(2,f.length);return(async()=>{let o=e??await this.getFirstPacket(a);for(;o&&!h&&!(t&&o.sequenceNumber>=t?.sequenceNumber);){if(r.length>p()){({promise:d,resolve:c}=(0,n.nJ)()),await d;continue}r.push(o),s(),({promise:i,resolve:s}=(0,n.nJ)()),o=await this.getNextPacket(o,a)}u=!0,s()})().catch(e=>{m||(m=e,s())}),{async next(){for(;;){if(h)return{value:void 0,done:!0};if(m)throw m;if(r.length>0){let e=r.shift(),t=performance.now();for(f.push(t);f.length>0&&t-f[0]>=1e3;)f.shift();return c(),{value:e,done:!1}}if(u)return{value:void 0,done:!0};await i}},return:async()=>(h=!0,c(),s(),{value:void 0,done:!0}),async throw(e){throw e},[Symbol.asyncIterator](){return this}}}}class f{constructor(e,t){this.onSample=e,this.onError=t}}class p{mediaSamplesInRange(e=0,t=1/0){u(e),u(t);let a=[],r=!1,i=null,{promise:s,resolve:o}=(0,n.nJ)(),{promise:d,resolve:c}=(0,n.nJ)(),l=!1,h=!1,m=!1,f=null;return(async()=>{let u;let p=Error(),k=await this._createDecoder(d=>{if(c(),d.timestamp>=t&&(h=!0),h){d.close();return}i&&(d.timestamp>e?(a.push(i),r=!0):i.close()),d.timestamp>=e&&(a.push(d),r=!0),i=r?null:d,a.length>0&&(o(),{promise:s,resolve:o}=(0,n.nJ)())},e=>{f||(e.stack=p.stack,f=e,o())}),b=this._createPacketSink(),w=await b.getKeyPacket(e,{verifyKeyPackets:!0})??await b.getFirstPacket();if(!w)return;let T=w;if(t<1/0){let e=await b.getPacket(t),a=e?"key"===e.type&&e.timestamp===t?e:await b.getNextKeyPacket(e,{verifyKeyPackets:!0}):null;a&&(u=a)}let y=b.packets(w,u);for(await y.next();T&&!h;){let e=g(a.length);if(a.length+k.getDecodeQueueSize()>e){({promise:d,resolve:c}=(0,n.nJ)()),await d;continue}k.decode(T);let t=await y.next();if(t.done)break;T=t.value}await y.return(),m||await k.flush(),k.close(),!r&&i&&a.push(i),l=!0,o()})().catch(e=>{f||(f=e,o())}),{async next(){for(;;){if(m)return{value:void 0,done:!0};if(f)throw f;if(a.length>0){let e=a.shift();return c(),{value:e,done:!1}}if(l)return{value:void 0,done:!0};await s}},async return(){for(let e of(m=!0,h=!0,c(),o(),i?.close(),a))e.close();return{value:void 0,done:!0}},async throw(e){throw e},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){(0,n.D5)(e);let t=(0,n.i1)(e),a=[],r=[],{promise:i,resolve:s}=(0,n.nJ)(),{promise:o,resolve:d}=(0,n.nJ)(),c=!1,l=!1,h=null,m=e=>{r.push(e),s(),{promise:i,resolve:s}=(0,n.nJ)()};return(async()=>{let e=Error(),i=await this._createDecoder(e=>{if(d(),l){e.close();return}let t=0;for(;a.length>0&&e.timestamp-a[0]>-1e-10;)t++,a.shift();if(t>0)for(let a=0;a<t;a++)m(a<t-1?e.clone():e);else e.close()},t=>{h||(t.stack=e.stack,h=t,s())}),f=this._createPacketSink(),p=null,k=null,b=-1,w=async()=>{(0,n.vA)(k);let e=k;for(i.decode(e);e.sequenceNumber<b;){let t=g(r.length);for(;r.length+i.getDecodeQueueSize()>t&&!l;)({promise:o,resolve:d}=(0,n.nJ)()),await o;if(l)break;let a=await f.getNextPacket(e);(0,n.vA)(a),e=a,i.decode(a)}b=-1},T=async()=>{await i.flush();for(let e=0;e<a.length;e++)m(null);a.length=0};for await(let e of t){if(u(e),l)break;let t=await f.getPacket(e),r=t&&await f.getKeyPacket(e,{verifyKeyPackets:!0});if(!r){-1!==b&&(await w(),await T()),m(null),p=null;continue}p&&(r.sequenceNumber!==k.sequenceNumber||t.timestamp<p.timestamp)&&(await w(),await T()),a.push(t.timestamp),b=Math.max(t.sequenceNumber,b),p=t,k=r}l||(-1!==b&&await w(),await T()),i.close(),c=!0,s()})().catch(e=>{h||(h=e,s())}),{async next(){for(;;){if(l)return{value:void 0,done:!0};if(h)throw h;if(r.length>0){let e=r.shift();return(0,n.vA)(void 0!==e),d(),{value:e,done:!1}}if(c)return{value:void 0,done:!0};await i}},async return(){for(let e of(l=!0,d(),s(),r))e?.close();return{value:void 0,done:!0}},async throw(e){throw e},[Symbol.asyncIterator](){return this}}}}let g=e=>0===e?40:8;class k extends f{constructor(e,t,a,r,s,o){super(e,t),this.rotation=s,this.timeResolution=o,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new n.dY,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[];let d=i.wb.find(e=>e.supports(a,r));if(d)this.customDecoder=new d,this.customDecoder.codec=a,this.customDecoder.config=r,this.customDecoder.onSample=e=>{if(!(e instanceof c.U))throw TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(e)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let e=e=>{if((0,n.nr)()){if(this.sampleQueue.length>0&&e.timestamp>=(0,n._g)(this.sampleQueue).timestamp){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}(0,n.h8)(this.sampleQueue,e,e=>e.timestamp)}else{let t=this.inputTimestamps.shift();(0,n.vA)(void 0!==t),e.setTimestamp(t),this.finalizeAndEmitSample(e)}};this.decoder=new VideoDecoder({output:t=>e(new c.U(t)),error:t}),this.decoder.configure(r)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:((0,n.vA)(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):((0,n.vA)(this.decoder),(0,n.nr)()||(0,n.h8)(this.inputTimestamps,e.timestamp,e=>e),this.decoder.decode(e.toEncodedVideoChunk()))}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):((0,n.vA)(this.decoder),await this.decoder.flush()),(0,n.nr)()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}}close(){for(let e of(this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):((0,n.vA)(this.decoder),this.decoder.close()),this.sampleQueue))e.close();this.sampleQueue.length=0}}class b extends p{constructor(e){if(!(e instanceof s.N0))throw TypeError("videoTrack must be an InputVideoTrack.");super(),this._videoTrack=e}async _createDecoder(e,t){if(!await this._videoTrack.canDecode())throw Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let a=this._videoTrack.codec,r=this._videoTrack.rotation,i=await this._videoTrack.getDecoderConfig(),s=this._videoTrack.timeResolution;return(0,n.vA)(a&&i),new k(e,t,a,i,r,s)}_createPacketSink(){return new m(this._videoTrack)}async getSample(e){for await(let t of(u(e),this.mediaSamplesAtTimestamps([e])))return t;throw Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}class w extends f{constructor(e,t,a,r){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new n.dY,this.customDecoderQueueSize=0;let s=t=>{if(0===t.numberOfFrames){t.close();return}let a=r.sampleRate;t.setTimestamp(Math.round(t.timestamp*a)/a),e(t)},o=i.zx.find(e=>e.supports(a,r));o?(this.customDecoder=new o,this.customDecoder.codec=a,this.customDecoder.config=r,this.customDecoder.onSample=e=>{if(!(e instanceof c.B))throw TypeError("The argument passed to onSample must be an AudioSample.");s(e)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:e=>s(new c.B(e)),error:t}),this.decoder.configure(r))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:((0,n.vA)(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):((0,n.vA)(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):((0,n.vA)(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):((0,n.vA)(this.decoder),this.decoder.close())}}class T extends f{constructor(e,t,a){super(e,t),this.decoderConfig=a,this.currentTimestamp=null,(0,n.vA)(r.Wq.includes(a.codec)),this.codec=a.codec;let{dataType:i,sampleSize:s,littleEndian:o}=(0,r.Ei)(this.codec);switch(this.inputSampleSize=s,s){case 1:"unsigned"===i?this.readInputValue=(e,t)=>e.getUint8(t)-128:"signed"===i?this.readInputValue=(e,t)=>e.getInt8(t):"ulaw"===i?this.readInputValue=(e,t)=>(0,d.qS)(e.getUint8(t)):"alaw"===i?this.readInputValue=(e,t)=>(0,d.aw)(e.getUint8(t)):(0,n.vA)(!1);break;case 2:"unsigned"===i?this.readInputValue=(e,t)=>e.getUint16(t,o)-32768:"signed"===i?this.readInputValue=(e,t)=>e.getInt16(t,o):(0,n.vA)(!1);break;case 3:"unsigned"===i?this.readInputValue=(e,t)=>(0,n.dq)(e,t,o)-8388608:"signed"===i?this.readInputValue=(e,t)=>(0,n.Wh)(e,t,o):(0,n.vA)(!1);break;case 4:"unsigned"===i?this.readInputValue=(e,t)=>e.getUint32(t,o)-0x80000000:"signed"===i?this.readInputValue=(e,t)=>e.getInt32(t,o):"float"===i?this.readInputValue=(e,t)=>e.getFloat32(t,o):(0,n.vA)(!1);break;case 8:"float"===i?this.readInputValue=(e,t)=>e.getFloat64(t,o):(0,n.vA)(!1);break;default:(0,n.xb)(s),(0,n.vA)(!1)}switch(s){case 1:"ulaw"===i||"alaw"===i?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(e,t,a)=>e.setInt16(t,a,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(e,t,a)=>e.setUint8(t,a+128));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(e,t,a)=>e.setInt16(t,a,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(e,t,a)=>e.setInt32(t,a<<8,!0);break;case 4:this.outputSampleSize=4,"float"===i?(this.outputFormat="f32",this.writeOutputValue=(e,t,a)=>e.setFloat32(t,a,!0)):(this.outputFormat="s32",this.writeOutputValue=(e,t,a)=>e.setInt32(t,a,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(e,t,a)=>e.setFloat32(t,a,!0);break;default:(0,n.xb)(s),(0,n.vA)(!1)}}getDecodeQueueSize(){return 0}decode(e){let t=(0,n.Zc)(e.data),a=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,r=new ArrayBuffer(a*this.decoderConfig.numberOfChannels*this.outputSampleSize),i=new DataView(r);for(let e=0;e<a*this.decoderConfig.numberOfChannels;e++){let a=e*this.inputSampleSize,r=e*this.outputSampleSize,s=this.readInputValue(t,a);this.writeOutputValue(i,r,s)}let s=a/this.decoderConfig.sampleRate;(null===this.currentTimestamp||Math.abs(e.timestamp-this.currentTimestamp)>=s)&&(this.currentTimestamp=e.timestamp);let o=this.currentTimestamp;this.currentTimestamp+=s;let d=new c.B({format:this.outputFormat,data:r,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:a,timestamp:o});this.onSample(d)}async flush(){}close(){}}class y extends p{constructor(e){if(!(e instanceof s.Yi))throw TypeError("audioTrack must be an InputAudioTrack.");super(),this._audioTrack=e}async _createDecoder(e,t){if(!await this._audioTrack.canDecode())throw Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let a=this._audioTrack.codec,i=await this._audioTrack.getDecoderConfig();return((0,n.vA)(a&&i),r.Wq.includes(i.codec))?new T(e,t,i):new w(e,t,a,i)}_createPacketSink(){return new m(this._audioTrack)}async getSample(e){for await(let t of(u(e),this.mediaSamplesAtTimestamps([e])))return t;throw Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}}},818009:(e,t,a)=>{a.d(t,{$b:()=>l,Fl:()=>m,Ii:()=>k,_8:()=>b,uC:()=>f});var r=a(308573),i=a(31463);a(894894);var s=a(288619),n=a(937036),o=a(112863),d=a(702517);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class c{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw Error("Source is not connected to an output track.");if("canceled"===this._connectedTrack.output.state)throw Error("Output has been canceled.");if("finalizing"===this._connectedTrack.output.state||"finalized"===this._connectedTrack.output.state)throw Error("Output has been finalized.");if("pending"===this._connectedTrack.output.state)throw Error("Output has not started.");if(this._closed)throw Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw Error("Cannot call close without connecting the source to an output track.");if("pending"===e.output.state)throw Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,"finalizing"!==e.output.state&&"finalized"!==e.output.state&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}}class l extends c{constructor(e){if(super(),this._connectedTrack=null,!r.WN.includes(e))throw TypeError(`Invalid video codec '${e}'. Must be one of: ${r.WN.join(", ")}.`);this._codec=e}}let u=e=>{if(!e||"object"!=typeof e)throw TypeError("Encoding config must be an object.");if(!r.WN.includes(e.codec))throw TypeError(`Invalid video codec '${e.codec}'. Must be one of: ${r.WN.join(", ")}.`);if(!(e.bitrate instanceof r.en)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw TypeError("config.bitrate must be a positive integer or a quality.");if(void 0!==e.latencyMode&&!["quality","realtime"].includes(e.latencyMode))throw TypeError("config.latencyMode, when provided, must be 'quality' or 'realtime'.");if(void 0!==e.keyFrameInterval&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(void 0!==e.fullCodecString&&"string"!=typeof e.fullCodecString)throw TypeError("config.fullCodecString, when provided, must be a string.");if(void 0!==e.fullCodecString&&(0,r.oU)(e.fullCodecString)!==e.codec)throw TypeError(`config.fullCodecString, when provided, must be a string that matches the specified codec (${e.codec}).`);if(void 0!==e.onEncodedPacket&&"function"!=typeof e.onEncodedPacket)throw TypeError("config.onEncodedChunk, when provided, must be a function.");if(void 0!==e.onEncoderConfig&&"function"!=typeof e.onEncoderConfig)throw TypeError("config.onEncoderConfig, when provided, must be a function.")};class h{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.lastWidth=null,this.lastHeight=null,this.customEncoder=null,this.customEncoderCallSerializer=new i.dY,this.customEncoderQueueSize=0,this.encoderError=null}async add(e,t,a){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),null!==this.lastWidth&&null!==this.lastHeight){if(e.codedWidth!==this.lastWidth||e.codedHeight!==this.lastHeight)throw Error(`Video sample size must remain constant. Expected ${this.lastWidth}x${this.lastHeight}, got ${e.codedWidth}x${e.codedHeight}.`)}else this.lastWidth=e.codedWidth,this.lastHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),(0,i.vA)(this.encoderInitialized);let r=this.encodingConfig.keyFrameInterval??5,s=Math.floor(e.timestamp/r),n={...a,keyFrame:a?.keyFrame||0===r||s!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=s,this.customEncoder){this.customEncoderQueueSize++;let t=e.clone(),a=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(t,n)).then(()=>this.customEncoderQueueSize--).catch(e=>this.encoderError??=e).finally(()=>{t.close()});this.customEncoderQueueSize>=4&&await a}else{(0,i.vA)(this.encoder);let a=e.toVideoFrame();this.encoder.encode(a,n),a.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(e=>this.encoder.addEventListener("dequeue",e,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}async ensureEncoder(e){if(!this.encoder)return this.ensureEncoderPromise=(async()=>{let t=e.codedWidth,a=e.codedHeight,s=this.encodingConfig.bitrate instanceof r.en?this.encodingConfig.bitrate._toVideoBitrate(this.encodingConfig.codec,t,a):this.encodingConfig.bitrate,d={codec:this.encodingConfig.fullCodecString??(0,r.j7)(this.encodingConfig.codec,t,a,s),width:t,height:a,bitrate:s,framerate:this.source._connectedTrack?.metadata.frameRate,latencyMode:this.encodingConfig.latencyMode,...(0,r.Rc)(this.encodingConfig.codec)};this.encodingConfig.onEncoderConfig?.(d);let c=n.WE.find(e=>e.supports(this.encodingConfig.codec,d));if(c)this.customEncoder=new c,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=d,this.customEncoder.onPacket=(e,t)=>{if(!(e instanceof o.Z))throw TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(void 0!==t&&(!t||"object"!=typeof t))throw TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(e,t),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,e,t)},await this.customEncoder.init();else{if("undefined"==typeof VideoEncoder)throw Error("VideoEncoder is not supported by this browser.");if(!(await VideoEncoder.isConfigSupported(d)).supported)throw Error(`This specific encoder configuration (${d.codec}, ${d.bitrate} bps, ${d.width}x${d.height}) is not supported by this browser. Consider using another codec or changing your video parameters.`);this.encoder=new VideoEncoder({output:(e,t)=>{let a=o.Z.fromEncodedChunk(e);this.encodingConfig.onEncodedPacket?.(a,t),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,a,t)},error:e=>{e.stack=Error().stack,this.encoderError??=e}}),this.encoder.configure(d)}(0,i.vA)(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.close()),this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError}}class m extends l{constructor(e){u(e),super(e.codec),this._encoder=new h(this,e)}add(e,t){if(!(e instanceof d.U))throw TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class f extends c{constructor(e){if(super(),this._connectedTrack=null,!r.PP.includes(e))throw TypeError(`Invalid audio codec '${e}'. Must be one of: ${r.PP.join(", ")}.`);this._codec=e}}let p=e=>{if(!e||"object"!=typeof e)throw TypeError("Encoding config must be an object.");if(!r.PP.includes(e.codec))throw TypeError(`Invalid audio codec '${e.codec}'. Must be one of: ${r.PP.join(", ")}.`);if(void 0===e.bitrate&&(!r.Wq.includes(e.codec)||"flac"===e.codec))throw TypeError("config.bitrate must be provided for compressed audio codecs.");if(void 0!==e.bitrate&&!(e.bitrate instanceof r.en)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(void 0!==e.fullCodecString&&"string"!=typeof e.fullCodecString)throw TypeError("config.fullCodecString, when provided, must be a string.");if(void 0!==e.fullCodecString&&(0,r.oU)(e.fullCodecString)!==e.codec)throw TypeError(`config.fullCodecString, when provided, must be a string that matches the specified codec (${e.codec}).`);if(void 0!==e.onEncodedPacket&&"function"!=typeof e.onEncodedPacket)throw TypeError("config.onEncodedChunk, when provided, must be a function.");if(void 0!==e.onEncoderConfig&&"function"!=typeof e.onEncoderConfig)throw TypeError("config.onEncoderConfig, when provided, must be a function.")};class g{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new i.dY,this.customEncoderQueueSize=0,this.encoderError=null}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),null!==this.lastNumberOfChannels&&null!==this.lastSampleRate){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),(0,i.vA)(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let t=e.clone(),a=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(t)).then(()=>this.customEncoderQueueSize--).catch(e=>this.encoderError??=e).finally(()=>{t.close()});this.customEncoderQueueSize>=4&&await a,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{(0,i.vA)(this.encoder);let a=e.toAudioData();this.encoder.encode(a),a.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(e=>this.encoder.addEventListener("dequeue",e,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){(0,i.vA)(this.outputSampleSize),(0,i.vA)(this.writeOutputValue);let{numberOfChannels:a,numberOfFrames:r,sampleRate:s,timestamp:n}=e,d=[];for(let t=0;t<r;t+=2048){let r=Math.min(2048,e.numberOfFrames-t),i=new DataView(new ArrayBuffer(r*a*this.outputSampleSize));d.push({frameCount:r,view:i})}let c=new Float32Array(e.allocationSize({planeIndex:0,format:"f32-planar"})/Float32Array.BYTES_PER_ELEMENT);for(let t=0;t<a;t++){e.copyTo(c,{planeIndex:t,format:"f32-planar"});for(let e=0;e<d.length;e++){let{frameCount:r,view:i}=d[e];for(let s=0;s<r;s++)this.writeOutputValue(i,(s*a+t)*this.outputSampleSize,c[2048*e+s])}}t&&e.close();let l={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:a,sampleRate:s}};for(let e=0;e<d.length;e++){let{frameCount:t,view:a}=d[e],r=a.buffer,i=2048*e,c=new o.Z(new Uint8Array(r),"key",n+i/s,t/s);this.encodingConfig.onEncodedPacket?.(c,l),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,c,l)}}ensureEncoder(e){if(!this.encoderInitialized)return this.ensureEncoderPromise=(async()=>{let{numberOfChannels:t,sampleRate:a}=e,s=this.encodingConfig.bitrate instanceof r.en?this.encodingConfig.bitrate._toAudioBitrate(this.encodingConfig.codec):this.encodingConfig.bitrate,d={codec:this.encodingConfig.fullCodecString??(0,r.KZ)(this.encodingConfig.codec,t,a),numberOfChannels:t,sampleRate:a,bitrate:s,...(0,r.IJ)(this.encodingConfig.codec)};this.encodingConfig.onEncoderConfig?.(d);let c=n.Lr.find(e=>e.supports(this.encodingConfig.codec,d));if(c)this.customEncoder=new c,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=d,this.customEncoder.onPacket=(e,t)=>{if(!(e instanceof o.Z))throw TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(void 0!==t&&(!t||"object"!=typeof t))throw TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(e,t),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,e,t)},await this.customEncoder.init();else if(r.Wq.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if("undefined"==typeof AudioEncoder)throw Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(d)).supported)throw Error(`This specific encoder configuration (${d.codec}, ${d.bitrate} bps, ${d.numberOfChannels} channels, ${d.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(e,t)=>{let a=o.Z.fromEncodedChunk(e);this.encodingConfig.onEncodedPacket?.(a,t),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,a,t)},error:e=>{e.stack=Error().stack,this.encoderError??=e}}),this.encoder.configure(d)}(0,i.vA)(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:a,littleEndian:n}=(0,r.Ei)(e);switch(this.outputSampleSize=a,a){case 1:"unsigned"===t?this.writeOutputValue=(e,t,a)=>e.setUint8(t,(0,i.qE)((a+1)*127.5,0,255)):"signed"===t?this.writeOutputValue=(e,t,a)=>{e.setInt8(t,(0,i.qE)(Math.round(128*a),-128,127))}:"ulaw"===t?this.writeOutputValue=(e,t,a)=>{let r=(0,i.qE)(Math.floor(32767*a),-32768,32767);e.setUint8(t,(0,s.vX)(r))}:"alaw"===t?this.writeOutputValue=(e,t,a)=>{let r=(0,i.qE)(Math.floor(32767*a),-32768,32767);e.setUint8(t,(0,s.xq)(r))}:(0,i.vA)(!1);break;case 2:"unsigned"===t?this.writeOutputValue=(e,t,a)=>e.setUint16(t,(0,i.qE)((a+1)*32767.5,0,65535),n):"signed"===t?this.writeOutputValue=(e,t,a)=>e.setInt16(t,(0,i.qE)(Math.round(32767*a),-32768,32767),n):(0,i.vA)(!1);break;case 3:"unsigned"===t?this.writeOutputValue=(e,t,a)=>(0,i.jD)(e,t,(0,i.qE)((a+1)*8388607.5,0,0xffffff),n):"signed"===t?this.writeOutputValue=(e,t,a)=>(0,i.iP)(e,t,(0,i.qE)(Math.round(8388607*a),-8388608,8388607),n):(0,i.vA)(!1);break;case 4:"unsigned"===t?this.writeOutputValue=(e,t,a)=>e.setUint32(t,(0,i.qE)((a+1)*2147483647.5,0,0xffffffff),n):"signed"===t?this.writeOutputValue=(e,t,a)=>e.setInt32(t,(0,i.qE)(Math.round(0x7fffffff*a),-0x80000000,0x7fffffff),n):"float"===t?this.writeOutputValue=(e,t,a)=>e.setFloat32(t,a,n):(0,i.vA)(!1);break;case 8:"float"===t?this.writeOutputValue=(e,t,a)=>e.setFloat64(t,a,n):(0,i.vA)(!1);break;default:(0,i.xb)(a),(0,i.vA)(!1)}}async flushAndClose(e){this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.close()),this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.encoderError)throw this.encoderError}}class k extends f{constructor(e){p(e),super(e.codec),this._encoder=new g(this,e)}add(e){if(!(e instanceof d.B))throw TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class b extends c{constructor(e){if(super(),this._connectedTrack=null,!r.VW.includes(e))throw TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${r.VW.join(", ")}.`);this._codec=e}}},31463:(e,t,a)=>{/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */function r(e){if(!e)throw Error("Assertion failed.")}a.d(t,{Ai:()=>R,Au:()=>w,BL:()=>g,Br:()=>v,CR:()=>H,D5:()=>D,Fo:()=>u,G8:()=>G,HV:()=>y,IP:()=>d,IR:()=>N,KA:()=>Z,Kl:()=>_,MW:()=>j,Nu:()=>Q,OO:()=>c,P5:()=>x,SM:()=>S,UG:()=>m,Uk:()=>B,Wh:()=>z,Wo:()=>l,Zc:()=>h,_c:()=>o,_g:()=>s,_j:()=>W,aD:()=>C,al:()=>K,b_:()=>X,dY:()=>Y,dq:()=>U,eE:()=>P,fl:()=>T,h8:()=>E,i1:()=>F,iP:()=>V,in:()=>$,jD:()=>O,nJ:()=>A,nr:()=>ee,pl:()=>I,qE:()=>L,qT:()=>i,uN:()=>k,vA:()=>r,vv:()=>n,wd:()=>p,x_:()=>b,xb:()=>M});let i=e=>{let t=(e%360+360)%360;if(0===t||90===t||180===t||270===t)return t;throw Error(`Invalid rotation ${e}.`)},s=e=>e&&e[e.length-1],n=e=>e>=0&&e<0x100000000;class o{constructor(e){this.bytes=e,this.pos=0}seekToByte(e){this.pos=8*e}readBit(){let e=Math.floor(this.pos/8),t=this.bytes[e]??0,a=7-(7&this.pos);return this.pos++,(t&1<<a)>>a}readBits(e){if(1===e)return this.readBit();let t=0;for(let a=0;a<e;a++)t<<=1,t|=this.readBit();return t}readAlignedByte(){if(this.pos%8!=0)throw Error("Bitstream is not byte-aligned.");let e=this.pos/8,t=this.bytes[e]??0;return this.pos+=8,t}skipBits(e){this.pos+=e}getBitsLeft(){return 8*this.bytes.length-this.pos}clone(){let e=new o(this.bytes);return e.pos=this.pos,e}}let d=e=>{let t=0;for(;0===e.readBits(1)&&t<32;)t++;if(t>=32)throw Error("Invalid exponential-Golomb code.");return(1<<t)-1+e.readBits(t)},c=e=>{let t=d(e);return(1&t)==0?-(t>>1):t+1>>1},l=(e,t,a,r)=>{for(let i=t;i<a;i++){let t=Math.floor(i/8),s=e[t],n=7-(7&i);s&=~(1<<n),s|=(r&1<<a-i-1)>>a-i-1<<n,e[t]=s}},u=e=>e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength),h=e=>e instanceof DataView?e:e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),m=new TextEncoder,f=e=>Object.fromEntries(Object.entries(e).map(([e,t])=>[t,e])),p={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},g=f(p),k={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pg:16,hlg:18},b=f(k),w={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},T=f(w),y=e=>!!e&&!!e.primaries&&!!e.transfer&&!!e.matrix&&void 0!==e.fullRange,S=e=>e instanceof ArrayBuffer||"undefined"!=typeof SharedArrayBuffer&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e);class C{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e;let t=new Promise(t=>{e=t}),a=this.currentPromise;return this.currentPromise=t,await a,e}}let v=e=>[...e].map(e=>e.toString(16).padStart(2,"0")).join(""),x=e=>(e=(e=(e=(e=(e=e>>1&0x55555555|(0x55555555&e)<<1)>>2&0x33333333|(0x33333333&e)<<2)>>4&0xf0f0f0f|(0xf0f0f0f&e)<<4)>>8&0xff00ff|(0xff00ff&e)<<8)>>16&65535|(65535&e)<<16)>>>0,I=(e,t,a)=>{let r=0,i=e.length-1,s=-1;for(;r<=i;){let n=r+i>>1,o=a(e[n]);o===t?(s=n,i=n-1):o<t?r=n+1:i=n-1}return s},P=(e,t,a)=>{let r=0,i=e.length-1,s=-1;for(;r<=i;){let n=r+(i-r+1)/2|0;a(e[n])<=t?(s=n,r=n+1):i=n-1}return s},E=(e,t,a)=>{let r=P(e,a(t),a);e.splice(r+1,0,t)},A=()=>{let e,t;return{promise:new Promise((a,r)=>{e=a,t=r}),resolve:e,reject:t}},R=(e,t)=>{let a=e.indexOf(t);-1!==a&&e.splice(a,1)},B=(e,t)=>{for(let a=e.length-1;a>=0;a--)if(t(e[a]))return e[a]},_=(e,t)=>{for(let a=e.length-1;a>=0;a--)if(t(e[a]))return a;return -1},F=async function*(e){Symbol.iterator in e?yield*e[Symbol.iterator]():yield*e[Symbol.asyncIterator]()},D=e=>{if(!(Symbol.iterator in e)&&!(Symbol.asyncIterator in e))throw TypeError("Argument must be an iterable or async iterable.")},M=e=>{throw Error(`Unexpected value: ${e}`)},U=(e,t,a)=>{let r=e.getUint8(t),i=e.getUint8(t+1),s=e.getUint8(t+2);return a?r|i<<8|s<<16:r<<16|i<<8|s},z=(e,t,a)=>U(e,t,a)<<8>>8,O=(e,t,a,r)=>{a>>>=0,a&=0xffffff,r?(e.setUint8(t,255&a),e.setUint8(t+1,a>>>8&255),e.setUint8(t+2,a>>>16&255)):(e.setUint8(t,a>>>16&255),e.setUint8(t+1,a>>>8&255),e.setUint8(t+2,255&a))},V=(e,t,a,r)=>{(a=L(a,-8388608,8388607))<0&&(a=a+0x1000000&0xffffff),O(e,t,a,r)},W=(e,t,a,r)=>{r?(e.setUint32(t+0,a,!0),e.setInt32(t+4,Math.floor(a/0x100000000),!0)):(e.setInt32(t+0,Math.floor(a/0x100000000),!0),e.setUint32(t+4,a,!0))},L=(e,t,a)=>Math.max(t,Math.min(a,e)),N="und",H=(e,t)=>{let a=10**t;return Math.round(e*a)/a},$=(e,t)=>Math.round(e/t)*t,K=e=>{let t=0;for(;e;)t++,e>>=1;return t},q=/^[a-z]{3}$/,Q=e=>q.test(e),j=1e6*(1+Number.EPSILON),Z=(e,t)=>{let a={...e};for(let r in t)"object"==typeof e[r]&&null!==e[r]&&"object"==typeof t[r]&&null!==t[r]?a[r]=Z(e[r],t[r]):a[r]=t[r];return a},G=async(e,t,a)=>{let r=0;for(;;)try{return await fetch(e,t)}catch(t){let e=a(++r);if(null===e)throw t;if(console.error("Retrying failed fetch. Error:",t),!Number.isFinite(e)||e<0)throw TypeError("Retry delay must be a non-negative finite number.");e>0&&await new Promise(t=>setTimeout(t,1e3*e))}},X=(e,t)=>{let a=e<0?-1:1,r=0,i=1,s=1,n=0,o=e=Math.abs(e);for(;;){let e=Math.floor(o),a=e*s+r,d=e*n+i;if(d>t||(r=s,i=n,s=a,n=d,!isFinite(o=1/(o-e))))break}return{numerator:a*s,denominator:n}};class Y{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}}let J=null,ee=()=>{if(null!==J)return J;let e=!!("undefined"!=typeof navigator&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return J=e,e}},606649:(e,t,a)=>{a.d(t,{Ob:()=>c,Zk:()=>s,_S:()=>o,nL:()=>d});var r=a(507174),i=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let s=0x5367674f,n=new Uint32Array(256);for(let e=0;e<256;e++){let t=e<<24;for(let e=0;e<8;e++)t=0x80000000&t?t<<1^0x4c11db7:t<<1;n[e]=t>>>0&0xffffffff}let o=e=>{let t=(0,i.Zc)(e),a=t.getUint32(22,!0);t.setUint32(22,0,!0);let r=0;for(let t=0;t<e.length;t++)r=(r<<8^n[r>>>24^e[t]])>>>0;return t.setUint32(22,a,!0),r},d=(e,t,a)=>{let s=0,n=null;if(e.length>0){if("vorbis"===t.codec){(0,i.vA)(t.vorbisInfo);let r=t.vorbisInfo.modeBlockflags.length,o=(1<<(0,i.al)(r-1))-1<<1,d=(e[0]&o)>>1;if(d>=t.vorbisInfo.modeBlockflags.length)throw Error("Invalid mode number.");let c=a,l=t.vorbisInfo.modeBlockflags[d];if(n=t.vorbisInfo.blocksizes[l],1===l){let a=e[0]&(1|o)+1?1:0;c=t.vorbisInfo.blocksizes[a]}s=null!==c?c+n>>2:0}else"opus"===t.codec&&(s=(0,r.ls)(e).durationInSamples)}return{durationInSamples:s,vorbisBlockSize:n}},c=e=>{let t="audio/ogg";if(e.codecStrings){let a=[...new Set(e.codecStrings)];t+=`; codecs="${a.join(", ")}"`}return t}},917690:(e,t,a)=>{a.d(t,{H4:()=>n,H9:()=>s,b0:()=>i,vC:()=>o});var r=a(606649);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let i=27,s=282,n=65307;class o{constructor(e){this.reader=e,this.pos=0}readBytes(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,a,e)}readU8(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+1);return this.pos+=1,e.getUint8(t)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,!0)}readI32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getInt32(t,!0)}readI64(){let e=this.readU32();return 0x100000000*this.readI32()+e}readAscii(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let r="";for(let i=0;i<e;i++)r+=String.fromCharCode(t.getUint8(a+i));return r}readPageHeader(){let e=this.pos;if(this.readU32()!==r.Zk)return null;this.pos+=1;let t=this.readU8(),a=this.readI64(),i=this.readU32(),s=this.readU32(),n=this.readU32(),o=this.readU8(),d=new Uint8Array(o);for(let e=0;e<o;e++)d[e]=this.readU8();let c=27+o,l=d.reduce((e,t)=>e+t,0);return{headerStartPos:e,totalSize:c+l,dataStartPos:e+c,dataSize:l,headerType:t,granulePosition:a,serialNumber:i,sequenceNumber:s,checksum:n,lacingValues:d}}findNextPageHeader(e){for(;this.pos<e-3;){let e=this.readU32(),t=255&e,a=e>>>8&255,i=e>>>16&255,s=e>>>24&255;if(79===t||79===a||79===i||79===s){if(this.pos-=4,e===r.Zk)return!0;this.pos+=1}}return!1}}},136691:(e,t,a)=>{a.d(t,{fE:()=>ej,si:()=>eQ,$y:()=>eK,wQ:()=>eG});var r=a(308573),i=a(31463),s=a(894894),n=a(507174);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class o{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/0x100000000),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8==7&&this.writer.write(this.helper);e.length%8!=0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let t of e.children)t&&this.writeBox(t);let a=this.writer.getPos(),r=e.size??a-t;this.writer.seek(t),this.writeBoxHeader(e,r),this.writer.seek(a)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);(0,i.vA)(void 0!==t);let a=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(a)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let a of e.children)a&&(t+=this.measureBox(a));return t}}}let d=new Uint8Array(8),c=new DataView(d.buffer),l=e=>[(e%256+256)%256],u=e=>(c.setUint16(0,e,!1),[d[0],d[1]]),h=e=>(c.setInt16(0,e,!1),[d[0],d[1]]),m=e=>(c.setUint32(0,e,!1),[d[1],d[2],d[3]]),f=e=>(c.setUint32(0,e,!1),[d[0],d[1],d[2],d[3]]),p=e=>(c.setInt32(0,e,!1),[d[0],d[1],d[2],d[3]]),g=e=>(c.setUint32(0,Math.floor(e/0x100000000),!1),c.setUint32(4,e,!1),[d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7]]),k=e=>(c.setInt16(0,256*e,!1),[d[0],d[1]]),b=e=>(c.setInt32(0,65536*e,!1),[d[0],d[1],d[2],d[3]]),w=e=>(c.setInt32(0,0x40000000*e,!1),[d[0],d[1],d[2],d[3]]),T=(e,t)=>{let a=[],r=e;do{let e=127&r;r>>=7,a.length>0&&(e|=128),a.push(e),void 0!==t&&t--}while(r>0||t)return a.reverse()},y=(e,t=!1)=>{let a=Array(e.length).fill(null).map((t,a)=>e.charCodeAt(a));return t&&a.push(0),a},S=e=>{let t=null;for(let a of e)(!t||a.timestamp>t.timestamp)&&(t=a);return t},C=e=>{let t=Math.PI/180*e,a=Math.round(Math.cos(t)),r=Math.round(Math.sin(t));return[a,r,0,-r,a,0,0,0,1]},v=C(0),x=e=>[b(e[0]),b(e[1]),w(e[2]),b(e[3]),b(e[4]),w(e[5]),b(e[6]),b(e[7]),w(e[8])],I=(e,t,a)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:a}),P=(e,t,a,r,i)=>I(e,[l(t),m(a),r??[]],i),E=e=>e.isQuickTime?I("ftyp",[y("qt  "),f(512),y("qt  ")]):e.fragmented?I("ftyp",[y("iso5"),f(512),y("iso5"),y("iso6"),y("mp41")]):I("ftyp",[y("isom"),f(512),y("isom"),e.holdsAvc?y("avc1"):[],y("mp41")]),A=e=>({type:"mdat",largeSize:e}),R=(e,t,a=!1)=>I("moov",void 0,[B(t,e),...e.map(e=>_(e,t)),a?eu(e):null]),B=(e,t)=>{let a=eO(Math.max(0,...t.filter(e=>e.samples.length>0).map(e=>{let t=S(e.samples);return t.timestamp+t.duration})),ez),r=Math.max(0,...t.map(e=>e.track.id))+1,s=!(0,i.vv)(e)||!(0,i.vv)(a),n=s?g:f;return P("mvhd",+s,0,[n(e),n(e),f(ez),n(a),b(1),k(1),Array(10).fill(0),x(v),Array(24).fill(0),f(r)])},_=(e,t)=>I("trak",void 0,[F(e,t),D(e,t)]),F=(e,t)=>{let a;let r=S(e.samples),s=eO(r?r.timestamp+r.duration:0,ez),n=!(0,i.vv)(t)||!(0,i.vv)(s),o=n?g:f;return a="video"===e.type?C(e.track.metadata.rotation??0):v,P("tkhd",+n,3,[o(t),o(t),f(e.track.id),f(0),o(s),Array(8).fill(0),u(0),u(e.track.id),k("audio"===e.type?1:0),u(0),x(a),b("video"===e.type?e.info.width:0),b("video"===e.type?e.info.height:0)])},D=(e,t)=>I("mdia",void 0,[M(e,t),O(e),V(e)]),M=(e,t)=>{let a=S(e.samples),r=eO(a?a.timestamp+a.duration:0,e.timescale),s=!(0,i.vv)(t)||!(0,i.vv)(r),n=s?g:f,o=0;for(let t of e.track.metadata.languageCode??i.IR)o<<=5,o+=t.charCodeAt(0)-96;return P("mdhd",+s,0,[n(t),n(t),f(e.timescale),n(r),u(o),u(0)])},U={video:"vide",audio:"soun",subtitle:"text"},z={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},O=e=>P("hdlr",0,0,[y("mhlr"),y(U[e.type]),f(0),f(0),f(0),y(z[e.type],!0)]),V=e=>I("minf",void 0,[W[e.type](),L(),$(e)]),W={video:()=>P("vmhd",0,1,[u(0),u(0),u(0),u(0)]),audio:()=>P("smhd",0,0,[u(0),u(0)]),subtitle:()=>P("nmhd",0,0)},L=()=>I("dinf",void 0,[N()]),N=()=>P("dref",0,0,[f(1)],[H()]),H=()=>P("url ",0,1),$=e=>{let t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(e=>0!==e.sampleCompositionTimeOffset);return I("stbl",void 0,[K(e),ei(e),t?ec(e):null,t?el(e):null,en(e),eo(e),ed(e),es(e)])},K=e=>{let t;if("video"===e.type)t=q(eI[e.track.source._codec],e);else if("audio"===e.type){let a=eE(e.track.source._codec,e.muxer.isQuickTime);(0,i.vA)(a),t=Z(a,e)}else"subtitle"===e.type&&(t=er(eR[e.track.source._codec],e));return(0,i.vA)(t),P("stsd",0,0,[f(1)],[t])},q=(e,t)=>I(e,[Array(6).fill(0),u(1),u(0),u(0),Array(12).fill(0),u(t.info.width),u(t.info.height),f(4718592),f(4718592),f(0),u(1),Array(32).fill(0),u(24),h(65535)],[eP[t.track.source._codec](t),(0,i.HV)(t.info.decoderConfig.colorSpace)?Q(t):null]),Q=e=>I("colr",[y("nclx"),u(i.wd[e.info.decoderConfig.colorSpace.primaries]),u(i.uN[e.info.decoderConfig.colorSpace.transfer]),u(i.Au[e.info.decoderConfig.colorSpace.matrix]),l((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),j=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig,a=t.codec.split("."),r=Number(a[1]),s=Number(a[2]),n=Number(a[3]),o=a[4]?Number(a[4]):1,d=a[8]?Number(a[8]):Number(t.colorSpace?.fullRange??0),c=a[5]?Number(a[5]):t.colorSpace?.primaries?i.wd[t.colorSpace.primaries]:2,h=a[6]?Number(a[6]):t.colorSpace?.transfer?i.uN[t.colorSpace.transfer]:2,m=a[7]?Number(a[7]):t.colorSpace?.matrix?i.Au[t.colorSpace.matrix]:2;return P("vpcC",1,0,[l(r),l(s),l((n<<4)+(o<<1)+d),l(c),l(h),l(m),u(0)])},Z=(e,t)=>{let a=0,i=16;if(r.Wq.includes(t.track.source._codec)){let e=t.track.source._codec,{sampleSize:s}=(0,r.Ei)(e);(i=8*s)>16&&(a=1)}return I(e,0===a?[Array(6).fill(0),u(1),u(a),u(0),f(0),u(t.info.numberOfChannels),u(i),u(0),u(0),u(t.info.sampleRate<65536?t.info.sampleRate:0),u(0)]:[Array(6).fill(0),u(1),u(a),u(0),f(0),u(t.info.numberOfChannels),u(Math.min(i,16)),u(0),u(0),u(t.info.sampleRate<65536?t.info.sampleRate:0),u(0),f(1),f(i/8),f(t.info.numberOfChannels*i/8),f(2)],[eA(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},G=e=>{let t;switch(e.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw Error(`Unhandled audio codec: ${e.track.source._codec}`)}let a=[...l(t),...l(21),...m(0),...f(0),...f(0)];if(e.info.decoderConfig.description){let t=(0,i.Fo)(e.info.decoderConfig.description);a=[...a,...l(5),...T(t.byteLength),...t]}return a=[...u(1),...l(0),...l(4),...T(a.length),...a,...l(6),...l(1),...l(2)],P("esds",0,0,a=[...l(3),...T(a.length),...a])},X=e=>I("wave",void 0,[Y(e),J(e),I("\0\0\0\0")]),Y=e=>I("frma",[y(eE(e.track.source._codec,e.muxer.isQuickTime))]),J=e=>{let{littleEndian:t}=(0,r.Ei)(e.track.source._codec);return I("enda",[u(+t)])},ee=e=>{let t=e.info.numberOfChannels,a=3840,r=e.info.sampleRate,s=0,o=0,d=new Uint8Array(0),c=e.info.decoderConfig?.description;if(c){(0,i.vA)(c.byteLength>=18);let e=(0,i.Fo)(c),l=(0,n.Qf)(e);t=l.outputChannelCount,a=l.preSkip,r=l.inputSampleRate,s=l.outputGain,o=l.channelMappingFamily,l.channelMappingTable&&(d=l.channelMappingTable)}return I("dOps",[l(0),l(t),u(a),f(r),h(s),l(o),...d])},et=e=>{let t=e.info.decoderConfig?.description;return(0,i.vA)(t),P("dfLa",0,0,[...(0,i.Fo)(t).subarray(4)])},ea=e=>{let{littleEndian:t,sampleSize:a}=(0,r.Ei)(e.track.source._codec);return P("pcmC",0,0,[l(+t),l(8*a)])},er=(e,t)=>I(e,[Array(6).fill(0),u(1)],[eB[t.track.source._codec](t)]),ei=e=>P("stts",0,0,[f(e.timeToSampleTable.length),e.timeToSampleTable.map(e=>[f(e.sampleCount),f(e.sampleDelta)])]),es=e=>{if(e.samples.every(e=>"key"===e.type))return null;let t=[...e.samples.entries()].filter(([,e])=>"key"===e.type);return P("stss",0,0,[f(t.length),t.map(([e])=>f(e+1))])},en=e=>P("stsc",0,0,[f(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(e=>[f(e.firstChunk),f(e.samplesPerChunk),f(1)])]),eo=e=>{if("audio"===e.type&&e.info.requiresPcmTransformation){let{sampleSize:t}=(0,r.Ei)(e.track.source._codec);return P("stsz",0,0,[f(t*e.info.numberOfChannels),f(e.samples.reduce((t,a)=>t+eO(a.duration,e.timescale),0))])}return P("stsz",0,0,[f(0),f(e.samples.length),e.samples.map(e=>f(e.size))])},ed=e=>e.finalizedChunks.length>0&&(0,i._g)(e.finalizedChunks).offset>=0x100000000?P("co64",0,0,[f(e.finalizedChunks.length),e.finalizedChunks.map(e=>g(e.offset))]):P("stco",0,0,[f(e.finalizedChunks.length),e.finalizedChunks.map(e=>f(e.offset))]),ec=e=>P("ctts",1,0,[f(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(e=>[f(e.sampleCount),p(e.sampleCompositionTimeOffset)])]),el=e=>{let t=1/0,a=-1/0,r=1/0,s=-1/0;(0,i.vA)(e.compositionTimeOffsetTable.length>0),(0,i.vA)(e.samples.length>0);for(let r=0;r<e.compositionTimeOffsetTable.length;r++){let i=e.compositionTimeOffsetTable[r];t=Math.min(t,i.sampleCompositionTimeOffset),a=Math.max(a,i.sampleCompositionTimeOffset)}for(let t=0;t<e.samples.length;t++){let a=e.samples[t];r=Math.min(r,eO(a.timestamp,e.timescale)),s=Math.max(s,eO(a.timestamp+a.duration,e.timescale))}let n=Math.max(-t,0);return s>=0x80000000?null:P("cslg",0,0,[p(n),p(t),p(a),p(r),p(s)])},eu=e=>I("mvex",void 0,e.map(eh)),eh=e=>P("trex",0,0,[f(e.track.id),f(1),f(0),f(0),f(0)]),em=(e,t)=>I("moof",void 0,[ef(e),...t.map(eg)]),ef=e=>P("mfhd",0,0,[f(e)]),ep=e=>{let t=0,a=0,r="delta"===e.type;return a|=+r,r?t|=1:t|=2,t<<24|a<<16|0},eg=e=>I("traf",void 0,[ek(e),eb(e),ew(e)]),ek=e=>{(0,i.vA)(e.currentChunk);let t=e.currentChunk.samples[1]??e.currentChunk.samples[0],a={duration:t.timescaleUnitsToNextSample,size:t.size,flags:ep(t)};return P("tfhd",0,131128,[f(e.track.id),f(a.duration),f(a.size),f(a.flags)])},eb=e=>((0,i.vA)(e.currentChunk),P("tfdt",1,0,[g(eO(e.currentChunk.startTimestamp,e.timescale))])),ew=e=>{(0,i.vA)(e.currentChunk);let t=e.currentChunk.samples.map(e=>e.timescaleUnitsToNextSample),a=e.currentChunk.samples.map(e=>e.size),r=e.currentChunk.samples.map(ep),s=e.currentChunk.samples.map(t=>eO(t.timestamp-t.decodeTimestamp,e.timescale)),n=new Set(t),o=new Set(a),d=new Set(r),c=new Set(s),l=2===d.size&&r[0]!==r[1],u=n.size>1,h=o.size>1,m=!l&&d.size>1,g=c.size>1||[...c].some(e=>0!==e);return P("trun",1,1|4*+l|256*+u|512*+h|1024*+m|2048*+g,[f(e.currentChunk.samples.length),f(e.currentChunk.offset-e.currentChunk.moofOffset||0),l?f(r[0]):[],e.currentChunk.samples.map((e,i)=>[u?f(t[i]):[],h?f(a[i]):[],m?f(r[i]):[],g?p(s[i]):[]])])},eT=e=>I("mfra",void 0,[...e.map(ey),eS()]),ey=(e,t)=>P("tfra",1,0,[f(e.track.id),f(63),f(e.finalizedChunks.length),e.finalizedChunks.map(a=>[g(eO(a.samples[0].timestamp,e.timescale)),g(a.moofOffset),f(t+1),f(1),f(1)])]),eS=()=>P("mfro",0,0,[f(0)]),eC=()=>I("vtte"),ev=(e,t,a,r,n)=>I("vttc",void 0,[null!==n?I("vsid",[p(n)]):null,null!==a?I("iden",[...i.UG.encode(a)]):null,null!==t?I("ctim",[...i.UG.encode((0,s.ce)(t))]):null,null!==r?I("sttg",[...i.UG.encode(r)]):null,I("payl",[...i.UG.encode(e)])]),ex=e=>I("vtta",[...i.UG.encode(e)]),eI={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},eP={avc:e=>e.info.decoderConfig&&I("avcC",[...(0,i.Fo)(e.info.decoderConfig.description)]),hevc:e=>e.info.decoderConfig&&I("hvcC",[...(0,i.Fo)(e.info.decoderConfig.description)]),vp8:j,vp9:j,av1:e=>I("av1C",(0,r.DC)(e.info.decoderConfig.codec))},eE=(e,t)=>{switch(e){case"aac":case"mp3":case"vorbis":return"mp4a";case"opus":return"Opus";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(e){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":case"pcm-s24be":return"in24";case"pcm-s32":case"pcm-s32be":return"in32";case"pcm-f32":case"pcm-f32be":return"fl32";case"pcm-f64":case"pcm-f64be":return"fl64"}else switch(e){case"pcm-s16":case"pcm-s16be":case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":return"ipcm";case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return"fpcm"}},eA=(e,t)=>{switch(e){case"aac":case"mp3":case"vorbis":return G;case"opus":return ee;case"flac":return et}if(t)switch(e){case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return X}else switch(e){case"pcm-s16":case"pcm-s16be":case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return ea}return null},eR={webvtt:"wvtt"},eB={webvtt:e=>I("vttC",[...i.UG.encode(e.info.config.description)])};/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class e_{constructor(e){this.mutex=new i.aD,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,a){t+=e.source._timestampOffset;let r=this.trackTimestampInfo.get(e);if(!r){if(!a)throw Error("First frame must be a key frame.");r={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,r)}if(t<0)throw Error(`Timestamps must be non-negative (got ${t}s).`);if(a&&(r.maxTimestampBeforeLastKeyFrame=r.maxTimestamp),t<r.maxTimestampBeforeLastKeyFrame)throw Error(`Timestamps cannot be smaller than the highest timestamp of the previous run (a run begins with a key frame and ends right before the next key frame). Got ${t}s, but highest timestamp is ${r.maxTimestampBeforeLastKeyFrame}s.`);return r.maxTimestamp=Math.max(r.maxTimestamp,t),t}}var eF=a(185796),eD=a(831786),eM=a(176793),eU=a(669722);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let ez=1e3,eO=(e,t,a=!0)=>{let r=e*t;return a?Math.round(r):r};class eV extends e_{constructor(e,t){super(e),this.auxTarget=new eD.Sn,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new o(this.auxWriter),this.mdat=null,this.trackDatas=[],this.allTracksKnown=(0,i.nJ)(),this.creationTime=Math.floor(Date.now()/1e3)+0x7c25b080,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new o(this.writer),this.isQuickTime=t instanceof ej;let a=this.writer instanceof eF.p2&&"in-memory";this.fastStart=t._options.fastStart??a,this.isFragmented="fragmented"===this.fastStart,("in-memory"===this.fastStart||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),t=this.output._tracks.some(e=>"video"===e.type&&"avc"===e.source._codec);if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(E({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onFtyp(e,t)}"in-memory"===this.fastStart?this.mdat=A(!1):this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=A(!0),this.boxWriter.writeBox(this.mdat)),await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(e=>"video"===e.type?e.info.decoderConfig.codec:"audio"===e.type?e.info.decoderConfig.codec:({webvtt:"wvtt"})[e.track.source._codec]);return(0,eM.X)({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(e=>"video"===e.type),hasAudio:this.trackDatas.some(e=>"audio"===e.type),codecStrings:e})}getVideoTrackData(e,t,a){let s=this.trackDatas.find(t=>t.track===e);if(s)return s;(0,r.aF)(a),(0,i.vA)(a),(0,i.vA)(a.decoderConfig);let o={...a.decoderConfig};(0,i.vA)(void 0!==o.codedWidth),(0,i.vA)(void 0!==o.codedHeight);let d=!1;if("avc"!==e.source._codec||o.description){if("hevc"===e.source._codec&&!o.description){let e=(0,n.D5)(t.data);if(!e)throw Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");o.description=(0,n.Us)(e),d=!0}}else{let e=(0,n.fH)(t.data);if(!e)throw Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");o.description=(0,n.KU)(e),d=!0}let c=(0,i.b_)(1/(e.metadata.frameRate??57600),1e6).denominator,l={muxer:this,track:e,type:"video",info:{width:o.codedWidth,height:o.codedHeight,decoderConfig:o,requiresAnnexBTransformation:d},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(l),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),l}getAudioTrackData(e,t){let a=this.trackDatas.find(t=>t.track===e);if(a)return a;(0,r.P7)(t),(0,i.vA)(t),(0,i.vA)(t.decoderConfig);let s={muxer:this,track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig,requiresPcmTransformation:!this.isFragmented&&r.Wq.includes(e.source._codec)},timescale:t.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getSubtitleTrackData(e,t){let a=this.trackDatas.find(t=>t.track===e);if(a)return a;(0,r.GL)(t),(0,i.vA)(t),(0,i.vA)(t.config);let s={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}async addEncodedVideoPacket(e,t,a){let r=await this.mutex.acquire();try{let r=this.getVideoTrackData(e,t,a),i=t.data;if(r.info.requiresAnnexBTransformation){let e=(0,n.no)(i);if(!e)throw Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");i=e}let s=this.validateAndNormalizeTimestamp(r.track,t.timestamp,"key"===t.type),o=this.createSampleForTrack(r,i,s,t.duration,t.type);await this.registerSample(r,o)}finally{r()}}async addEncodedAudioPacket(e,t,a){let r=await this.mutex.acquire();try{let r=this.getAudioTrackData(e,a),i=this.validateAndNormalizeTimestamp(r.track,t.timestamp,"key"===t.type),s=this.createSampleForTrack(r,t.data,i,t.duration,t.type);r.info.requiresPcmTransformation&&await this.maybePadWithSilence(r,i),await this.registerSample(r,s)}finally{r()}}async maybePadWithSilence(e,t){let a=(0,i._g)(e.samples),s=a?a.timestamp+a.duration:0,n=t-s,o=eO(n,e.timescale);if(o>0){let{sampleSize:t,silentValue:a}=(0,r.Ei)(e.info.decoderConfig.codec),i=new Uint8Array(t*(o*e.info.numberOfChannels)).fill(a),d=this.createSampleForTrack(e,new Uint8Array(i.buffer),s,n,"key");await this.registerSample(e,d)}}async addSubtitleCue(e,t,a){let r=await this.mutex.acquire();try{let r=this.getSubtitleTrackData(e,a);this.validateAndNormalizeTimestamp(r.track,t.timestamp,!0),"webvtt"===e.source._codec&&(r.cueQueue.push(t),await this.processWebVTTCues(r,t.timestamp))}finally{r()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){let a=new Set([]);for(let r of e.cueQueue)(0,i.vA)(r.timestamp<=t),(0,i.vA)(e.lastCueEndTimestamp<=r.timestamp+r.duration),a.add(Math.max(r.timestamp,e.lastCueEndTimestamp)),a.add(r.timestamp+r.duration);let r=[...a].sort((e,t)=>e-t),n=r[0],o=r[1]??n;if(t<o)break;if(e.lastCueEndTimestamp<n){this.auxWriter.seek(0);let t=eC();this.auxBoxWriter.writeBox(t);let a=this.auxWriter.getSlice(0,this.auxWriter.getPos()),r=this.createSampleForTrack(e,a,e.lastCueEndTimestamp,n-e.lastCueEndTimestamp,"key");await this.registerSample(e,r),e.lastCueEndTimestamp=n}this.auxWriter.seek(0);for(let t=0;t<e.cueQueue.length;t++){let a=e.cueQueue[t];if(a.timestamp>=o)break;s.Fp.lastIndex=0;let r=s.Fp.test(a.text),i=a.timestamp+a.duration,d=e.cueToSourceId.get(a);if(void 0===d&&o<i&&(d=e.nextSourceId++,e.cueToSourceId.set(a,d)),a.notes){let e=ex(a.notes);this.auxBoxWriter.writeBox(e)}let c=ev(a.text,r?n:null,a.identifier??null,a.settings??null,d??null);this.auxBoxWriter.writeBox(c),i===o&&e.cueQueue.splice(t--,1)}let d=this.auxWriter.getSlice(0,this.auxWriter.getPos()),c=this.createSampleForTrack(e,d,n,o-n,"key");await this.registerSample(e,c),e.lastCueEndTimestamp=o}}createSampleForTrack(e,t,a,r,i){return{timestamp:a,decodeTimestamp:a,duration:r,data:t,size:t.byteLength,type:i,timescaleUnitsToNextSample:eO(r,e.timescale)}}processTimestamps(e,t){if(0===e.timestampProcessingQueue.length)return;if("audio"===e.type&&e.info.requiresPcmTransformation){let t=0;for(let a=0;a<e.timestampProcessingQueue.length;a++)t+=eO(e.timestampProcessingQueue[a].duration,e.timescale);if(0===e.timeToSampleTable.length)e.timeToSampleTable.push({sampleCount:t,sampleDelta:1});else{let a=(0,i._g)(e.timeToSampleTable);a.sampleCount+=t}e.timestampProcessingQueue.length=0;return}let a=e.timestampProcessingQueue.map(e=>e.timestamp).sort((e,t)=>e-t);for(let t=0;t<e.timestampProcessingQueue.length;t++){let r=e.timestampProcessingQueue[t];r.decodeTimestamp=a[t],this.isFragmented||null!==e.lastTimescaleUnits||(r.decodeTimestamp=0);let s=eO(r.timestamp-r.decodeTimestamp,e.timescale),n=eO(r.duration,e.timescale);if(null!==e.lastTimescaleUnits){(0,i.vA)(e.lastSample);let t=Math.round(eO(r.decodeTimestamp,e.timescale,!1)-e.lastTimescaleUnits);if((0,i.vA)(t>=0),e.lastTimescaleUnits+=t,e.lastSample.timescaleUnitsToNextSample=t,!this.isFragmented){let a=(0,i._g)(e.timeToSampleTable);if((0,i.vA)(a),1===a.sampleCount){a.sampleDelta=t;let r=e.timeToSampleTable[e.timeToSampleTable.length-2];r&&r.sampleDelta===t&&(r.sampleCount++,e.timeToSampleTable.pop(),a=r)}else a.sampleDelta!==t&&(a.sampleCount--,e.timeToSampleTable.push(a={sampleCount:1,sampleDelta:t}));a.sampleDelta===n?a.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:n});let r=(0,i._g)(e.compositionTimeOffsetTable);(0,i.vA)(r),r.sampleCompositionTimeOffset===s?r.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else e.lastTimescaleUnits=eO(r.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:n}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));e.lastSample=r}if(e.timestampProcessingQueue.length=0,(0,i.vA)(e.lastSample),(0,i.vA)(null!==e.lastTimescaleUnits),void 0!==t&&0===e.lastSample.timescaleUnitsToNextSample){(0,i.vA)("key"===t.type);let a=Math.round(eO(t.timestamp,e.timescale,!1)-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=a}}async registerSample(e,t){"key"===t.type&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){this.isFragmented||e.samples.push(t);let a=!1;if(e.currentChunk){e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);let r=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let i=this.trackDatas.every(a=>{if(e===a)return"key"===t.type;let r=a.sampleQueue[0];return r?"key"===r.type:a.track.source._closed});r>=this.minimumFragmentDuration&&i&&t.timestamp>this.maxWrittenTimestamp&&(a=!0,await this.finalizeFragment())}else a=r>=.5}else a=!0;a&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),(0,i.vA)(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if((0,i.vA)(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if("audio"===e.type&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((t,a)=>t+eO(a.duration,e.timescale),0)),(0===e.compactlyCodedChunkTable.length||(0,i._g)(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),"in-memory"===this.fastStart){e.currentChunk.offset=0;return}for(let t of(e.currentChunk.offset=this.writer.getPos(),e.currentChunk.samples))(0,i.vA)(t.data),this.writer.write(t.data),t.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if((0,i.vA)(this.isFragmented),e||this.allTracksAreKnown())e:for(;;){let t=null,a=1/0;for(let r of this.trackDatas){if(!e&&0===r.sampleQueue.length&&!r.track.source._closed)break e;r.sampleQueue.length>0&&r.sampleQueue[0].timestamp<a&&(t=r,a=r.sampleQueue[0].timestamp)}if(!t)break;let r=t.sampleQueue.shift();await this.addSampleToTrack(t,r)}}async finalizeFragment(e=!0){(0,i.vA)(this.isFragmented);let t=this.nextFragmentNumber++;if(1===t){this.format._options.onMoov&&this.writer.startTrackingWrites();let e=R(this.trackDatas,this.creationTime,!0);if(this.boxWriter.writeBox(e),this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}}let a=this.trackDatas.filter(e=>e.currentChunk),r=em(t,a),s=this.writer.getPos(),n=s+this.boxWriter.measureBox(r),o=n+eU.ZM,d=1/0;for(let e of a){for(let t of(e.currentChunk.offset=o,e.currentChunk.moofOffset=s,e.currentChunk.samples))o+=t.size;d=Math.min(d,e.currentChunk.startTimestamp)}let c=o-n,l=c>=0x100000000;if(l)for(let e of a)e.currentChunk.offset+=eU.Xk-eU.ZM;this.format._options.onMoof&&this.writer.startTrackingWrites();let u=em(t,a);if(this.boxWriter.writeBox(u),this.format._options.onMoof){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoof(e,t,d)}(0,i.vA)(this.writer.getPos()===n),this.format._options.onMdat&&this.writer.startTrackingWrites();let h=A(l);for(let e of(h.size=c,this.boxWriter.writeBox(h),this.writer.seek(n+(l?eU.Xk:eU.ZM)),a))for(let t of e.currentChunk.samples)this.writer.write(t.data),t.data=null;if(this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}for(let e of a)e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk),e.currentChunk=null;e&&await this.writer.flush()}async onTrackClose(e){let t=await this.mutex.acquire();if("subtitle"===e.type&&"webvtt"===e.source._codec){let t=this.trackDatas.find(t=>t.track===e);t&&await this.processWebVTTCues(t,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){let e=await this.mutex.acquire();for(let e of(this.allTracksKnown.resolve(),this.trackDatas))"subtitle"===e.type&&"webvtt"===e.track.source._codec&&await this.processWebVTTCues(e,1/0);if(this.isFragmented){for(let e of(await this.interleaveSamples(!0),this.trackDatas))this.processTimestamps(e);await this.finalizeFragment(!1)}else for(let e of this.trackDatas)this.processTimestamps(e),await this.finalizeCurrentChunk(e);if("in-memory"===this.fastStart){let e;(0,i.vA)(this.mdat);for(let t=0;t<2;t++){let t=R(this.trackDatas,this.creationTime),a=this.boxWriter.measureBox(t);e=this.boxWriter.measureBox(this.mdat);let r=this.writer.getPos()+a+e;for(let t of this.finalizedChunks)for(let{data:a}of(t.offset=r,t.samples))(0,i.vA)(a),r+=a.byteLength,e+=a.byteLength;if(r<0x100000000)break;e>=0x100000000&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let t=R(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(t),this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}for(let t of(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=e,this.boxWriter.writeBox(this.mdat),this.finalizedChunks))for(let e of t.samples)(0,i.vA)(e.data),this.writer.write(e.data),e.data=null;if(this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}}else if(this.isFragmented){let e=this.writer.getPos(),t=eT(this.trackDatas);this.boxWriter.writeBox(t);let a=this.writer.getPos()-e;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(a)}else{(0,i.vA)(this.mdat);let e=this.boxWriter.offsets.get(this.mdat);(0,i.vA)(void 0!==e);let t=this.writer.getPos()-e;if(this.mdat.size=t,this.mdat.largeSize=t>=0x100000000,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}this.format._options.onMoov&&this.writer.startTrackingWrites();let a=R(this.trackDatas,this.creationTime);if(this.boxWriter.writeBox(a),this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}}e()}}var eW=a(605850),eL=a(566783);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let eN="https://github.com/Vanilagy/mediabunny",eH={video:1,audio:2,subtitle:17};class e$ extends e_{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=(0,i.nJ)(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new eW.Qn(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.format._options.appendOnly||this.createSeekHead(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:eW.Cl.EBML,data:[{id:eW.Cl.EBMLVersion,data:1},{id:eW.Cl.EBMLReadVersion,data:1},{id:eW.Cl.EBMLMaxIDLength,data:4},{id:eW.Cl.EBMLMaxSizeLength,data:8},{id:eW.Cl.DocType,data:this.format instanceof eG?"webm":"matroska"},{id:eW.Cl.DocTypeVersion,data:2},{id:eW.Cl.DocTypeReadVersion,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(e,t)}}createSeekHead(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),a=new Uint8Array([22,84,174,107]),r={id:eW.Cl.SeekHead,data:[{id:eW.Cl.Seek,data:[{id:eW.Cl.SeekID,data:e},{id:eW.Cl.SeekPosition,size:5,data:0}]},{id:eW.Cl.Seek,data:[{id:eW.Cl.SeekID,data:t},{id:eW.Cl.SeekPosition,size:5,data:0}]},{id:eW.Cl.Seek,data:[{id:eW.Cl.SeekID,data:a},{id:eW.Cl.SeekPosition,size:5,data:0}]}]};this.seekHead=r}createSegmentInfo(){let e={id:eW.Cl.Duration,data:new eW.Z4(0)};this.segmentDuration=e;let t={id:eW.Cl.Info,data:[{id:eW.Cl.TimestampScale,data:1e6},{id:eW.Cl.MuxingApp,data:eN},{id:eW.Cl.WritingApp,data:eN},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){let e={id:eW.Cl.Tracks,data:[]};for(let t of(this.tracksElement=e,this.trackDatas)){let a=eW.oo[t.track.source._codec];(0,i.vA)(a);let s=0;if("audio"===t.type&&"opus"===t.track.source._codec){s=1e6*80;let e=t.info.decoderConfig.description;if(e){let t=(0,i.Fo)(e);s=Math.round(1e9*((0,n.Qf)(t).preSkip/r.cj))}}e.data.push({id:eW.Cl.TrackEntry,data:[{id:eW.Cl.TrackNumber,data:t.track.id},{id:eW.Cl.TrackUID,data:t.track.id},{id:eW.Cl.TrackType,data:eH[t.type]},{id:eW.Cl.FlagLacing,data:0},{id:eW.Cl.Language,data:t.track.metadata.languageCode??i.IR},{id:eW.Cl.CodecID,data:a},{id:eW.Cl.CodecDelay,data:0},{id:eW.Cl.SeekPreRoll,data:s},"video"===t.type?this.videoSpecificTrackInfo(t):null,"audio"===t.type?this.audioSpecificTrackInfo(t):null,"subtitle"===t.type?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){let{frameRate:t,rotation:a}=e.track.metadata,r=[e.info.decoderConfig.description?{id:eW.Cl.CodecPrivate,data:(0,i.Fo)(e.info.decoderConfig.description)}:null,t?{id:eW.Cl.DefaultDuration,data:1e9/t}:null],s=a?(0,i.qT)(-a):0,n=e.info.decoderConfig.colorSpace;return r.push({id:eW.Cl.Video,data:[{id:eW.Cl.PixelWidth,data:e.info.width},{id:eW.Cl.PixelHeight,data:e.info.height},(0,i.HV)(n)?{id:eW.Cl.Colour,data:[{id:eW.Cl.MatrixCoefficients,data:i.Au[n.matrix]},{id:eW.Cl.TransferCharacteristics,data:i.uN[n.transfer]},{id:eW.Cl.Primaries,data:i.wd[n.primaries]},{id:eW.Cl.Range,data:n.fullRange?2:1}]}:null,s?{id:eW.Cl.Projection,data:[{id:eW.Cl.ProjectionType,data:0},{id:eW.Cl.ProjectionPoseRoll,data:new eW._v((s+180)%360-180)}]}:null]}),r}audioSpecificTrackInfo(e){let t=r.Wq.includes(e.track.source._codec)?(0,r.Ei)(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:eW.Cl.CodecPrivate,data:(0,i.Fo)(e.info.decoderConfig.description)}:null,{id:eW.Cl.Audio,data:[{id:eW.Cl.SamplingFrequency,data:new eW._v(e.info.sampleRate)},{id:eW.Cl.Channels,data:e.info.numberOfChannels},t?{id:eW.Cl.BitDepth,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:eW.Cl.CodecPrivate,data:i.UG.encode(e.info.config.description)}]}createSegment(){let e={id:eW.Cl.Segment,size:this.format._options.appendOnly?-1:6,data:[this.format._options.appendOnly?null:this.seekHead,this.segmentInfo,this.tracksElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(e,t)}}createCues(){this.cues={id:eW.Cl.Cues,data:[]}}get segmentDataOffset(){return(0,i.vA)(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(e=>"video"===e.type?e.info.decoderConfig.codec:"audio"===e.type?e.info.decoderConfig.codec:({webvtt:"wvtt"})[e.track.source._codec]);return(0,eL.V)({isWebM:this.format instanceof eG,hasVideo:this.trackDatas.some(e=>"video"===e.type),hasAudio:this.trackDatas.some(e=>"audio"===e.type),codecStrings:e})}getVideoTrackData(e,t){let a=this.trackDatas.find(t=>t.track===e);if(a)return a;(0,r.aF)(t),(0,i.vA)(t),(0,i.vA)(t.decoderConfig),(0,i.vA)(void 0!==t.decoderConfig.codedWidth),(0,i.vA)(void 0!==t.decoderConfig.codedHeight);let s={track:e,type:"video",info:{width:t.decoderConfig.codedWidth,height:t.decoderConfig.codedHeight,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return"vp9"===e.source._codec?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array((0,r.mD)(s.info.decoderConfig.codec))}:"av1"===e.source._codec&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array((0,r.DC)(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t){let a=this.trackDatas.find(t=>t.track===e);if(a)return a;(0,r.P7)(t),(0,i.vA)(t),(0,i.vA)(t.decoderConfig);let s={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getSubtitleTrackData(e,t){let a=this.trackDatas.find(t=>t.track===e);if(a)return a;(0,r.GL)(t),(0,i.vA)(t),(0,i.vA)(t.config);let s={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}async addEncodedVideoPacket(e,t,a){let r=await this.mutex.acquire();try{let r=this.getVideoTrackData(e,a),s="key"===t.type,n=this.validateAndNormalizeTimestamp(r.track,t.timestamp,s),o=t.duration;void 0!==e.metadata.frameRate&&(n=(0,i.in)(n,1/e.metadata.frameRate),o=(0,i.in)(o,1/e.metadata.frameRate));let d=this.createInternalChunk(t.data,n,o,t.type);"vp9"===e.source._codec&&this.fixVP9ColorSpace(r,d),r.chunkQueue.push(d),await this.interleaveChunks()}finally{r()}}async addEncodedAudioPacket(e,t,a){let r=await this.mutex.acquire();try{let r=this.getAudioTrackData(e,a),i="key"===t.type,s=this.validateAndNormalizeTimestamp(r.track,t.timestamp,i),n=this.createInternalChunk(t.data,s,t.duration,t.type);r.chunkQueue.push(n),await this.interleaveChunks()}finally{r()}}async addSubtitleCue(e,t,a){let r=await this.mutex.acquire();try{let r=this.getSubtitleTrackData(e,a),n=this.validateAndNormalizeTimestamp(r.track,t.timestamp,!0),o=t.text,d=Math.round(1e3*n);s.Fp.lastIndex=0,o=o.replace(s.Fp,e=>{let t=(0,s.cj)(e.slice(1,-1));return`<${(0,s.ce)(t-d)}>`});let c=i.UG.encode(o),l=`${t.settings??""}
${t.identifier??""}
${t.notes??""}`,u=this.createInternalChunk(c,n,t.duration,"key",l.trim()?i.UG.encode(l):null);r.chunkQueue.push(u),await this.interleaveChunks()}finally{r()}}async interleaveChunks(e=!1){if(e||this.allTracksAreKnown()){e:for(;;){let t=null,a=1/0;for(let r of this.trackDatas){if(!e&&0===r.chunkQueue.length&&!r.track.source._closed)break e;r.chunkQueue.length>0&&r.chunkQueue[0].timestamp<a&&(t=r,a=r.chunkQueue[0].timestamp)}if(!t)break;let r=t.chunkQueue.shift();this.writeBlock(t,r)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if("key"!==t.type||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let a=new i._c(t.data);a.skipBits(2);let r=a.readBits(1),s=(a.readBits(1)<<1)+r;if(3===s&&a.skipBits(1),a.readBits(1)||0!==a.readBits(1)||(a.skipBits(2),4817730!==a.readBits(24)))return;s>=2&&a.skipBits(1);let n={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];(0,i.Wo)(t.data,a.pos,a.pos+3,n)}createInternalChunk(e,t,a,r,i=null){return{data:e,type:r,timestamp:t,duration:a,additions:i}}writeBlock(e,t){this.segment||(this.createTracks(),this.createSegment());let a=Math.round(1e3*t.timestamp),r=this.trackDatas.every(a=>{if(e===a)return"key"===t.type;let r=a.chunkQueue[0];return r?"key"===r.type:a.track.source._closed}),s=!1;if(this.currentCluster){(0,i.vA)(null!==this.currentClusterStartMsTimestamp),(0,i.vA)(null!==this.currentClusterMaxMsTimestamp);let e=a-this.currentClusterStartMsTimestamp;s=r&&a>this.currentClusterMaxMsTimestamp&&e>=1e3*(this.format._options.minimumClusterDuration??1)||e>32767}else s=!0;s&&this.createNewCluster(a);let n=a-this.currentClusterStartMsTimestamp;if(n<-32768)return;let o=new Uint8Array(4),d=new DataView(o.buffer);d.setUint8(0,128|e.track.id),d.setInt16(1,n,!1);let c=Math.round(1e3*t.duration);if(0!==c||t.additions){let r={id:eW.Cl.BlockGroup,data:[{id:eW.Cl.Block,data:[o,t.data]},"delta"===t.type?{id:eW.Cl.ReferenceBlock,data:new eW.ys(e.lastWrittenMsTimestamp-a)}:null,t.additions?{id:eW.Cl.BlockAdditions,data:[{id:eW.Cl.BlockMore,data:[{id:eW.Cl.BlockAdditional,data:t.additions},{id:eW.Cl.BlockAddID,data:1}]}]}:null,c>0?{id:eW.Cl.BlockDuration,data:c}:null]};this.ebmlWriter.writeEBML(r)}else{d.setUint8(3,Number("key"===t.type)<<7);let e={id:eW.Cl.SimpleBlock,data:[o,t.data]};this.ebmlWriter.writeEBML(e)}this.duration=Math.max(this.duration,a+c),e.lastWrittenMsTimestamp=a,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:a}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,a)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:eW.Cl.Cluster,size:this.format._options.appendOnly?-1:5,data:[{id:eW.Cl.Timestamp,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if((0,i.vA)(this.currentCluster),!this.format._options.appendOnly){let e=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),t=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(e,5),this.writer.seek(t)}if(this.format._options.onCluster){(0,i.vA)(null!==this.currentClusterStartMsTimestamp);let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onCluster(e,t,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(let[e,{firstMsTimestamp:a}]of this.trackDatasInCurrentCluster)t.has(a)||t.set(a,[]),t.get(a).push(e);for(let[a,r]of[...t.entries()].sort((e,t)=>e[0]-t[0]))(0,i.vA)(this.cues),this.cues.data.push({id:eW.Cl.CuePoint,data:[{id:eW.Cl.CueTime,data:a},...r.map(t=>({id:eW.Cl.CueTrackPositions,data:[{id:eW.Cl.CueTrack,data:t.track.id},{id:eW.Cl.CueClusterPosition,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||(this.createTracks(),this.createSegment()),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),(0,i.vA)(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let e=this.writer.getPos(),t=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(t,6),this.segmentDuration.data=new eW.Z4(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset,this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(e)}e()}}a(411501),a(606649),a(917690),a(431121);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class eK{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>r.WN.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>r.PP.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>r.VW.includes(e))}_codecUnsupportedHint(e){return""}}class eq extends eK{constructor(e={}){if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(void 0!==e.fastStart&&![!1,"in-memory","fragmented"].includes(e.fastStart))throw TypeError('options.fastStart, when provided, must be false, "in-memory", or "fragmented".');if(void 0!==e.minimumFragmentDuration&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(void 0!==e.onFtyp&&"function"!=typeof e.onFtyp)throw TypeError("options.onFtyp, when provided, must be a function.");if(void 0!==e.onMoov&&"function"!=typeof e.onMoov)throw TypeError("options.onMoov, when provided, must be a function.");if(void 0!==e.onMdat&&"function"!=typeof e.onMdat)throw TypeError("options.onMdat, when provided, must be a function.");if(void 0!==e.onMoof&&"function"!=typeof e.onMoof)throw TypeError("options.onMoof, when provided, must be a function.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:0x100000000-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new eV(e,this)}}class eQ extends eq{get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...r.WN,...r.YB,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...r.VW]}_codecUnsupportedHint(e){return new ej().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}}class ej extends eq{get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...r.WN,...r.PP]}_codecUnsupportedHint(e){return new eQ().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}}class eZ extends eK{constructor(e={}){if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(void 0!==e.appendOnly&&"boolean"!=typeof e.appendOnly)throw TypeError("options.appendOnly, when provided, must be a boolean.");if(void 0!==e.minimumClusterDuration&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(void 0!==e.onEbmlHeader&&"function"!=typeof e.onEbmlHeader)throw TypeError("options.onEbmlHeader, when provided, must be a function.");if(void 0!==e.onSegmentHeader&&"function"!=typeof e.onSegmentHeader)throw TypeError("options.onHeader, when provided, must be a function.");if(void 0!==e.onCluster&&"function"!=typeof e.onCluster)throw TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new e$(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...r.WN,...r.YB,...r.Wq.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...r.VW]}get supportsVideoRotationMetadata(){return!1}}class eG extends eZ{getSupportedCodecs(){return[...r.WN.filter(e=>["vp8","vp9","av1"].includes(e)),...r.PP.filter(e=>["opus","vorbis"].includes(e)),...r.VW]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new eZ().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}}},319102:(e,t,a)=>{a.d(t,{k:()=>c});var r=a(31463),i=a(136691),s=a(818009),n=a(831786);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let o=["video","audio","subtitle"],d=e=>{if(!e||"object"!=typeof e)throw TypeError("metadata must be an object.");if(void 0!==e.languageCode&&!(0,r.Nu)(e.languageCode))throw TypeError("metadata.languageCode must be a three-letter, ISO 639-2/T language code.")};class c{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new r.aD,!e||"object"!=typeof e)throw TypeError("options must be an object.");if(!(e.format instanceof i.$y))throw TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof n.We))throw TypeError("options.target must be a Target.");if(e.target._output)throw Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof s.$b))throw TypeError("source must be a VideoSource.");if(d(t),void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw Error(`${this.format._name} does not support video rotation metadata.`);if(void 0!==t.frameRate&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof s.uC))throw TypeError("source must be an AudioSource.");d(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof s._8))throw TypeError("source must be a SubtitleSource.");d(t),this._addTrack("subtitle",e,t)}_addTrack(e,t,a){if("pending"!==this.state)throw Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw Error("Source is already used for a track.");let r=this.format.getSupportedTrackCounts(),i=this._tracks.reduce((t,a)=>t+(a.type===e?1:0),0),s=r[e].max;if(i===s)throw Error(0===s?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${s} ${e} track${1===s?"":"s"}.`);let n=r.total.max;if(this._tracks.length===n)throw Error(`${this.format._name} does not support more than ${n} tracks${1===n?"":"s"} in total.`);let o={id:this._tracks.length+1,output:this,type:e,source:t,metadata:a};if("video"===o.type){let e=this.format.getSupportedVideoCodecs();if(0===e.length)throw Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(o.source._codec));if(!e.includes(o.source._codec))throw Error(`Codec '${o.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(o.source._codec))}else if("audio"===o.type){let e=this.format.getSupportedAudioCodecs();if(0===e.length)throw Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(o.source._codec));if(!e.includes(o.source._codec))throw Error(`Codec '${o.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(o.source._codec))}else if("subtitle"===o.type){let e=this.format.getSupportedSubtitleCodecs();if(0===e.length)throw Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(o.source._codec));if(!e.includes(o.source._codec))throw Error(`Codec '${o.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(o.source._codec))}this._tracks.push(o),t._connectedTrack=o}async start(){let e=this.format.getSupportedTrackCounts();for(let t of o){let a=this._tracks.reduce((e,a)=>e+(a.type===t?1:0),0),r=e[t].min;if(a<r)throw Error(r===e[t].max?`${this.format._name} requires exactly ${r} ${t} track${1===r?"":"s"}.`:`${this.format._name} requires at least ${r} ${t} track${1===r?"":"s"}.`)}let t=e.total.min;if(this._tracks.length<t)throw Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${1===t?"":"s"}.`:`${this.format._name} requires at least ${t} track${1===t?"":"s"}.`);if("canceled"===this.state)throw Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let e=await this._mutex.acquire();await this._muxer.start();let t=this._tracks.map(e=>e.source._start());await Promise.all(t),e()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if("finalizing"===this.state||"finalized"===this.state){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if("pending"===this.state)throw Error("Cannot finalize before starting.");if("canceled"===this.state)throw Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}}},112863:(e,t,a)=>{a.d(t,{T:()=>i,Z:()=>s});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let i=new Uint8Array(0);class s{constructor(e,t,a,r,s=-1,n){if(this.data=e,this.type=t,this.timestamp=a,this.duration=r,this.sequenceNumber=s,e===i&&void 0===n)throw Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(void 0===n&&(n=e.byteLength),!(e instanceof Uint8Array))throw TypeError("data must be a Uint8Array.");if("key"!==t&&"delta"!==t)throw TypeError('type must be either "key" or "delta".');if(!Number.isFinite(a))throw TypeError("timestamp must be a number.");if(!Number.isFinite(r)||r<0)throw TypeError("duration must be a non-negative number.");if(!Number.isFinite(s))throw TypeError("sequenceNumber must be a number.");if(!Number.isInteger(n)||n<0)throw TypeError("byteLength must be a non-negative integer.");this.byteLength=n}get isMetadataOnly(){return this.data===i}get microsecondTimestamp(){return Math.trunc(r.MW*this.timestamp)}get microsecondDuration(){return Math.trunc(r.MW*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw TypeError("Metadata-only packets cannot be converted to a video chunk.");if("undefined"==typeof EncodedVideoChunk)throw Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw TypeError("Metadata-only packets cannot be converted to an audio chunk.");if("undefined"==typeof EncodedAudioChunk)throw Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(e){if(!(e instanceof EncodedVideoChunk||e instanceof EncodedAudioChunk))throw TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let t=new Uint8Array(e.byteLength);return e.copyTo(t),new s(t,e.type,e.timestamp/1e6,(e.duration??0)/1e6)}clone(e){if(void 0!==e&&("object"!=typeof e||null===e))throw TypeError("options, when provided, must be an object.");if(e?.timestamp!==void 0&&!Number.isFinite(e.timestamp))throw TypeError("options.timestamp, when provided, must be a number.");if(e?.duration!==void 0&&!Number.isFinite(e.duration))throw TypeError("options.duration, when provided, must be a number.");return new s(this.data,this.type,e?.timestamp??this.timestamp,e?.duration??this.duration,this.sequenceNumber,this.byteLength)}}},288619:(e,t,a)=>{a.d(t,{aw:()=>n,qS:()=>i,vX:()=>r,xq:()=>s});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=e=>{let t=e,a=4096,r=0,i=12,s=0;for(t<0&&(t=-t,r=128),(t+=33)>8191&&(t=8191);(t&a)!==a&&i>=5;)a>>=1,i--;return s=t>>i-4&15,255&~(r|i-5<<4|s)},i=e=>{let t=0,a=0,r=~e;128&r&&(r&=-129,t=-1);let i=(1<<(a=((240&r)>>4)+5)|(15&r)<<a-4|1<<a-5)-33;return 0===t?i:-i},s=e=>{let t=2048,a=0,r=11,i=0,s=e;for(s<0&&(s=-s,a=128),s>4095&&(s=4095);(s&t)!==t&&r>=5;)t>>=1,r--;return i=s>>(4===r?1:r-4)&15,(a|r-4<<4|i)^85},n=e=>{let t=0,a=0,r=85^e;128&r&&(r&=-129,t=-1);let i=0;return i=4!=(a=((240&r)>>4)+4)?1<<a|(15&r)<<a-4|1<<a-5:r<<1|1,0===t?i:-i}},877640:(e,t,a)=>{a.d(t,{m:()=>i});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{constructor(e,t=1/0){this.source=e,this.maxStorableBytes=t,this.loadedSegments=[],this.loadingSegments=[],this.sourceSizePromise=null,this.nextAge=0,this.totalStoredBytes=0}async loadRange(e,t){if(e>=(t=Math.min(t,await this.source.getSize())))return;let a=this.loadingSegments.find(a=>a.start<=e&&a.end>=t);if(a){await a.promise;return}let i=(0,r.eE)(this.loadedSegments,e,e=>e.start);if(-1!==i)for(let a=i;a<this.loadedSegments.length;a++){let r=this.loadedSegments[a];if(r.start>e)break;if(r.end>=t)return}this.source.onread?.(e,t);let s=this.source._read(e,t),n={start:e,end:t,promise:s};this.loadingSegments.push(n);let o=await s;(0,r.Ai)(this.loadingSegments,n),this.insertIntoLoadedSegments(e,o)}rangeIsLoaded(e,t){if(t<=e)return!0;let a=(0,r.eE)(this.loadedSegments,e,e=>e.start);if(-1===a)return!1;for(let r=a;r<this.loadedSegments.length;r++){let a=this.loadedSegments[r];if(a.start>e)break;if(a.end>=t)return!0}return!1}insertIntoLoadedSegments(e,t){let a={start:e,end:e+t.byteLength,bytes:t,view:new DataView(t.buffer),age:this.nextAge++},i=(0,r.eE)(this.loadedSegments,e,e=>e.start);(-1===i||this.loadedSegments[i].start<a.start)&&i++,this.loadedSegments.splice(i,0,a),this.totalStoredBytes+=t.byteLength;for(let e=i+1;e<this.loadedSegments.length;e++){let t=this.loadedSegments[e];if(t.start>=a.end)break;a.start<=t.start&&t.end<=a.end&&(this.loadedSegments.splice(e,1),e--)}for(;this.totalStoredBytes>this.maxStorableBytes&&this.loadedSegments.length>1;){let e=null,t=-1;for(let a=0;a<this.loadedSegments.length;a++){let r=this.loadedSegments[a];(!e||r.age<e.age)&&(e=r,t=a)}(0,r.vA)(e),this.totalStoredBytes-=e.bytes.byteLength,this.loadedSegments.splice(t,1)}}getViewAndOffset(e,t){let a=(0,r.eE)(this.loadedSegments,e,e=>e.start),i=null;if(-1!==a)for(let r=a;r<this.loadedSegments.length;r++){let a=this.loadedSegments[r];if(a.start>e)break;if(t<=a.end){i=a;break}}if(!i)throw Error(`No segment loaded for range [${e}, ${t}).`);return i.age=this.nextAge++,{view:i.view,offset:i.bytes.byteOffset+e-i.start}}forgetRange(e,t){if(t<=e)return;let a=(0,r.eE)(this.loadedSegments,e,e=>e.start);if(-1===a)return;let i=this.loadedSegments[a];i.start===e&&i.end===t&&(this.loadedSegments.splice(a,1),this.totalStoredBytes-=i.bytes.byteLength)}}},702517:(e,t,a)=>{a.d(t,{B:()=>o,U:()=>i});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{get displayWidth(){return this.rotation%180==0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180==0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(r.MW*this.timestamp)}get microsecondDuration(){return Math.trunc(r.MW*this.duration)}constructor(e,t){if(this._closed=!1,e instanceof ArrayBuffer||ArrayBuffer.isView(e)){if(!t||"object"!=typeof t)throw TypeError("init must be an object.");if(!("format"in t)||"string"!=typeof t.format)throw TypeError("init.format must be a string.");if(!Number.isInteger(t.codedWidth)||t.codedWidth<=0)throw TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(t.codedHeight)||t.codedHeight<=0)throw TypeError("init.codedHeight must be a positive integer.");if(void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw TypeError("init.timestamp must be a number.");if(void 0!==t.duration&&(!Number.isFinite(t.duration)||t.duration<0))throw TypeError("init.duration, when provided, must be a non-negative number.");this._data=(0,r.Fo)(e).slice(),this.format=t.format,this.codedWidth=t.codedWidth,this.codedHeight=t.codedHeight,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace(t.colorSpace)}else if("undefined"!=typeof VideoFrame&&e instanceof VideoFrame){if(t?.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(t?.timestamp!==void 0&&!Number.isFinite(t?.timestamp))throw TypeError("init.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&(!Number.isFinite(t.duration)||t.duration<0))throw TypeError("init.duration, when provided, must be a non-negative number.");this._data=e,this.format=e.format,this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight,this.rotation=t?.rotation??0,this.timestamp=t?.timestamp??e.timestamp/1e6,this.duration=t?.duration??(e.duration??0)/1e6,this.colorSpace=e.colorSpace}else if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof SVGImageElement&&e instanceof SVGImageElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){if(!t||"object"!=typeof t)throw TypeError("init must be an object.");if(void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(t.timestamp))throw TypeError("init.timestamp must be a number.");if(void 0!==t.duration&&(!Number.isFinite(t.duration)||t.duration<0))throw TypeError("init.duration, when provided, must be a non-negative number.");if("undefined"!=typeof VideoFrame)return new i(new VideoFrame(e,{timestamp:Math.trunc(t.timestamp*r.MW),duration:Math.trunc((t.duration??0)*r.MW)}),t);let a=0,s=0;if("naturalWidth"in e?(a=e.naturalWidth,s=e.naturalHeight):"videoWidth"in e?(a=e.videoWidth,s=e.videoHeight):"width"in e&&(a=Number(e.width),s=Number(e.height)),!a||!s)throw TypeError("Could not determine dimensions.");let n=new OffscreenCanvas(a,s),o=n.getContext("2d",{alpha:!1,willReadFrequently:!0});(0,r.vA)(o),o.drawImage(e,0,0),this._data=n,this.format="RGBX",this.codedWidth=a,this.codedHeight=s,this.rotation=t.rotation??0,this.timestamp=t.timestamp,this.duration=t.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}clone(){if(this._closed)throw Error("VideoSample is closed.");return((0,r.vA)(null!==this._data),s(this._data))?new i(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new i(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new i(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(s(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw Error("VideoSample is closed.");return((0,r.vA)(null!==this._data),s(this._data))?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(e){if(!(0,r.SM)(e))throw TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw Error("VideoSample is closed.");if((0,r.vA)(null!==this._data),s(this._data))await this._data.copyTo(e);else if(this._data instanceof Uint8Array)(0,r.Fo)(e).set(this._data);else{let t=this._data.getContext("2d",{alpha:!1});(0,r.vA)(t);let a=t.getImageData(0,0,this.codedWidth,this.codedHeight);(0,r.Fo)(e).set(a.data)}}toVideoFrame(){if(this._closed)throw Error("VideoSample is closed.");return((0,r.vA)(null!==this._data),s(this._data))?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}draw(e,t,a,r,i,s,n,o,d){let c=0,l=0,u=this.displayWidth,h=this.displayHeight,m=0,f=0,p=this.displayWidth,g=this.displayHeight;if(void 0!==s?(c=t,l=a,u=r,h=i,m=s,f=n,void 0!==o?(p=o,g=d):(p=u,g=h)):(m=t,f=a,void 0!==r&&(p=r,g=i)),!("undefined"!=typeof CanvasRenderingContext2D&&e instanceof CanvasRenderingContext2D||"undefined"!=typeof OffscreenCanvasRenderingContext2D&&e instanceof OffscreenCanvasRenderingContext2D))throw TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(c))throw TypeError("sx must be a number.");if(!Number.isFinite(l))throw TypeError("sy must be a number.");if(!Number.isFinite(u)||u<0)throw TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(h)||h<0)throw TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(m))throw TypeError("dx must be a number.");if(!Number.isFinite(f))throw TypeError("dy must be a number.");if(!Number.isFinite(p)||p<0)throw TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(g)||g<0)throw TypeError("dHeight must be a non-negative number.");if(this._closed)throw Error("VideoSample is closed.");90===this.rotation?[c,l,u,h]=[l,this.codedHeight-c-u,h,u]:180===this.rotation?[c,l]=[this.codedWidth-c-u,this.codedHeight-l-h]:270===this.rotation&&([c,l,u,h]=[this.codedWidth-l-h,c,h,u]);let k=this.toCanvasImageSource();e.save();let b=m+p/2,w=f+g/2;e.translate(b,w),e.rotate(this.rotation*Math.PI/180);let T=this.rotation%180==0?1:p/g;e.scale(1/T,T),e.drawImage(k,c,l,u,h,-p/2,-g/2,p,g),e.restore()}toCanvasImageSource(){if(this._closed)throw Error("VideoSample is closed.");if((0,r.vA)(null!==this._data),!(this._data instanceof Uint8Array))return this._data;{let e=this.toVideoFrame();return queueMicrotask(()=>e.close()),e}}setRotation(e){if(![0,90,180,270].includes(e))throw TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=e}setTimestamp(e){if(!Number.isFinite(e))throw TypeError("newTimestamp must be a number.");this.timestamp=e}setDuration(e){if(!Number.isFinite(e)||e<0)throw TypeError("newDuration must be a non-negative number.");this.duration=e}}let s=e=>"undefined"!=typeof VideoFrame&&e instanceof VideoFrame,n=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]);class o{get microsecondTimestamp(){return Math.trunc(r.MW*this.timestamp)}get microsecondDuration(){return Math.trunc(r.MW*this.duration)}constructor(e){if(this._closed=!1,h(e)){if(null===e.format)throw TypeError("AudioData with null format is not supported.");this._data=e,this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=e.numberOfFrames,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp/1e6,this.duration=e.numberOfFrames/e.sampleRate}else{let t;if(!e||"object"!=typeof e)throw TypeError("Invalid AudioDataInit: must be an object.");if(!n.has(e.format))throw TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(e.sampleRate)||e.sampleRate<=0)throw TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(e.numberOfChannels)||0===e.numberOfChannels)throw TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(e?.timestamp))throw TypeError("init.timestamp must be a number.");let a=e.data.byteLength/(d(e.format)*e.numberOfChannels);if(!Number.isInteger(a))throw TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");if(this.format=e.format,this.sampleRate=e.sampleRate,this.numberOfFrames=a,this.numberOfChannels=e.numberOfChannels,this.timestamp=e.timestamp,this.duration=a/e.sampleRate,e.data instanceof ArrayBuffer)t=new Uint8Array(e.data);else if(ArrayBuffer.isView(e.data))t=new Uint8Array(e.data.buffer,e.data.byteOffset,e.data.byteLength);else throw TypeError("Invalid AudioDataInit: data is not a BufferSource.");let r=this.numberOfFrames*this.numberOfChannels*d(this.format);if(t.byteLength<r)throw TypeError("Invalid AudioDataInit: insufficient data size.");this._data=t}}allocationSize(e){if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(!Number.isInteger(e.planeIndex)||e.planeIndex<0)throw TypeError("planeIndex must be a non-negative integer.");if(void 0!==e.format&&!n.has(e.format))throw TypeError("Invalid format.");if(void 0!==e.frameOffset&&(!Number.isInteger(e.frameOffset)||e.frameOffset<0))throw TypeError("frameOffset must be a non-negative integer.");if(void 0!==e.frameCount&&(!Number.isInteger(e.frameCount)||e.frameCount<0))throw TypeError("frameCount must be a non-negative integer.");if(this._closed)throw Error("AudioSample is closed.");let t=e.format??this.format,a=e.frameOffset??0;if(a>=this.numberOfFrames)throw RangeError("frameOffset out of range");let r=void 0!==e.frameCount?e.frameCount:this.numberOfFrames-a;if(r>this.numberOfFrames-a)throw RangeError("frameCount out of range");let i=d(t),s=c(t);if(s&&e.planeIndex>=this.numberOfChannels||!s&&0!==e.planeIndex)throw RangeError("planeIndex out of range");return(s?r:r*this.numberOfChannels)*i}copyTo(e,t){if(!(0,r.SM)(e))throw TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!t||"object"!=typeof t)throw TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw TypeError("planeIndex must be a non-negative integer.");if(void 0!==t.format&&!n.has(t.format))throw TypeError("Invalid format.");if(void 0!==t.frameOffset&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw TypeError("frameOffset must be a non-negative integer.");if(void 0!==t.frameCount&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw TypeError("frameCount must be a non-negative integer.");if(this._closed)throw Error("AudioSample is closed.");let{planeIndex:a,format:i,frameCount:s,frameOffset:o}=t,m=i??this.format;if(!m)throw Error("Destination format not determined");let f=this.numberOfFrames,p=this.numberOfChannels,g=o??0;if(g>=f)throw RangeError("frameOffset out of range");let k=void 0!==s?s:f-g;if(k>f-g)throw RangeError("frameCount out of range");let b=d(m),w=c(m);if(w&&a>=p||!w&&0!==a)throw RangeError("planeIndex out of range");let T=w?k:k*p;if(e.byteLength<T*b)throw RangeError("Destination buffer is too small");let y=(0,r.Zc)(e),S=u(m);if(h(this._data)){if(w){if("f32-planar"===m)this._data.copyTo(e,{planeIndex:a,frameOffset:g,frameCount:k,format:"f32-planar"});else{let e=new ArrayBuffer(4*k),t=new Float32Array(e);this._data.copyTo(t,{planeIndex:a,frameOffset:g,frameCount:k,format:"f32-planar"});let r=new DataView(e);for(let e=0;e<k;e++)S(y,e*b,r.getFloat32(4*e,!0))}}else{let e=new Float32Array(k);for(let t=0;t<p;t++){this._data.copyTo(e,{planeIndex:t,frameOffset:g,frameCount:k,format:"f32-planar"});for(let a=0;a<k;a++)S(y,(a*p+t)*b,e[a])}}}else{let e=this._data,t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=this.format,i=l(r),s=d(r),n=c(r);for(let e=0;e<k;e++)if(w)S(y,e*b,i(t,n?(a*f+(e+g))*s:((e+g)*p+a)*s));else for(let a=0;a<p;a++)S(y,(e*p+a)*b,i(t,n?(a*f+(e+g))*s:((e+g)*p+a)*s))}}clone(){if(this._closed)throw Error("AudioSample is closed.");if(!h(this._data))return new o({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data});{let e=new o(this._data.clone());return e.setTimestamp(this.timestamp),e}}close(){this._closed||(h(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw Error("AudioSample is closed.");if(!h(this._data))return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data});if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(c(this.format)){let e=this.allocationSize({planeIndex:0,format:this.format}),t=new ArrayBuffer(e*this.numberOfChannels);for(let a=0;a<this.numberOfChannels;a++)this.copyTo(new Uint8Array(t,a*e,e),{planeIndex:a,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}{let e=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(e,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:e})}}toAudioBuffer(){if(this._closed)throw Error("AudioSample is closed.");let e=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),t=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let a=0;a<this.numberOfChannels;a++)this.copyTo(t,{planeIndex:a,format:"f32-planar"}),e.copyToChannel(t,a);return e}setTimestamp(e){if(!Number.isFinite(e))throw TypeError("newTimestamp must be a number.");this.timestamp=e}static fromAudioBuffer(e,t){if(!(e instanceof AudioBuffer))throw TypeError("audioBuffer must be an AudioBuffer.");let a=e.numberOfChannels,r=e.sampleRate,i=e.length,s=Math.floor(0x4000000/a),n=0,d=i,c=[];for(;d>0;){let i=Math.min(s,d),l=new Float32Array(a*i);for(let t=0;t<a;t++)e.copyFromChannel(l.subarray(t*i,t*i+i),t,n);let u=new o({format:"f32-planar",sampleRate:r,numberOfFrames:i,numberOfChannels:a,timestamp:t+n/r,data:l});c.push(u),n+=i,d-=i}return c}}let d=e=>{switch(e){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":case"f32":case"f32-planar":return 4;default:throw Error("Unknown AudioSampleFormat")}},c=e=>{switch(e){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},l=e=>{switch(e){case"u8":case"u8-planar":return(e,t)=>(e.getUint8(t)-128)/128;case"s16":case"s16-planar":return(e,t)=>e.getInt16(t,!0)/32768;case"s32":case"s32-planar":return(e,t)=>e.getInt32(t,!0)/0x80000000;case"f32":case"f32-planar":return(e,t)=>e.getFloat32(t,!0)}},u=e=>{switch(e){case"u8":case"u8-planar":return(e,t,a)=>e.setUint8(t,(0,r.qE)((a+1)*127.5,0,255));case"s16":case"s16-planar":return(e,t,a)=>e.setInt16(t,(0,r.qE)(Math.round(32767*a),-32768,32767),!0);case"s32":case"s32-planar":return(e,t,a)=>e.setInt32(t,(0,r.qE)(Math.round(0x7fffffff*a),-0x80000000,0x7fffffff),!0);case"f32":case"f32-planar":return(e,t,a)=>e.setFloat32(t,a,!0)}},h=e=>"undefined"!=typeof AudioData&&e instanceof AudioData},559222:(e,t,a)=>{a.d(t,{Ts:()=>s,kL:()=>i});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{constructor(){this._sizePromise=null,this.onread=null}getSize(){return this._sizePromise??=this._retrieveSize()}}class s extends i{constructor(e,t={}){if("string"!=typeof e&&!(e instanceof URL))throw TypeError("url must be a string or URL.");if(!t||"object"!=typeof t)throw TypeError("options must be an object.");if(void 0!==t.requestInit&&(!t.requestInit||"object"!=typeof t.requestInit))throw TypeError("options.requestInit, when provided, must be an object.");if(void 0!==t.getRetryDelay&&"function"!=typeof t.getRetryDelay)throw TypeError("options.getRetryDelay, when provided, must be a function.");super(),this._fullData=null,this._nextUrlVersion=null,this._url=e instanceof URL?e:new URL(e),this._options=t}async _makeRequest(e){let t={};e&&(t.Range=`bytes=${e.start}-${e.end-1}`),null!==this._nextUrlVersion&&(this._url.searchParams.set("mediabunny_version",this._nextUrlVersion.toString()),this._nextUrlVersion++);let a=await (0,r.G8)(this._url,(0,r.KA)(this._options.requestInit??{},{method:"GET",headers:t}),this._options.getRetryDelay??(()=>null));if(!a.ok)throw Error(`Error fetching ${this._url}: ${a.status} ${a.statusText}`);let i=await a.arrayBuffer();return 206===a.status&&e&&i.byteLength!==e.end-e.start&&null===this._nextUrlVersion?(this._nextUrlVersion=1,this._makeRequest(e)):(200===a.status&&(this._fullData=i),{response:i,statusCode:a.status})}async _read(e,t){if(this._fullData)return new Uint8Array(this._fullData,e,t-e);let{response:a,statusCode:r}=await this._makeRequest({start:e,end:t});return 200===r?new Uint8Array(a).subarray(e,t):new Uint8Array(a)}async _retrieveSize(){if(this._fullData)return this._fullData.byteLength;try{let e=await (0,r.G8)(this._url,(0,r.KA)(this._options.requestInit??{},{method:"HEAD"}),this._options.getRetryDelay??(()=>null));if(e.ok){let t=e.headers.get("Content-Length");if(t)return parseInt(t)}}catch{}let e=await (0,r.G8)(this._url,(0,r.KA)(this._options.requestInit??{},{method:"GET",headers:{Range:"bytes=0-0"}}),this._options.getRetryDelay??(()=>null));if(206===e.status){let t=e.headers.get("Content-Range");if(t){let e=t.match(/bytes \d+-\d+\/(\d+)/);if(e&&e[1])return parseInt(e[1])}}else if(200===e.status)return this._fullData=await e.arrayBuffer(),this._fullData.byteLength;let{response:t}=await this._makeRequest();return t.byteLength}}},894894:(e,t,a)=>{a.d(t,{Fp:()=>s,SH:()=>n,ce:()=>c,cj:()=>d});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */let r=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,i=/^WEBVTT(.|\n)*?\n{2}/,s=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g;class n{constructor(e){this.preambleText=null,this.preambleEmitted=!1,this.options=e}parse(e){let t;if(e=e.replaceAll("\r\n","\n").replaceAll("\r","\n"),r.lastIndex=0,!this.preambleText){if(!i.test(e))throw Error("WebVTT preamble incorrect.");t=r.exec(e);let a=e.slice(0,t?.index??e.length).trimEnd();if(!a)throw Error("No WebVTT preamble provided.");this.preambleText=a,t&&(e=e.slice(t.index),r.lastIndex=0)}for(;t=r.exec(e);){let a=e.slice(0,t.index),i=t[1],s=t.index+t[0].length,n=e.indexOf("\n",s)+1,o=e.slice(s,n).trim(),c=e.indexOf("\n\n",s);-1===c&&(c=e.length);let l=d(t[2]),u=d(t[3])-l,h=e.slice(n,c).trim();e=e.slice(c).trimStart(),r.lastIndex=0;let m={timestamp:l/1e3,duration:u/1e3,text:h,identifier:i,settings:o,notes:a},f={};this.preambleEmitted||(f.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(m,f)}}}let o=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,d=e=>{let t=o.exec(e);if(!t)throw Error("Expected match.");return 36e5*Number(t[1]||"0")+6e4*Number(t[2])+1e3*Number(t[3])+Number(t[4])},c=e=>{let t=Math.floor(e/36e5),a=Math.floor(e%36e5/6e4),r=Math.floor(e%6e4/1e3);return t.toString().padStart(2,"0")+":"+a.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+"."+(e%1e3).toString().padStart(3,"0")}},831786:(e,t,a)=>{a.d(t,{Sn:()=>s,We:()=>i});var r=a(185796);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{constructor(){this._output=null}}class s extends i{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new r.p2(this)}}},938006:(e,t,a)=>{a.d(t,{H:()=>r});/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class r{constructor(e){this.reader=e,this.pos=0,this.littleEndian=!0}readBytes(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);return this.pos+=e,new Uint8Array(t.buffer,a,e)}readU16(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+2);return this.pos+=2,e.getUint16(t,this.littleEndian)}readU32(){let{view:e,offset:t}=this.reader.getViewAndOffset(this.pos,this.pos+4);return this.pos+=4,e.getUint32(t,this.littleEndian)}readU64(){let e,t;return this.littleEndian?(e=this.readU32(),t=this.readU32()):(t=this.readU32(),e=this.readU32()),0x100000000*t+e}readAscii(e){let{view:t,offset:a}=this.reader.getViewAndOffset(this.pos,this.pos+e);this.pos+=e;let r="";for(let i=0;i<e;i++)r+=String.fromCharCode(t.getUint8(a+i));return r}}},431121:(e,t,a)=>{a.d(t,{D:()=>r,E:()=>l});var r,i=a(730875),s=a(368501),n=a(31463),o=a(112863),d=a(877640),c=a(938006);!function(e){e[e.PCM=1]="PCM",e[e.IEEE_FLOAT=3]="IEEE_FLOAT",e[e.ALAW=6]="ALAW",e[e.MULAW=7]="MULAW",e[e.EXTENSIBLE=65534]="EXTENSIBLE"}(r||(r={}));class l extends i.B{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.metadataReader=new c.H(e._mainReader),this.chunkReader=new c.H(new d.m(e.source,0x4000000))}async readMetadata(){return this.metadataPromise??=(async()=>{let e=await this.metadataReader.reader.source.getSize(),t=this.metadataReader.readAscii(4);this.metadataReader.littleEndian="RIFX"!==t;let a="RF64"===t,r=this.metadataReader.readU32(),i=a?e:Math.min(r+8,e);if("WAVE"!==this.metadataReader.readAscii(4))throw Error("Invalid WAVE file - wrong format");this.metadataReader.pos=12;let n=0,o=null;for(;this.metadataReader.pos<i;){await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+8);let t=this.metadataReader.readAscii(4),r=this.metadataReader.readU32(),s=this.metadataReader.pos;if(a&&0===n&&"ds64"!==t)throw Error('Invalid RF64 file: First chunk must be "ds64".');if("fmt "===t)await this.parseFmtChunk(r);else if("data"===t)o??=r,this.dataStart=this.metadataReader.pos,this.dataSize=Math.min(o,i-this.dataStart);else if("ds64"===t){let t=this.metadataReader.readU64();o=this.metadataReader.readU64(),i=Math.min(t+8,e)}this.metadataReader.pos=s+r+(1&r),n++}if(!this.audioInfo)throw Error('Invalid WAVE file - missing "fmt " chunk');if(-1===this.dataStart)throw Error('Invalid WAVE file - missing "data" chunk');let d=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/d)*d,this.tracks.push(new s.Yi(new u(this)))})()}async parseFmtChunk(e){let t;await this.metadataReader.reader.loadRange(this.metadataReader.pos,this.metadataReader.pos+e);let a=this.metadataReader.readU16(),i=this.metadataReader.readU16(),s=this.metadataReader.readU32();this.metadataReader.pos+=4;let n=this.metadataReader.readU16();if(t=14===e?8:this.metadataReader.readU16(),e>=18&&357!==a&&Math.min(e-18,this.metadataReader.readU16())>=22&&a===r.EXTENSIBLE){this.metadataReader.pos+=6;let e=this.metadataReader.readBytes(16);a=e[0]|e[1]<<8}(a===r.MULAW||a===r.ALAW)&&(t=8),this.audioInfo={format:a,numberOfChannels:i,sampleRate:s,sampleSizeInBytes:Math.ceil(t/8),blockSizeInBytes:n}}getCodec(){if((0,n.vA)(this.audioInfo),this.audioInfo.format===r.MULAW)return"ulaw";if(this.audioInfo.format===r.ALAW)return"alaw";if(this.audioInfo.format===r.PCM){if(1===this.audioInfo.sampleSizeInBytes)return"pcm-u8";if(2===this.audioInfo.sampleSizeInBytes)return"pcm-s16";if(3===this.audioInfo.sampleSizeInBytes)return"pcm-s24";if(4===this.audioInfo.sampleSizeInBytes)return"pcm-s32"}return this.audioInfo.format===r.IEEE_FLOAT&&4===this.audioInfo.sampleSizeInBytes?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){return await this.readMetadata(),(0,n.vA)(this.audioInfo),this.dataSize/this.audioInfo.blockSizeInBytes/this.audioInfo.sampleRate}async getTracks(){return await this.readMetadata(),this.tracks}}class u{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?((0,n.vA)(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}computeDuration(){return this.demuxer.computeDuration()}getNumberOfChannels(){return(0,n.vA)(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return(0,n.vA)(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return(0,n.vA)(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getLanguageCode(){return n.IR}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){let a;(0,n.vA)(this.demuxer.audioInfo);let r=2048*e*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(2048*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(t.metadataOnly)a=o.T;else{let e=2048*this.demuxer.audioInfo.blockSizeInBytes,t=Math.ceil(524288/e)*e,s=Math.floor(r/t)*t;await this.demuxer.chunkReader.reader.loadRange(this.demuxer.dataStart+s,this.demuxer.dataStart+(s+t)),this.demuxer.chunkReader.pos=this.demuxer.dataStart+r,a=this.demuxer.chunkReader.readBytes(i)}let s=2048*e/this.demuxer.audioInfo.sampleRate,d=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return new o.Z(a,"key",s,d,e,i)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}getPacket(e,t){(0,n.vA)(this.demuxer.audioInfo);let a=Math.floor(e*this.demuxer.audioInfo.sampleRate/2048);return this.getPacketAtIndex(a,t)}getNextPacket(e,t){(0,n.vA)(this.demuxer.audioInfo);let a=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/2048);return this.getPacketAtIndex(a+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}}},185796:(e,t,a)=>{a.d(t,{p2:()=>s,xz:()=>n});var r=a(31463);/*!
 * Copyright (c) 2025-present, Vanilagy and contributors
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */class i{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let a=t+e.byteLength-this.trackedStart,r=this.trackedWrites.byteLength;for(;r<a;)r*=2;if(r!==this.trackedWrites.byteLength){let e=new Uint8Array(r);e.set(this.trackedWrites,0),this.trackedWrites=e}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(1024),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw Error("Internal error: Can't get tracked writes since nothing was tracked.");let e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}}class s extends i{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(65536,{maxByteLength:0x100000000})}catch{this.buffer=new ArrayBuffer(65536),this.supportsResize=!1}else this.buffer=new ArrayBuffer(65536);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>0x100000000)throw Error("ArrayBuffer exceeded maximum size of 4294967296 bytes. Please consider using another target.");if(this.supportsResize)this.buffer.resize(t);else{let e=new ArrayBuffer(t),a=new Uint8Array(e);a.set(this.bytes,0),this.buffer=e,this.bytes=a}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}}class n extends i{constructor(e){super(),this.pos=0,this.sections=[],this.lastWriteEnd=0,this.lastFlushEnd=0,this.writer=null,this.chunks=[],this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??0x1000000}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let e=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(e))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let e=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(e))}if((0,r.vA)(this.writer),0===this.sections.length)return;let e=[],t=[...this.sections].sort((e,t)=>e.start-t.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let a=1;a<t.length;a++){let r=e[e.length-1],i=t[a];i.start<=r.start+r.size?r.size=Math.max(r.size,i.start+i.data.byteLength-r.start):e.push({start:i.start,size:i.data.byteLength})}for(let t of e){for(let e of(t.data=new Uint8Array(t.size),this.sections))t.start<=e.start&&e.start<t.start+t.size&&t.data.set(e.data,e.start-t.start);if(null!==this.writer.desiredSize&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(t.data,t.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&t.start!==this.lastFlushEnd)throw Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:t.data,position:t.start}),this.lastFlushEnd=t.start+t.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,t){let a=this.chunks.findIndex(e=>e.start<=t&&t<e.start+this.chunkSize);-1===a&&(a=this.createChunk(t));let r=this.chunks[a],i=t-r.start,s=e.subarray(0,Math.min(this.chunkSize-i,e.byteLength));r.data.set(s,i);let n={start:i,end:i+s.byteLength};if(this.insertSectionIntoChunk(r,n),0===r.written[0].start&&r.written[0].end===this.chunkSize&&(r.shouldFlush=!0),this.chunks.length>2){for(let e=0;e<this.chunks.length-1;e++)this.chunks[e].shouldFlush=!0;this.tryToFlushChunks()}s.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(s.byteLength),t+s.byteLength)}insertSectionIntoChunk(e,t){let a=0,r=e.written.length-1,i=-1;for(;a<=r;){let s=Math.floor(a+(r-a+1)/2);e.written[s].start<=t.start?(a=s+1,i=s):r=s-1}for(e.written.splice(i+1,0,t),(-1===i||e.written[i].end<t.start)&&i++;i<e.written.length-1&&e.written[i].end>=e.written[i+1].start;)e.written[i].end=Math.max(e.written[i].end,e.written[i+1].end),e.written.splice(i+1,1)}createChunk(e){let t={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(t),this.chunks.sort((e,t)=>e.start-t.start),this.chunks.indexOf(t)}tryToFlushChunks(e=!1){(0,r.vA)(this.writer);for(let t=0;t<this.chunks.length;t++){let a=this.chunks[t];if(a.shouldFlush||e){for(let e of a.written){let t=a.start+e.start;if(this.ensureMonotonicity&&t!==this.lastFlushEnd)throw Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:a.data.subarray(e.start,e.end),position:t}),this.lastFlushEnd=a.start+e.end}this.chunks.splice(t--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),(0,r.vA)(this.writer),this.writer.close()}async close(){return this.writer?.close()}}}}]);

//# debugId=204856f0-462d-533c-9d0a-1a060e619c5d

//# sourceMappingURL=https://admin.figma.com/admin/webpack-artifacts/b23d64be9af31669f575ac5760df6258529a8903/vendor-db79bd7e9ff9026c.min.js.map